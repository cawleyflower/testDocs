<!DOCTYPE html><html>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Copy of Netfilter a C Ls | Cumulus Networks Documentation</title>

<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono:300,400,700" rel="stylesheet">
<link rel="stylesheet" href="/normalize.min.css">

<link rel="stylesheet" href="/book.min.50a619ce4c0e99594908d162684f42218608aa6fde2bd83cca5025d59ba535e3.css">

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">
<h2 class="book-brand">
  <a href="http://example.org/">Cumulus Networks Documentation</a>
</h2>



    


  
  
    
    
  
 
  <ul>
    
    <li><a href="/Cumulus-Linux/installation-management/">
    Installation Management</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/installation-management/Adding_and_Updating_Packages/">Adding and Updating Packages</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Installing_a_New_Cumulus_Linux_Image/">Installing a New Cumulus Linux Image</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Managing_Cumulus_Linux_Disk_Images/">Managing Cumulus Linux Disk Images</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Upgrading_Cumulus_Linux/">Upgrading Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Using_Snapshots/">Using Snapshots</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Zero_Touch_Provisioning_-_ZTP/">Zero Touch Provisioning Z T P</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer1-switch-ports/">
    Layer1 Switch Ports</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/802.1X_Interfaces/">802.1 X Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Buffer_and_Queue_Management/">Buffer and Queue Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Relays/">D H C P Relays</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Servers/">D H C P Servers</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Facebook_Voyager_Optical_Interfaces/">Facebook Voyager Optical Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Prescriptive_Topology_Manager_-_PTM/">Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/Interface_Configuration_and_Management/">Interface Configuration and Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/switch_port_attributes/Switch_Port_Attributes/">Switch Port Attributes</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer2/">
    Layer2</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Prescriptive_Topology_Manager_-_PTM/">Copy of Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Spanning_Tree_and_Rapid_Spanning_Tree/">Copy of Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Ethernet_Bridging_-_VLANs/">Ethernet Bridging v L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/IGMP_and_MLD_Snooping/">I G M P and M L D Snooping</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/LACP_Bypass/">L a C P Bypass</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Link_Layer_Discovery_Protocol/">Link Layer Discovery Protocol</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Multi-Chassis_Link_Aggregation_-_MLAG/">Multi Chassis Link Aggregation M L a G</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Spanning_Tree_and_Rapid_Spanning_Tree/">Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Virtual_Router_Redundancy_-_VRR/">Virtual Router Redundancy v R R</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/bonding_link_aggregation/Bonding_-_Link_Aggregation/">Bonding Link Aggregation</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/Traditional_Bridge_Mode/">Traditional Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN-aware_Bridge_Mode/">V L a N Aware Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN_Tagging/">V L a N Tagging</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/link_layer_discovery_protocol/voice_vlan/Voice_VLAN/">Voice v L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/virtual_router_redundancy/ifplugd/ifplugd/">Ifplugd</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer3/">
    Layer3</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer3/Address_Resolution_Protocol_-_ARP/">Address Resolution Protocol a R P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Bidirectional_Forwarding_Detection_-_BFD/">Bidirectional Forwarding Detection B F D</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Border_Gateway_Protocol_-_BGP/">Border Gateway Protocol B G P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Configuring_FRRouting/">Configuring F R Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Equal_Cost_Multipath_Load_Sharing_-_Hardware_ECMP/">Equal Cost Multipath Load Sharing Hardware E C M P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/FRRouting_Overview/">F R Routing Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/GRE_Tunneling/">G R E Tunneling</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Introduction_to_Routing_Protocols/">Introduction to Routing Protocols</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Management_VRF/">Management v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Network_Topology/">Network Topology</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_-_OSPF/">Open Shortest Path First O S P F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_v3_-_OSPFv3/">Open Shortest Path First V3 O S P Fv3</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Policy-based_Routing/">Policy Based Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Protocol_Independent_Multicast_-_PIM/">Protocol Independent Multicast P I M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Redistribute_Neighbor/">Redistribute Neighbor</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Routing/">Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Segment_Routing/">Segment Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Virtual_Routing_and_Forwarding_-_VRF/">Virtual Routing and Forwarding v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/configuring_frrouting/comparing_nclu_and_vtysh_commands/Comparing_NCLU_and_vtysh_Commands/">Comparing N C L U and Vtysh Commands</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/frrouting_overview/Upgrading_from_Quagga_to_FRRouting/">Upgrading From Quagga to F R Routing</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/monitoring-troubleshooting/">
    Monitoring Troubleshooting</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/ASIC_Monitoring/">A S I C Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/FRRouting_Log_Message_Reference/">F R Routing Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Best_Practices/">Monitoring Best Practices</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_System_Hardware/">Monitoring System Hardware</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Virtual_Device_Counters/">Monitoring Virtual Device Counters</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Network_Troubleshooting/">Network Troubleshooting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Resource_Diagnostics_Using_cl-resource-query/">Resource Diagnostics Using Cl Resource Query</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Simple_Network_Management_Protocol_SNMP_Monitoring/">Simple Network Management Protocol S N M P Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Single_User_Mode_-_Boot_Recovery/">Single User Mode Boot Recovery</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Troubleshooting_Network_Interfaces/">Troubleshooting Network Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Understanding_the_cl-support_Output_File/">Understanding the Cl Support Output File</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/monitoring_system_hardware/network_switch_port_led_and_stats_led/Network_Switch_Port_LED_and_Status_LED_Guidelines/">Network Switch Port L E D and Status L E D Guidelines</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/monitoring_system_statistics/Monitoring_System_Statistics_and_Network_Traffic_with_sFlow/">Monitoring System Statistics and Network Traffic With S Flow</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/using_nclu_to_troubleshoot/Using_NCLU_to_Troubleshoot_Your_Network_Configuration/">Using N C L U to Troubleshoot Your Network Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/simple_network_management/using_nutanix_prisim_as_monitoring_tool/Using_Nutanix_Prism_as_a_Monitoring_Tool/">Using Nutanix Prism as a Monitoring Tool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/switchd_Log_Message_Reference/">Switchd Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/troubleshooting_network_interfaces/monitoring_interfaces_and_transcievers_using_ethtool/Monitoring_Interfaces_and_Transceivers_Using_ethtool/">Monitoring Interfaces and Transceivers Using Ethtool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_log_files/Troubleshooting_Log_Files/">Troubleshooting Log Files</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_the_etc_directory/Troubleshooting_the_etc_Directory/">Troubleshooting the Etc Directory</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-solutions/">
    Network Solutions</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Anycast_Design_Guide/">Anycast Design Guide</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Hyperconverged_Solution_with_Nutanix/">Cumulus Hyperconverged Solution With Nutanix</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Networks_Services_Demos/">Cumulus Networks Services Demos</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Data_Center_Host_to_ToR_Architecture/">Data Center Host to to R Architecture</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Docker_on_Cumulus_Linux/">Docker on Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/OpenStack_Neutron_ML2_and_Cumulus_Linux/">Open Stack Neutron M L2 and Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/RDMA_over_Converged_Ethernet_-_RoCE/">R D M a Over Converged Ethernet Ro C E</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-visualization/">
    Network Visualization</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Eng_Update_of_VXLAN_Hyperloop/">Eng Update of v X L a N Hyperloop</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Ethernet_Virtual_Private_Network_-_EVPN/">Ethernet Virtual Private Network E v P N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Hybrid_Cloud_Connectivity_with_QinQ_and_VXLANs/">Hybrid Cloud Connectivity With Qin Q and v X L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/LNV_Full_Example/">L N v Full Example</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Lightweight_Network_Virtualization_Overview/">Lightweight Network Virtualization Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Static_VXLAN_Configurations/">Static v X L a N Configurations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Routing/">V X L a N Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Scale/">V X L a N Scale</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Tunnel_DSCP_Operations__DRAFT/">V X L a N Tunnel D S C P Operations — D R a F T</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Virtualization_Integrations/">Virtualization Integrations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_mac_bindings/Static_MAC_Bindings_with_VXLAN/">Static M a C Bindings With v X L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_vxlan_tunnels/Static_VXLAN_Tunnels/">Static v X L a N Tunnels</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_hardware_vteps_vmware_nsx-mh/Integrating_Hardware_VTEPs_with_VMware_NSX-MH/">Integrating Hardware v T E Ps With v Mware N S X M H</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_midonet_openstack/Integrating_Hardware_VTEPs_with_Midokura_MidoNet_and_OpenStack/">Integrating Hardware v T E Ps With Midokura Mido Net and Open Stack</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_vmware_nsx-v/Integrating_Hardware_VTEPs_with_VMware_NSX-V/">Integrating Hardware v T E Ps With v Mware N S X V</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/ovsdb_server_high_availability/OVSDB_Server_High_Availability/">O v S D B Server High Availability</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/system-config/">
    System Config</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/system-config/Authentication_Authorization_and_Accounting/">Authentication Authorization and Accounting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_a_Global_Proxy/">Configuring a Global Proxy</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_switchd/">Configuring Switchd</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Copy_of_Netfilter_-_ACLs/" class="active">Copy of Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/HTTP_API/">H T T P a P I</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Netfilter_-_ACLs/">Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Network_Command_Line_Utility_-_NCLU/">Network Command Line Utility N C L U</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Power_over_Ethernet_-_PoE/">Power Over Ethernet Po E</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Services_and_Daemons_in_Cumulus_Linux/">Services and Daemons in Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Setting_Date_and_Time/">Setting Date and Time</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/LDAP_Authentication_and_Authorization/">L D a P Authentication and Authorization</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/RADIUS_AAA/">R a D I U S a a A</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/SSH_for_Remote_Access/">S S H for Remote Access</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/TACACS_Plus/">T a C a C S Plus</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/User_Accounts/">User Accounts</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/Using_sudo_to_Delegate_Privileges/">Using Sudo to Delegate Privileges</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Default_Cumulus_Linux_ACL_Configuration/">Default Cumulus Linux a C L Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Filtering_Learned_MAC_Addresses/">Filtering Learned M a C Addresses</a>
    </li>
    
  </ul>

    </li>
    

    
    <li>
      <a href="/Cumulus-Linux/whats-new/">What&#39;s New</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/cumulus-linux-index/Cumulus_Linux_Index/">Cumulus Linux Index</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/quick-start/Quick_Start_Guide/">Quick Start Guide</a>
    </li>
    
  </ul>








</nav>

    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/svg/menu.svg" />
  </label>
  <strong>Copy of Netfilter a C Ls</strong>
</header>

      
<article class="markdown">

<h1 id="copy-of-netfilter-acls">Copy of Netfilter - ACLs</h1>

<p><a href="http://www.netfilter.org/">Netfilter</a> is the packet filtering framework
in Cumulus Linux as well as most other Linux distributions. There are a
number of tools available for configuring ACLs in Cumulus Linux,
including:</p>

<ul>
<li><code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code> are Linux userspace tools to
administer filtering rules for IPv4 packets, IPv6 packets and
Ethernet frames (layer 2 using MAC addresses) respectively. </li>
<li><a href="Network_Command_Line_Utility_-_NCLU">NCLU</a>, a Cumulus
Linux-specific userspace tool for configuring custom ACLs.</li>
<li><code>cl-acltool</code>, another Cumulus Linux-specific userspace tool to
administer filtering rules and for configuring the default ACLs.</li>
</ul>

<p>NCLU and <code>cl-acltool</code> operate on various configuration files, and use 
<code>iptables</code>,  <code>ip6tables</code> and  <code>ebtables</code> to install rules into the
kernel. In addition to programming rules in the kernel, NCLU
and <code>cl-acltool</code> program rules in hardware for interfaces involving
switch port interfaces,
which <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code> cannot do on their own. </p>

<p>In many instances, you can use NCLU to configure ACLs;
however, <code>cl-acltool</code> must be used in some cases. The examples below
show when to use which tool.</p>

<p>If you need help getting started setting up ACLs, run <code>net example acl</code>
to see a basic configuration:</p>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}Click to see
the example &hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net example acl 

Scenario
========
We would like to use access-lists on &#39;switch&#39; to
- Restrict inbound traffic on swp1 to traffic from 10.1.1.0/24 destined for 10.1.2.0/24
- Restrict outbound traffic on swp2 to http, https, or ssh


     *switch
        /\
  swp1 /  \ swp2
      /    \
     /      \
 host-11   host-12



switch net commands
====================

Create an ACL that accepts traffic from 10.1.1.0/24 destined for 10.1.2.0/24
and drops all other traffic

switch# net add acl ipv4 MYACL accept source-ip 10.1.1.0/24 dest-ip 10.1.2.0/24
switch# net add acl ipv4 MYACL drop source-ip any dest-ip any

Apply MYACL inbound on swp1

switch# net add interface swp1 acl ipv4 MYACL inbound

Create an ACL that accepts http, https, or ssh traffic and drops all
other traffic.

switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port any dest-ip any dest-port http
switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port http dest-ip any dest-port any
switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port any dest-ip any dest-port https
switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port https dest-ip any dest-port any
switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port any dest-ip any dest-port ssh
switch# net add acl ipv4 WEB_OR_SSH accept tcp source-ip any source-port ssh dest-ip any dest-port any
switch# net add acl ipv4 WEB_OR_SSH drop source-ip any dest-ip any

Apply WEB_OR_SSH outbound on swp2
switch# net add interface swp2 acl ipv4 WEB_OR_SSH outbound

commit the staged changes
switch# net commit

Verification
============
switch# net show configuration acl</code></pre></div>
<p> </p>

<h2 id="contents">Contents</h2>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}This topic
describes &hellip;</p>

<ul>
<li><a href="#CopyofNetfilter-ACLs-TrafficRulesInCumulusLinux">Traffic Rules In Cumulus
Linux</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-Chains">Chains</a></li>
<li><a href="#CopyofNetfilter-ACLs-Tables">Tables</a></li>
<li><a href="#CopyofNetfilter-ACLs-Rules">Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-HowRulesAreParsedandApplied">How Rules Are Parsed and
Applied</a></li>
<li><a href="#CopyofNetfilter-ACLs-RulePlacementinMemory">Rule Placement in
Memory</a></li>
<li><a href="#CopyofNetfilter-ACLs-nonatomicEnableNonatomicUpdates">Enable Nonatomic
Updates</a></li>
<li><a href="#CopyofNetfilter-ACLs-Useiptables/ip6tables/ebtablesDirectly">Use iptables/ip6tables/ebtables
Directly</a></li>
<li><a href="#CopyofNetfilter-ACLs-EstimatetheNumberofRules">Estimate the Number of
Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-MatchSVI/BridgedInterfacesinRules">Match SVI/Bridged Interfaces in
Rules</a></li>
</ul></li>
<li><a href="#CopyofNetfilter-ACLs-InstallandManageACLRuleswithNCLU">Install and Manage ACL Rules with
NCLU</a></li>
<li><a href="#CopyofNetfilter-ACLs-InstallandManageACLRuleswithcl-acltool">Install and Manage ACL Rules with
cl-acltool</a></li>
<li><a href="#CopyofNetfilter-ACLs-InstallPacketFiltering(ACL)Rules">Install Packet Filtering (ACL)
Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-SpecifythePolicyFilestoInstall">Specify the Policy Files to
Install</a></li>
<li><a href="#CopyofNetfilter-ACLs-HardwareLimitationsonNumberofRules">Hardware Limitations on Number of
Rules</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-BroadcomTomahawkLimits">Broadcom Tomahawk
Limits</a></li>
<li><a href="#CopyofNetfilter-ACLs-BroadcomTridentII+andTrident3Limits">Broadcom Trident II+ and Trident3
Limits</a></li>
<li><a href="#CopyofNetfilter-ACLs-BroadcomTridentIILimits">Broadcom Trident
II Limits</a></li>
<li><a href="#CopyofNetfilter-ACLs-BroadcomHelix4Limits">Broadcom
Helix4 Limits</a></li>
<li><a href="#CopyofNetfilter-ACLs-MellanoxSpectrumLimits">Mellanox Spectrum
Limits</a></li>
</ul></li>
<li><a href="#CopyofNetfilter-ACLs-supportedSupportedRuleTypes">Supported Rule
Types</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-iptables/ip6tablesRuleSupport">iptables/ip6tables Rule
Support</a></li>
<li><a href="#CopyofNetfilter-ACLs-ebtablesRuleSupport">ebtables Rule
Support</a></li>
<li><a href="#CopyofNetfilter-ACLs-OtherUnsupportedRules">Other Unsupported
Rules</a></li>
</ul></li>
<li><a href="#CopyofNetfilter-ACLs-CommonExamples">Common Examples</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-ControlPlaneandDataPlaneTraffic">Control Plane and Data Plane
Traffic</a></li>
<li><a href="#CopyofNetfilter-ACLs-SetDSCPonTransitTraffic">Set DSCP on Transit
Traffic</a></li>
<li><a href="#CopyofNetfilter-ACLs-VerifyDSCPValuesonTransitTraffic">Verify DSCP Values on Transit
Traffic</a></li>
<li><a href="#CopyofNetfilter-ACLs-CheckthePacketandByteCountersforACLRules">Check the Packet and Byte Counters for ACL
Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-filteringtcpFilterSpecificTCPFlags">Filter Specific TCP
Flags</a></li>
</ul></li>
<li><a href="#CopyofNetfilter-ACLs-ExampleScenario">Example Scenario</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-Switch1Configuration">Switch 1
Configuration</a></li>
<li><a href="#CopyofNetfilter-ACLs-Switch2Configuration">Switch 2
Configuration</a></li>
<li><a href="#CopyofNetfilter-ACLs-EgressRule">Egress Rule</a></li>
<li><a href="#CopyofNetfilter-ACLs-IngressRule">Ingress Rule</a></li>
<li><a href="#CopyofNetfilter-ACLs-InputRule">Input Rule</a></li>
<li><a href="#CopyofNetfilter-ACLs-OutputRule">Output Rule</a></li>
<li><a href="#CopyofNetfilter-ACLs-CombinedRules">Combined Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-Layer2-onlyRules/ebtables">Layer 2-only
Rules/ebtables</a></li>
</ul></li>
<li><a href="#CopyofNetfilter-ACLs-UsefulLinks">Useful Links</a></li>
<li><a href="#CopyofNetfilter-ACLs-CaveatsandErrata">Caveats and Errata</a>

<ul>
<li><a href="#CopyofNetfilter-ACLs-NotAllRulesSupported">Not All Rules
Supported</a></li>
<li><a href="#CopyofNetfilter-ACLs-ACLLogPolicerLimitsTraffic">ACL Log Policer Limits
Traffic</a></li>
<li><a href="#CopyofNetfilter-ACLs-BridgeTrafficLimitations">Bridge Traffic
Limitations</a></li>
<li><a href="#CopyofNetfilter-ACLs-LogActionsCannotBeForwarded">Log Actions Cannot Be
Forwarded</a></li>
<li><a href="#CopyofNetfilter-ACLs-BroadcomHardwareLimitations">Broadcom Hardware
Limitations</a></li>
<li><a href="#CopyofNetfilter-ACLs-TomahawkHardwareLimitations">Tomahawk Hardware
Limitations</a></li>
<li><a href="#CopyofNetfilter-ACLs-TridentII+andTrident3HardwareLimitations">Trident II+ and Trident3 Hardware
Limitations</a></li>
<li><a href="#CopyofNetfilter-ACLs-iptablesInteractionswithcl-acltool">iptables Interactions with
cl-acltool</a></li>
<li><a href="#CopyofNetfilter-ACLs-WheretoAssignRules">Where to Assign
Rules</a></li>
<li><a href="#CopyofNetfilter-ACLs-GenericErrorMessageDisplayedafterACLRuleInstallationFailure">Generic Error Message Displayed after ACL Rule Installation
Failure</a></li>
<li><a href="#CopyofNetfilter-ACLs-DellS3048-ONSupportsonly24KMACAddresses">Dell S3048-ON Supports only 24K MAC
Addresses</a></li>
</ul></li>
</ul>

<h2 id="traffic-rules-in-cumulus-linux">Traffic Rules In Cumulus Linux</h2>

<h3 id="chains">Chains</h3>

<p>Netfilter describes the mechanism for which packets are classified and
controlled in the Linux kernel. Cumulus Linux uses the Netfilter
framework to control the flow of traffic to, from and across the
switch. Netfilter does not require a separate software daemon to run
because it is part of the Linux kernel itself. Netfilter asserts
policies at layers 2, 3 and 4 of the <a href="https://en.wikipedia.org/wiki/OSI_model">OSI
model</a> by inspecting packet and
frame headers based on a list of rules. Rules are defined using syntax
provided by the <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code> userspace
applications.</p>

<p>The rules created by these programs inspect or operate on packets at
several points in the life of the packet through the system. These five
points are known as  *chains * and are shown here:</p>

<p><img src="attachments/8362584/8362583.png" alt="" />{height=&ldquo;250&rdquo;}</p>

<p>The chains and their uses are:</p>

<ul>
<li><strong>PREROUTING</strong>: Touches packets before they are routed</li>
<li><strong>INPUT:</strong> Touches packets once they are determined to be destined
for the local system but before they are received by the control
plane software</li>
<li><strong>FORWARD</strong>: Touches transit traffic as it moves through the box</li>
<li><strong>OUTPUT</strong>: Touches packets that are sourced by the control plane
software before they are put on the wire</li>
<li><strong>POSTROUTING</strong>: Touches packets immediately before they are put on
the wire but after the routing decision has been made</li>
</ul>

<h3 id="tables">Tables</h3>

<p>When building rules to affect the flow of traffic, the individual chains
can be accessed by <em>tables</em>. Linux provides three tables by default:</p>

<ul>
<li><strong>Filter</strong>: Classifies traffic or filters traffic</li>

<li><p><strong>NAT</strong>: Applies Network Address Translation rules</p>

<p>Cumulus Linux does not support NAT.</p></li>

<li><p><strong>Mangle</strong>: Alters packets as they move through the switch</p></li>
</ul>

<p>Each table has a set of default chains that can be used to modify or
inspect packets at different points of the path through the switch.
Chains contain the individual rules to influence traffic. Each table and
the default chains they support are shown below. Tables and chains in
green are supported by Cumulus Linux, those in red are not supported
(that is, they are not hardware accelerated) at this time.</p>

<p><img src="attachments/8362584/8362585.png" alt="" />{height=&ldquo;250&rdquo;} <img src="attachments/8362584/8362586.png" alt="" />{height=&ldquo;250&rdquo;}</p>

<p><img src="attachments/8362584/8362587.png" alt="" />{height=&ldquo;150&rdquo;}</p>

<h3 id="rules">Rules</h3>

<p>Rules are the items that actually classify traffic to be acted upon.
Rules are applied to chains, which are attached to tables, similar to
the graphic below.</p>

<p><img src="attachments/8362584/8362588.png" alt="" />{height=&ldquo;150&rdquo;}</p>

<p>Rules have several different components; the examples below highlight
those different components.</p>

<p><img src="attachments/8362584/8362589.png" alt="" />{height=&ldquo;250&rdquo;}</p>

<ul>
<li><strong>Table:</strong> The first argument is the <em>table</em>. Notice the second
example does not specify a table, that is because the filter table
is implied if a table is not specified.</li>
<li><strong>Chain:</strong> The second argument is the <em>chain</em>. Each table supports
several different chains. See Understanding Tables above.</li>
<li><strong>Matches:</strong> The third argument(s) are called the <em>matches</em>. You can
specify multiple matches in a single rule. However, the more matches
you use in a rule, the more memory that rule consumes.</li>
<li><strong>Jump: </strong>The *jump* specifies the target of the rule; that is, what
action to take if the packet matches the rule. If this option is
omitted in a rule, then matching the rule will have no effect on the
packet&rsquo;s fate, but the counters on the rule will be incremented.</li>
<li><strong>Target(s):</strong> The *target* can be a user-defined chain (other than
the one this rule is in), one of the special built-in targets that
decides the fate of the packet immediately (like DROP), or an
extended target. See the <a href="#CopyofNetfilter-ACLs-supported">Supported Rule Types and Common
Usages</a> section below for examples
of different targets.</li>
</ul>

<h3 id="how-rules-are-parsed-and-applied">How Rules Are Parsed and Applied</h3>

<p>All the rules from each chain are read
from <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code> and entered in order into
either the filter table or the mangle table. The rules are read from the
kernel in the following order:</p>

<ul>
<li>IPv6 (<code>ip6tables</code>)</li>
<li>IPv4 (<code>iptables</code>)</li>
<li><code>ebtables</code></li>
</ul>

<p>When rules are combined and put into one table, the order determines the
relative priority of the rules; <code>iptables</code> and <code>ip6tables</code> have the
highest precedence and <code>ebtables</code> has the lowest.</p>

<p>The Linux packet forwarding construct is an overlay for how the silicon
underneath processes packets; to that end, here are some things to be
aware of:</p>

<ul>
<li>The order of operations for how rules are processed is not perfectly
maintained when you compare how <code>iptables</code> and the
switch silicon process packets. The switch silicon reorders rules
when <code>switchd</code> writes to the ASIC, whereas
traditional <code>iptables</code> executes the list of rules in order.</li>

<li><p>All rules are terminating. This means once a rule is matched, the
action is carried out, and no more rules are processed. The
exception to this is when a SETCLASS rule is placed immediately
before another rule; this exists multiple times in the default ACL
configuration.<br />
In the example below, the SETCLASS action applied with the
<code>--in-interface</code> option, creates the internal ASIC classification,
and <strong>continues to process</strong> the next rule, which does the
rate-limiting for the matched protocol:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --dport $BFD_ECHO_PORT -j SETCLASS --class 7
-A $INGRESS_CHAIN -p udp --dport $BFD_ECHO_PORT -j POLICE --set-mode pkt --set-rate 2000 --set-burst 2000</code></pre></div>
<p>If multiple contiguous rules with the same match criteria are
applied to <code>--in-interface</code>, <strong>only</strong> the first rule gets processed
and then terminates processing. This would also be a
misconfiguration, because there is no reason to have duplicate rules
with different actions.</p></li>

<li><p>When processing traffic, rules affecting the FORWARD chain that
specify an ingress interface are performed prior to rules that match
on an egress interface. As a workaround, rules that only affect the
egress interface can have an ingress interface wildcard (currently,
only *swp+* and *bond+* are supported as wildcard names; see
below) that matches any interface applied so that you can maintain
order of operations with other input interface rules. Take the
following rules, for example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD -i $PORTA -j ACCEPT
-A FORWARD -o $PORTA -j ACCEPT   &lt;-- This rule is performed LAST (because of egress interface matching)
-A FORWARD -i $PORTB -j DROP</code></pre></div>
<p>If you modify the rules like this, they are performed in order:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD -i $PORTA -j ACCEPT
-A FORWARD -i swp+ -o $PORTA -j ACCEPT   &lt;-- These rules are performed in order (because of wildcard match on ingress interface)
-A FORWARD -i $PORTB -j DROP</code></pre></div></li>

<li><p>When using rules that do a mangle and a filter lookup for a packet,
Cumulus Linux does them in parallel and combines the action.</p></li>

<li><p>If a switch port is assigned to a bond, any egress rules must be
assigned to the bond.</p></li>

<li><p>When using the OUTPUT chain, rules must be assigned to the source.
For example, if a rule is assigned to the switch port in the
direction of traffic but the source is a bridge (VLAN), the traffic
won&rsquo;t be affected by the rule and must be applied to the bridge.</p></li>

<li><p>If all transit traffic needs to have a rule applied, use the FORWARD
chain, not the OUTPUT chain.</p></li>

<li><p><code>ebtables</code> rules are put into either the IPv4 or IPv6 memory space
depending on whether the rule utilizes IPv4 or IPv6 to make a
decision. Layer 2-only rules, which match the MAC address, are put
into the IPv4 memory space.</p></li>
</ul>

<h3 id="rule-placement-in-memory">Rule Placement in Memory</h3>

<p>INPUT and ingress (<code>FORWARD -i</code>) rules occupy the same memory space. A
rule counts as ingress if the <code>-i</code> option is set. If both input and
output options (<code>-i</code> and <code>-o</code>) are set, the rule is considered as
ingress and occupies that memory space. For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD -i swp1 -o swp2 -s 10.0.14.2 -d 10.0.15.8 -p tcp -j ACCEPT</code></pre></div>
<p>If you set an output flag with the INPUT chain you will get an error.
For example, running <code>cl-acltool -i</code> on the following rule:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD,INPUT -i swp1 -o swp2 -s 10.0.14.2 -d 10.0.15.8 -p tcp -j ACCEPT</code></pre></div>
<p>generates the following error:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">error: line 2 : output interface specified with INPUT chain error processing rule &#39;-A FORWARD,INPUT -i swp1 -o swp2 -s 10.0.14.2 -d 10.0.15.8 -p tcp -j ACCEPT&#39;</code></pre></div>
<p>However, simply removing the <code>-o</code> option and interface would make it a
valid rule.</p>

<h3 id="enable-nonatomic-updates">Enable Nonatomic Updates</h3>

<p>You can enable nonatomic updates for  <code>switchd</code>, which offer better
scaling because all TCAM resources are used to actively impact traffic.
With atomic updates, half of the hardware resources are on standby and
do not actively impact traffic.</p>

<p>Nonatomic updates are now table based, so they don&rsquo;t interrupt network
traffic when new rules are installed. The rules are mapped into the
following tables and are updated in this order:</p>

<ul>
<li>mirror (ingress only)</li>
<li>ipv4-mac (can be both ingress and egress)</li>
<li>ipv6 (ingress only)</li>
</ul>

<p>Updates are done incrementally, one table at a time without stopping
traffic. Cumulus Linux checks if a table&rsquo;s rules have changed since the
last time they were installed; if a table does not have any changes,
then it is not reinstalled. If there are changes in a table, then the
new rules are populated in new groups or slices in hardware, then that
table is switched over to the new groups or slices. Finally, old
resources for that table are freed. This process is repeated for each of
the tables listed above. If a failure occurs during an update, the
regular nonatomic mode is attempted, which interrupts network traffic.
If that also fails, Cumulus Linux reverts back to the previous rules. </p>

<p>To always start <code>switchd</code> with nonatomic updates:</p>

<ol>
<li>Edit <code>/etc/cumulus/switchd.conf</code>.</li>

<li><p>Add the following line to the file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">acl.non_atomic_update_mode = TRUE </code></pre></div></li>

<li><p><a href="https://docs.cumulusnetworks.com/display/CL257/Configuring+switchd#Configuringswitchd-restartswitchd">Restart <code>switchd</code></a>
:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo systemctl restart switchd.service</code></pre></div></li>
</ol>

<p>During nonatomic updates, traffic is stopped first, and enabled after
the new configuration is written into the hardware completely.</p>

<h3 id="use-iptables-ip6tables-ebtables-directly">Use iptables/ip6tables/ebtables Directly</h3>

<p>Using <code>iptables</code>/<code>ip6tables</code>/<code>ebtables</code> directly is not recommended
because any rules installed in these cases only are applied to the Linux
kernel and are not hardware accelerated via synchronization to the
switch silicon. Also running <code>cl-acltool -i</code> (the installation command)
resets all rules and deletes anything that is not stored
in <code>/etc/cumulus/acl/policy.conf</code>.</p>

<p>For example, performing:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo iptables -A INPUT -p icmp --icmp-type echo-request -j DROP</code></pre></div>
<p>Appears to work, and the rule appears when you run <code>cl-acltool -L</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -L ip
-------------------------------
Listing rules of type iptables: 
------------------------------- 

TABLE filter :
Chain INPUT (policy ACCEPT 72 packets, 5236 bytes) 
pkts bytes target prot opt in out source destination 
0 0 DROP icmp -- any any anywhere anywhere icmp echo-request</code></pre></div>
<p>However, the rule is not synced to hardware when applied in this fashion
and running <code>cl-acltool -i</code> or <code>reboot</code> removes the rule without
replacing it. To ensure all rules that can be in hardware are hardware
accelerated, place them in <code>/etc/cumulus/acl/policy.conf</code> and install
them by running <code>cl-acltool -i</code>.</p>

<h3 id="estimate-the-number-of-rules">Estimate the Number of Rules</h3>

<p>To estimate the number of rules that could be created from an ACL entry,
first determine if that entry is an ingress or an egress. Then determine
if it is IPv4-mac or IPv6 type rule. This determines the slice to which
the rule belongs. Then use the following to determine how many entries
are used up for each type.</p>

<p>By default, each entry occupies one double wide entry, except if the
entry is one of the following:</p>

<ul>
<li><p>An entry with multiple comma-separated input interfaces is split
into one rule for each input interface (listed after
<code>--in-interface</code> below). For example, this entry splits into two
rules:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD --in-interface swp1s0,swp1s1 -p icmp -j ACCEPT</code></pre></div></li>

<li><p>An entry with multiple comma-separated output interfaces is split
into one rule for each output interface (listed
after <code>--out-interface</code> below). This entry splits into two rules:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD --in-interface swp+ --out-interface swp1s0,swp1s1 -p icmp -j ACCEPT</code></pre></div></li>

<li><p>An entry with both input and output comma-separated interfaces is
split into one rule for each combination of input and output
interface (listed after <code>--in-interface</code> and <code>--out-interface</code>
below). This entry splits into four rules:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD --in-interface swp1s0,swp1s1 --out-interface swp1s2,swp1s3 -p icmp -j ACCEPT</code></pre></div></li>

<li><p>An entry with multiple L4 port ranges is split into one rule for
each range (listed after <code>--dports</code> below). For example, this entry
splits into two rules:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD --in-interface swp+ -p tcp -m multiport --dports 1050:1051,1055:1056 -j ACCEPT</code></pre></div></li>
</ul>

<h3 id="match-svi-bridged-interfaces-in-rules">Match SVI/Bridged Interfaces in Rules</h3>

<p>Cumulus Linux supports matching ACL rules for both ingress and egress
interfaces on both <a href="VLAN-aware_Bridge_Mode">VLAN-aware</a> and <a href="Traditional_Bridge_Mode">traditional
mode</a> bridges, including bridge SVIs (<a href="Ethernet-Bridging---VLANs_8362655.html#EthernetBridging-VLANs-svi">switch
VLAN
interfaces</a>)
for input and output. However, keep the following in mind:</p>

<ul>
<li>If a traditional mode bridge has a mix of different VLANs, or has
both access and trunk members, output interface matching is not
supported.</li>
<li>For <code>iptables</code> rules, all IP packets in a bridge are matched, not
just routed packets.</li>
<li>You cannot match both input and output interfaces in a rule.</li>
<li>For routed packets, Cumulus Linux cannot match the output bridge for
SPAN/ERSPAN.</li>
</ul>

<p>Following are example rules for a VLAN-aware bridge:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[ebtables]
-A FORWARD -i br0.100 -p IPv4 --ip-protocol icmp -j DROP
-A FORWARD -o br0.100 -p IPv4 --ip-protocol icmp -j ACCEPT

[iptables]
-A FORWARD -i br0.100 -p icmp -j DROP
-A FORWARD --out-interface br0.100 -p icmp -j ACCEPT
-A FORWARD --in-interface br0.100 -j POLICE --set-mode  pkt  --set-rate  1 --set-burst 1 --set-class 0</code></pre></div>
<p>And here are example rules for a traditional mode bridge:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[ebtables]
-A FORWARD -i br0 -p IPv4 --ip-protocol icmp -j DROP
-A FORWARD -o br0 -p IPv4 --ip-protocol icmp -j ACCEPT


[iptables]
-A FORWARD -i br0 -p icmp -j DROP
-A FORWARD --out-interface br0 -p icmp -j ACCEPT
-A FORWARD --in-interface br0 -j POLICE --set-mode  pkt  --set-rate  1 --set-burst 1 --set-class 0</code></pre></div>
<h2 id="install-and-manage-acl-rules-with-nclu">Install and Manage ACL Rules with NCLU</h2>

<p>NCLU provides an easy way to create custom ACLs in Cumulus Linux. The
rules you create live in the <code>/var/lib/cumulus/nclu/nclu_acl.conf</code> file,
which gets converted to a rules
file, <code>/etc/cumulus/acl/policy.d/50_nclu_acl.rules</code>. This way, the rules
you create with NCLU are independent of the two default files in
<code>/etc/cumulus/acl/policy.d</code>, <code>00control_plane.rules</code>
and <code>99control_plane_catch_all.rules</code>, as the content in these files may
get updated after you upgrade Cumulus Linux. </p>

<p>Instead of crafting a rule by hand then installing it using
<code>cl-acltool</code>, NCLU handles many of the options automatically. For
example, consider the following <code>iptables</code> rule: </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A FORWARD -i swp1 -o swp2 -s 10.0.14.2 -d 10.0.15.8 -p tcp -j ACCEPT</code></pre></div>
<p>You would create this rule, called <em>EXAMPLE1</em>, using NCLU like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add acl ipv4 EXAMPLE1 accept tcp source-ip 10.0.14.2/32 source-port dest-ip 10.0.15.8/32 dest-port any
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>All options, such as the <code>-j</code> and <code>-p</code>, even <code>FORWARD</code> in the above
rule, are added automatically when you apply the rule to the control
plane; NCLU figures it all out for you.</p>

<p>You can also set a priority value, which specifies the order in which
the rules get executed, and the order in which they appear in the rules
file. Lower numbers are executed first. To add a new rule in the middle,
first run <code>net show config acl</code>, which displays the priority numbers.
Otherwise, new rules get appended to the end of the list of rules in
the <code>nclu_acl.conf</code> and <code>50_nclu_acl.rules</code> files.</p>

<p>If you need to hand edit a rule, don’t edit the <code>50_nclu_acl.rules</code>
file. Instead, edit the <code>nclu_acl.conf</code> file.</p>

<p>After you add the rule, you need to apply it to an inbound or outbound
interface using <code>net add int acl</code>; swp1 is the inbound interface in our
example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add int swp1 acl ipv4 EXAMPLE1 inbound
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>After you commit your changes, you can verify the rule you created with
NCLU by running <code>net show configuration acl</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show configuration acl 
acl ipv4 EXAMPLEv4 priority 10 accept tcp source-ip 10.0.14.2/32 source-port any dest-ip 10.0.15.8/32 dest-port any

interface swp1
  acl ipv4 EXAMPLE1 inbound</code></pre></div>
<p>Or you can see all of the rules installed by running <code>cat</code> on
the <code>50_nclu_acl.rules</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ cat /etc/cumulus/acl/policy.d/50_nclu_acl.rules 
[iptables]
# swp1: acl ipv4 EXAMPLE1 inbound
-A FORWARD --in-interface swp1 --out-interface swp2 -j ACCEPT -p tcp -s 10.0.14.2/32 -d 10.0.15.8/32 --dport 110</code></pre></div>
<p>For INPUT and FORWARD rules, apply the rule to a control plane interface
using <code>net add control-plane</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add control-plane acl ipv4 EXAMPLE1 inbound
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>To remove a rule, use <code>net del acl ipv4|ipv6|mac RULENAME</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del acl ipv4 EXAMPLE1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>This deletes all rules from the <code>50_nclu_acl.rules</code> file with that name.
It also deletes the interfaces referenced in the <code>nclu_acl.conf</code> file.</p>

<h2 id="install-and-manage-acl-rules-with-cl-acltool">Install and Manage ACL Rules with cl-acltool</h2>

<p>You can manage Cumulus Linux ACLs with <code>cl-acltool</code>. Rules are first
written to the <code>iptables</code> chains, as described above, and then synced to
hardware via <code>switchd</code>. </p>

<p>Use <code>iptables</code>/<code>ip6tables</code>/<code>ebtables</code> and <code>cl-acltool</code> to manage rules
in the default files, <code>00control_plane.rules</code> and
<code>99control_plane_catch_all.rules</code>; they’re not aware of rules created
using NCLU.</p>

<p>To examine the current state of chains and list all installed rules,
run:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -L all 
------------------------------- 
Listing rules of type iptables: 
------------------------------- 

TABLE filter : 
Chain INPUT (policy ACCEPT 90 packets, 14456 bytes) 
pkts bytes target prot opt in out source destination 
0 0 DROP all -- swp+ any 240.0.0.0/5 anywhere 
0 0 DROP all -- swp+ any loopback/8 anywhere 
0 0 DROP all -- swp+ any base-address.mcast.net/8 anywhere 
0 0 DROP all -- swp+ any 255.255.255.255 anywhere ...</code></pre></div>
<p>To list installed rules using
native <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code>, use the <code>-L</code> option with
the respective commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo iptables -L 
cumulus@switch:~$ sudo ip6tables -L 
cumulus@switch:~$ sudo ebtables -L</code></pre></div>
<p>To flush all installed rules, run:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -F all</code></pre></div>
<p>To flush only the IPv4 <code>iptables</code> rules, run:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -F ip</code></pre></div>
<p>If the install fails, ACL rules in the kernel and hardware are rolled
back to the previous state. Errors from programming rules in the kernel
or ASIC are reported appropriately.</p>

<h2 id="install-packet-filtering-acl-rules">Install Packet Filtering (ACL) Rules</h2>

<p><code>cl-acltool</code> takes access control list (ACL) rules input in files. Each
ACL policy file
contains <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code> categories under the
tags <code>[iptables]</code>, <code>[ip6tables]</code> and <code>[ebtables]</code> respectively.</p>

<p>Each rule in an ACL policy must be assigned to one of the rule
categories above.</p>

<p>See <code>man cl-acltool(5)</code> for ACL rule details. For <code>iptables</code> rule
syntax, see <code>man iptables(8)</code>. For <code>ip6tables</code> rule syntax,
see <code>man ip6tables(8)</code>. For <code>ebtables</code> rule syntax,
see <code>man ebtables(8)</code>.</p>

<p>See <code>man cl-acltool(5)</code> and <code>man cl-acltool(8)</code> for further details on
using <code>cl-acltool</code>; however, some examples are listed here, and more are
listed <a href="#CopyofNetfilter-ACLs-exm">later in this chapter</a>. </p>

<p>By default:</p>

<ul>
<li>ACL policy files are located in <code>/etc/cumulus/acl/policy.d/</code>.</li>
<li>All <code>*.rules</code> files in this directory are included
in <code>/etc/cumulus/acl/policy.conf</code>.</li>
<li>All files included in this <code>policy.conf</code> file are installed when the
switch boots up.</li>
<li>The <code>policy.conf</code> file expects rules files to have a <code>.rules</code> suffix
as part of the file name.</li>
</ul>

<p>Here is an example ACL policy file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] 
-A INPUT --in-interface swp1 -p tcp --dport 80 -j ACCEPT 
-A FORWARD --in-interface swp1 -p tcp --dport 80 -j ACCEPT 

[ip6tables] 
-A INPUT --in-interface swp1 -p tcp --dport 80 -j ACCEPT 
-A FORWARD --in-interface swp1 -p tcp --dport 80 -j ACCEPT 
  
[ebtables] 
-A INPUT -p IPv4 -j ACCEPT 
-A FORWARD -p IPv4 -j ACCEPT</code></pre></div>
<p>You can use wildcards or variables to specify chain and interface lists
to ease administration of rules.</p>

<p>Interface Wildcards</p>

<p>Currently only <em>swp+</em> and <em>bond+</em> are supported as wildcard names. There
may be kernel restrictions in supporting more complex wildcards likes
<em>swp1+ etc</em>.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">INGRESS = swp+ 
INPUT_PORT_CHAIN = INPUT,FORWARD 

[iptables] 
-A $INPUT_PORT_CHAIN --in-interface $INGRESS -p tcp --dport 80 -j ACCEPT 
  
[ip6tables] 
-A $INPUT_PORT_CHAIN --in-interface $INGRESS -p tcp --dport 80 -j ACCEPT 

[ebtables] 
-A INPUT -p IPv4 -j ACCEPT</code></pre></div>
<p>ACL rules for the system can be written into multiple files under the
default <code>/etc/cumulus/acl/policy.d/</code> directory. The ordering of rules
during installation follows the sort order of the files based on their
file names.</p>

<p>Use multiple files to stack rules. The example below shows two rules
files separating rules for management and datapath traffic:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ ls /etc/cumulus/acl/policy.d/ 
00sample_mgmt.rules 01sample_datapath.rules 
cumulus@switch:~$ cat /etc/cumulus/acl/policy.d/00sample_mgmt.rules 
  
INGRESS_INTF = swp+ 
INGRESS_CHAIN = INPUT 
  
[iptables] 
# protect the switch management 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -s 10.0.14.2 -d 10.0.15.8 -p tcp -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -s 10.0.11.2 -d 10.0.12.8 -p tcp -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -d 10.0.16.8 -p udp -j DROP 

cumulus@switch:~$ cat /etc/cumulus/acl/policy.d/01sample_datapath.rules 
INGRESS_INTF = swp+ 
INGRESS_CHAIN = INPUT, FORWARD 

[iptables] 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -s 192.0.2.5 -p icmp -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -s 192.0.2.6 -d 192.0.2.4 -j DROP 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -s 192.0.2.2 -d 192.0.2.8 -j DROP</code></pre></div>
<p>Install all ACL policies under a directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -i -P ./rules 
Reading files under rules 
Reading rule file ./rules/01_http_rules.txt ... 
Processing rules in file ./rules/01_http_rules.txt ... 
Installing acl policy ... 
Done.</code></pre></div>
<p>Install all rules and policies included
in <code>/etc/cumulus/acl/policy.conf</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -i</code></pre></div>
<h2 id="specify-the-policy-files-to-install">Specify the Policy Files to Install</h2>

<p>By default, any <code>.rules</code> file you configure
in <code>/etc/cumulus/acl/policy.d/</code> get installed by Cumulus Linux. To add
other policy files to an ACL, you need to include them
in <code>/etc/cumulus/acl/policy.conf</code>. For example, in order for Cumulus
Linux to install a rule in a policy file called <code>01_new.datapathacl</code>,
you would
add <code>include /etc/cumulus/acl/policy.d/01_new.rules</code> to <code>policy.conf</code>,
as in this example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo nano /etc/cumulus/acl/policy.conf 

# 
# This file is a master file for acl policy file inclusion 
# 
# Note: This is not a file where you list acl rules. 
# 
# This file can contain: 
# - include lines with acl policy files 
#   example: 
#     include &lt;filepath&gt; 
# 
# see manpage cl-acltool(5) and cl-acltool(8) for how to write policy files 
# 

include /etc/cumulus/acl/policy.d/01_new.datapathacl</code></pre></div>
<h2 id="hardware-limitations-on-number-of-rules">Hardware Limitations on Number of Rules</h2>

<p>The maximum number of rules that can be handled in hardware is a
function of the following factors:</p>

<ul>
<li>The platform type (switch silicon, like Tomahawk or Spectrum — see
the <a href="http://cumulusnetworks.com/support/hcl">HCL </a>to determine which
platform type applies to a particular switch)</li>
<li>The mix of IPv4 and/or IPv6 rules; Cumulus Linux doesn&rsquo;t support the
maximum number of rules for both IPv4 and IPv6 simultaneously</li>
<li>The number of default rules provided by Cumulus Linux</li>
<li>Whether the rules are applied on ingress or egress</li>
<li>Whether the rules are in atomic or nonatomic mode; nonatomic mode
rules are used when nonatomic updates are enabled (<a href="#CopyofNetfilter-ACLs-nonatomic">see
above</a>)</li>
</ul>

<p>If the maximum number of rules for a particular table is
exceeded, <code>cl-acltool -i</code> generates the following error:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">error: hw sync failed (sync_acl hardware installation failed) Rolling back .. failed.</code></pre></div>
<p>On Broadcom platforms, IPv6 egress rules are not supported. The default
rules count toward the limits listed in the tables below.</p>

<h3 id="broadcom-tomahawk-limits">Broadcom Tomahawk Limits</h3>

<table>
<thead>
<tr>
<th>Direction</th>
<th>Atomic Mode IPv4 Rules</th>
<th>Atomic Mode IPv6 Rules</th>
<th>Nonatomic Mode IPv4 Rules</th>
<th>Nonatomic Mode IPv6 Rules</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ingress raw limit</td>
<td>256</td>
<td>256</td>
<td>768</td>
<td>768</td>
</tr>

<tr>
<td>Ingress with default rules</td>
<td>256 (36 default)</td>
<td>256 (29 default)</td>
<td>256 (36 default)</td>
<td>256 (29 default)</td>
</tr>

<tr>
<td>Egress raw limit</td>
<td>256</td>
<td>N/A</td>
<td>512</td>
<td>N/A</td>
</tr>

<tr>
<td>Egress with default rules</td>
<td>256 (29 default)</td>
<td>N/A</td>
<td>256 (29 default)</td>
<td>N/A</td>
</tr>
</tbody>
</table>

<h3 id="broadcom-trident-ii-and-trident3-limits">Broadcom Trident II+ and Trident3 Limits</h3>

<table>
<thead>
<tr>
<th>Direction</th>
<th>Atomic Mode IPv4 Rules</th>
<th>Atomic Mode IPv6 Rules</th>
<th>Nonatomic Mode IPv4 Rules</th>
<th>Nonatomic Mode IPv6 Rules</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ingress raw limit</td>
<td>2048</td>
<td>3072</td>
<td>6144</td>
<td>6144</td>
</tr>

<tr>
<td>Ingress with default rules</td>
<td>1024 (36 default)</td>
<td>2048 (29 default)</td>
<td>2048 (36 default)</td>
<td>2048 (29 default)</td>
</tr>

<tr>
<td>Egress raw limit</td>
<td>256</td>
<td>N/A</td>
<td>512</td>
<td>N/A</td>
</tr>

<tr>
<td>Egress with default rules</td>
<td>256 (29 default)</td>
<td>N/A</td>
<td>256 (29 default)</td>
<td>N/A</td>
</tr>
</tbody>
</table>

<h3 id="broadcom-trident-ii-limits">Broadcom Trident II Limits</h3>

<table>
<thead>
<tr>
<th>Direction</th>
<th>Atomic Mode IPv4 Rules</th>
<th>Atomic Mode IPv6 Rules</th>
<th>Nonatomic Mode IPv4 Rules</th>
<th>Nonatomic Mode IPv6 Rules</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ingress raw limit</td>
<td>512</td>
<td>768</td>
<td>1536</td>
<td>1536</td>
</tr>

<tr>
<td>Ingress with default rules</td>
<td>256 (36 default)</td>
<td>512 (29 default)</td>
<td>512 (36 default)</td>
<td>512 (29 default)</td>
</tr>

<tr>
<td>Egress raw limit</td>
<td>256</td>
<td>N/A</td>
<td>512</td>
<td>N/A</td>
</tr>

<tr>
<td>Egress with default rules</td>
<td>256 (29 default)</td>
<td>N/A</td>
<td>256 (29 default)</td>
<td>N/A</td>
</tr>
</tbody>
</table>

<h3 id="broadcom-helix4-limits">Broadcom Helix4 Limits</h3>

<table>
<thead>
<tr>
<th>Direction</th>
<th>Atomic Mode IPv4 Rules</th>
<th>Atomic Mode IPv6 Rules</th>
<th>Nonatomic Mode IPv4 Rules</th>
<th>Nonatomic Mode IPv6 Rules</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ingress raw limit</td>
<td>768</td>
<td>384</td>
<td>1792</td>
<td>896</td>
</tr>

<tr>
<td>Ingress with default rules</td>
<td>128 (36 default)</td>
<td>128 (29 default)</td>
<td>128 (36 default)</td>
<td>128 (29 default)</td>
</tr>

<tr>
<td>Egress raw limit</td>
<td>256</td>
<td>N/A</td>
<td>512</td>
<td>N/A</td>
</tr>

<tr>
<td>Egress with default rules</td>
<td>256 (29 default)</td>
<td>N/A</td>
<td>256 (29 default)</td>
<td>N/A</td>
</tr>
</tbody>
</table>

<h3 id="mellanox-spectrum-limits">Mellanox Spectrum Limits</h3>

<p>The Mellanox Spectrum ASIC has one
common <a href="https://en.wikipedia.org/wiki/Content-addressable_memory#Ternary_CAMs">TCAM</a> for
both ingress and egress, and it may be used for other non-ACL-related
resources. However, the number of supported rules varies with the <a href="Routing_8362912.html#Routing-tcam">TCAM
profile</a> specified for the switch. </p>

<table>
<thead>
<tr>
<th>Profile</th>
<th>Atomic Mode IPv4 Rules</th>
<th>Atomic Mode IPv6 Rules</th>
<th>Nonatomic Mode IPv4 Rules</th>
<th>Nonatomic Mode IPv6 Rules</th>
</tr>
</thead>

<tbody>
<tr>
<td>default</td>
<td>1750</td>
<td>750</td>
<td>3500</td>
<td>1500</td>
</tr>

<tr>
<td>ipmc-heavy</td>
<td>200</td>
<td>80</td>
<td>400</td>
<td>160</td>
</tr>

<tr>
<td>acl-heavy</td>
<td>3000</td>
<td>2000</td>
<td>6000</td>
<td>2500</td>
</tr>
</tbody>
</table>

<h2 id="supported-rule-types">Supported Rule Types</h2>

<p>The <code>iptables</code>/<code>ip6tables</code>/<code>ebtables</code> construct tries to layer the Linux
implementation on top of the underlying hardware but they are not always
directly compatible. Here are the supported rules for chains
in <code>iptables</code>, <code>ip6tables</code> and <code>ebtables</code>.</p>

<p>To learn more about any of the options shown in the tables below, run
<code>iptables -h [name of option]</code>. The same help syntax works for options
for <code>ip6tables</code> and <code>ebtables</code>.</p>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}Click to see
an example of help syntax for an ebtables target</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">root@leaf1# ebtables -h tricolorpolice
&lt;...snip...&gt;
tricolorpolice option:
 --set-color-mode STRING setting the mode in blind or aware
 --set-cir INT setting committed information rate in kbits per second
 --set-cbs INT setting committed burst size in kbyte
 --set-pir INT setting peak information rate in kbits per second
 --set-ebs INT setting excess burst size in kbyte
 --set-conform-action-dscp INT setting dscp value if the action is accept for conforming packets
 --set-exceed-action-dscp INT setting dscp value if the action is accept for exceeding packets
 --set-violate-action STRING setting the action (accept/drop) for violating packets
 --set-violate-action-dscp INT setting dscp value if the action is accept for violating packets
Supported chains for the filter table:
INPUT FORWARD OUTPUT</code></pre></div>
<h3 id="iptables-ip6tables-rule-support">iptables/ip6tables Rule Support</h3>

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Rule Element</th>
<th>Supported</th>
<th>Unsupported</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Matches</strong></td>
<td><ul>
<li>Src/Dst, IP protocol</li>
<li>In/out interface</li>
<li>IPv4: icmp, ttl,</li>
<li>IPv6: icmp6, frag, hl,</li>
<li>IP common: tcp (<a href="#CopyofNetfilter-ACLs-filteringtcp">with flags</a>), udp, multiport,TOS, DSCP, addrtype</li>
</ul></td>
<td><ul>
<li>Rules with input/output Ethernet interfaces are ignored</li>
<li>Inverse matches</li>
</ul></td>
</tr>
<tr class="even">
<td><strong>Standard Targets</strong></td>
<td><ul>
<li>ACCEPT, DROP</li>
</ul></td>
<td><ul>
<li>RETURN, QUEUE, STOP, Fall Thru, Jump</li>
</ul></td>
</tr>
<tr class="odd">
<td><strong>Extended Targets</strong></td>
<td><ul>
<li>LOG (IPv4/IPv6); UID is not supported for LOG</li>
<li>TCP SEQ, TCP options or IP options</li>
<li>ULOG</li>
<li>SETQOS</li>
<li>DSCP</li>
</ul>
<p><em>Unique to Cumulus Linux:</em></p>
<ul>
<li>SPAN</li>
<li>ERSPAN (IPv4/IPv6)</li>
<li>POLICE</li>
<li>TRICOLORPOLICE</li>
<li>SETCLASS</li>
</ul></td>
<td> </td>
</tr>
</tbody>
</table>

<h3 id="ebtables-rule-support">ebtables Rule Support</h3>

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Rule Element</th>
<th>Supported</th>
<th>Unsupported</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Matches</strong></td>
<td><ul>
<li>ether type</li>
<li>input interface/wildcard</li>
<li>output interface/wildcard</li>
<li>src/dst MAC</li>
<li>IP: src, dest, tos, proto, sport, dport</li>
<li>IPv6: tclass, icmp6: type, icmp6: code range, src/dst addr, sport, dport</li>
</ul></td>
<td><ul>
<li>Inverse matches</li>
<li>Proto length</li>
<li>VLAN</li>
<li>802.1p (CoS)</li>
</ul></td>
</tr>
<tr class="even">
<td><strong>Standard Targets</strong></td>
<td><ul>
<li>ACCEPT, DROP</li>
</ul></td>
<td><ul>
<li>Return, Continue, Jump, Fall Thru</li>
</ul></td>
</tr>
<tr class="odd">
<td><strong>Extended Targets</strong></td>
<td><ul>
<li>Ulog</li>
<li>log</li>
</ul>
<p><em>Unique to Cumulus Linux:</em></p>
<ul>
<li>span</li>
<li>erspan</li>
<li>police</li>
<li>tricolorpolice</li>
<li>setclass</li>
</ul></td>
<td> </td>
</tr>
</tbody>
</table>

<h3 id="other-unsupported-rules"><strong>Other Unsupported Rules</strong></h3>

<ul>
<li>Rules that have no matches and accept all packets in a chain are
currently ignored. This probably has side effects in the sense that
the rules below them do get hit, when normally they wouldn&rsquo;t.</li>
<li>Chain default rules (which are ACCEPT) are also ignored.</li>
</ul>

<h2 id="common-examples">Common Examples</h2>

<h3 id="control-plane-and-data-plane-traffic">Control Plane and Data Plane Traffic</h3>

<p>You can configure quality of service for traffic on both the control
plane and the data plane. By using QoS policers, you can rate limit
traffic so incoming packets get dropped if they exceed specified
thresholds.</p>

<p>Counters on POLICE ACL rules in <code>iptables</code> do not currently show the
packets that are dropped due to those rules.</p>

<p>Use the <code>POLICE</code> target with <code>iptables</code>. <code>POLICE</code> takes these arguments:</p>

<ul>
<li><code>--set-class value</code>: Sets the system internal class of service queue
configuration to <em>value</em>.</li>
<li><code>--set-rate value</code>: Specifies the maximum rate in kilobytes (KB) or
packets.</li>
<li><code>--set-burst value</code>: Specifies the number of packets or kilobytes
(KB) allowed to arrive sequentially.</li>
<li><code>--set-mode string</code>: Sets the mode in *KB* (kilobytes)
or *pkt* (packets) for rate and burst size.</li>
</ul>

<p>For example, to rate limit the incoming traffic on swp1 to 400
packets/second with a burst of 100 packets/second and set the class of
the queue for the policed traffic as 0, set this rule in your
appropriate <code>.rules</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A INPUT --in-interface swp1 -j POLICE --set-mode pkt --set-rate 400 --set-burst 100 --set-class 0</code></pre></div>
<p>Here is another example of control plane ACL rules to lock down the
switch. You specify them
in <code>/etc/cumulus/acl/policy.d/00control_plane.rules</code>:</p>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}View the
contents of the file &hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">INGRESS_INTF = swp+ 
INGRESS_CHAIN = INPUT 
INNFWD_CHAIN = INPUT,FORWARD 
MARTIAN_SOURCES_4 = &#34;240.0.0.0/5,127.0.0.0/8,224.0.0.0/8,255.255.255.255/32&#34; 
MARTIAN_SOURCES_6 = &#34;ff00::/8,::/128,::ffff:0.0.0.0/96,::1/128&#34; 

  
# Custom Policy Section 
SSH_SOURCES_4 = &#34;192.168.0.0/24&#34; 
NTP_SERVERS_4 = &#34;192.168.0.1/32,192.168.0.4/32&#34; 
DNS_SERVERS_4 = &#34;192.168.0.1/32,192.168.0.4/32&#34; 
SNMP_SERVERS_4 = &#34;192.168.0.1/32&#34; 

  
[iptables] 
-A $INNFWD_CHAIN --in-interface $INGRESS_INTF -s $MARTIAN_SOURCES_4 -j DROP 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p ospf -j POLICE --set-mode pkt --set-rate 2000 --set-burst 2000 --set-class 7 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bgp -j POLICE --set-mode pkt --set-rate 2000 --set-burst 2000 --set-class 7 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --sport bgp -j POLICE --set-mode pkt --set-rate 2000 --set-burst 2000 --set-class 7 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p icmp -j POLICE --set-mode pkt --set-rate 100 --set-burst 40 --set-class 2 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --dport bootps:bootpc -j POLICE --set-mode pkt --set-rate 100 --set-burst 100 --set-class 2 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bootps:bootpc -j POLICE --set-mode pkt --set-rate 100 --set-burst 100 --set-class 2 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p igmp -j POLICE --set-mode pkt --set-rate 300 --set-burst 100 --set-class 6 

  
# Custom policy 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport 22 -s $SSH_SOURCES_4 -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --sport 123 -s $NTP_SERVERS_4 -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --sport 53 -s $DNS_SERVERS_4 -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --dport 161 -s $SNMP_SERVERS_4 -j ACCEPT 

  
# Allow UDP traceroute when we are the current TTL expired hop 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p udp --dport 1024:65535 -m ttl --ttl-eq 1 -j ACCEPT 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -j DROP</code></pre></div>
<h3 id="set-dscp-on-transit-traffic">Set DSCP on Transit Traffic</h3>

<p>The examples here use the *mangle* table to modify the packet as it
transits the switch. DSCP is expressed in <a href="https://en.wikipedia.org/wiki/Differentiated_services#Commonly_used_DSCP_values">decimal
notation</a> in
the examples below.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables]
 
#Set SSH as high priority traffic.
-t mangle -A FORWARD -p tcp --dport 22  -j DSCP --set-dscp 46 

#Set everything coming in SWP1 as AF13
-t mangle -A FORWARD --in-interface swp1 -j DSCP --set-dscp 14

#Set Packets destined for 10.0.100.27 as best effort
-t mangle -A FORWARD -d 10.0.100.27/32 -j DSCP --set-dscp 0

#Example using a range of ports for TCP traffic
-t mangle -A FORWARD -p tcp -s 10.0.0.17/32 --sport 10000:20000 -d 10.0.100.27/32 --dport 10000:20000 -j DSCP --set-dscp 34</code></pre></div>
<h3 id="verify-dscp-values-on-transit-traffic">Verify DSCP Values on Transit Traffic</h3>

<p>The examples here use the DSCP match criteria in combination with other
IP, TCP and interface matches to identify traffic and count the number
of packets.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables]
 
#Match and count the packets that match SSH traffic with DSCP EF
-A FORWARD -p tcp --dport 22 -m dscp --dscp 46 -j ACCEPT

#Match and count the packets coming in SWP1 as AF13
-A FORWARD --in-interface swp1 -m dscp --dscp 14 -j ACCEPT
#Match and count the packets with a destination 10.0.0.17 marked best effort
-A FORWARD -d 10.0.100.27/32 -m dscp --dscp 0 -j ACCEPT

#Match and count the packets in a port range with DSCP AF41
-A FORWARD -p tcp -s 10.0.0.17/32 --sport 10000:20000 -d 10.0.100.27/32 --dport 10000:20000 -m dscp --dscp 34 -j ACCEPT</code></pre></div>
<h3 id="check-the-packet-and-byte-counters-for-acl-rules">Check the Packet and Byte Counters for ACL Rules</h3>

<p>To verify the counters, using the above example rules, first send test
traffic matching the patterns through the network. The following
example generates traffic
with <a href="http://www.perihel.at/sec/mz/">mz</a>, which can be installed on host
servers or even on Cumulus Linux switches. Once traffic is sent to
validate the counters, they are matched on switch1 use <code>cl-acltool</code>.  </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"># Send 100 TCP packets on host1 with a DSCP value of EF with a destination of host2 TCP port 22:
 
cumulus@host1$ mz eth1 -A 10.0.0.17 -B 10.0.100.27 -c 100 -v -t tcp &#34;dp=22,dscp=46&#34;
 IP:  ver=4, len=40, tos=184, id=0, frag=0, ttl=255, proto=6, sum=0, SA=10.0.0.17, DA=10.0.100.27,
      payload=[see next layer]
 TCP: sp=0, dp=22, S=42, A=42, flags=0, win=10000, len=20, sum=0,
      payload=
 
# Verify the 100 packets are matched on switch1

cumulus@switch1$ sudo cl-acltool -L ip
-------------------------------
Listing rules of type iptables:
-------------------------------
TABLE filter :
Chain INPUT (policy ACCEPT 9314 packets, 753K bytes)
 pkts bytes target     prot opt in     out     source               destination
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  100  6400 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh DSCP match 0x2e
    0     0 ACCEPT     all  --  swp1   any     anywhere             anywhere             DSCP match 0x0e
    0     0 ACCEPT     all  --  any    any     10.0.0.17            anywhere             DSCP match 0x00
    0     0 ACCEPT     tcp  --  any    any     10.0.0.17            10.0.100.27          tcp spts:webmin:20000 dpts:webmin:2002</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"># Send 100 packets with a small payload on host1 with a DSCP value of AF13 with a destination of host2:

cumulus@host1$ mz eth1 -A 10.0.0.17 -B 10.0.100.27 -c 100 -v -t ip
 IP:  ver=4, len=20, tos=0, id=0, frag=0, ttl=255, proto=0, sum=0, SA=10.0.0.17, DA=10.0.100.27,
      payload=

# Verify the 100 packets are matched on switch1

cumulus@switch1$ sudo cl-acltool -L ip
-------------------------------
Listing rules of type iptables:
-------------------------------
TABLE filter :
Chain INPUT (policy ACCEPT 9314 packets, 753K bytes)
 pkts bytes target     prot opt in     out     source               destination
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  100  6400 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh DSCP match 0x2e
  100  7000 ACCEPT     all  --  swp3   any     anywhere             anywhere             DSCP match 0x0e
  100  6400 ACCEPT     all  --  any    any     10.0.0.17            anywhere             DSCP match 0x00
    0     0 ACCEPT     tcp  --  any    any     10.0.0.17            10.0.100.27          tcp spts:webmin:20000 dpts:webmin:2002</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-perl" data-lang="perl"><span class="c1"># Send 100 packets on host1 with a destination of host2:</span>

<span class="n">cumulus</span><span class="nv">@host1$</span> <span class="nv">mz</span> <span class="n">eth1</span> <span class="o">-</span><span class="n">A</span> <span class="mf">10.0.0.17</span> <span class="o">-</span><span class="n">B</span> <span class="mf">10.0.100.27</span> <span class="o">-</span><span class="n">c</span> <span class="mi">100</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">t</span> <span class="n">ip</span>
 <span class="n">IP:</span>  <span class="n">ver</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">len</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tos</span><span class="o">=</span><span class="mi">56</span><span class="p">,</span> <span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">frag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">SA</span><span class="o">=</span><span class="mf">10.0.0.17</span><span class="p">,</span> <span class="n">DA</span><span class="o">=</span><span class="mf">10.0.100.27</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span>

<span class="c1"># Verify the 100 packets are matched on switch1</span>

<span class="n">cumulus</span><span class="nv">@switch1$</span> <span class="nv">sudo</span> <span class="n">cl</span><span class="o">-</span><span class="n">acltool</span> <span class="o">-</span><span class="n">L</span> <span class="n">ip</span>
<span class="o">-------------------------------</span>
<span class="n">Listing</span> <span class="n">rules</span> <span class="n">of</span> <span class="n">type</span> <span class="n">iptables:</span>
<span class="o">-------------------------------</span>
<span class="n">TABLE</span> <span class="n">filter</span> <span class="p">:</span>
<span class="n">Chain</span> <span class="n">INPUT</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span> <span class="mi">9314</span> <span class="n">packets</span><span class="p">,</span> <span class="mi">753</span><span class="n">K</span> <span class="n">bytes</span><span class="p">)</span>
 <span class="n">pkts</span> <span class="n">bytes</span> <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">in</span>     <span class="n">out</span>     <span class="n">source</span>               <span class="n">destination</span>
<span class="n">Chain</span> <span class="n">FORWARD</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span> <span class="mi">0</span> <span class="n">packets</span><span class="p">,</span> <span class="mi">0</span> <span class="n">bytes</span><span class="p">)</span>
 <span class="n">pkts</span> <span class="n">bytes</span> <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">in</span>     <span class="n">out</span>     <span class="n">source</span>               <span class="n">destination</span>
  <span class="mi">100</span>  <span class="mi">6400</span> <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="n">any</span>    <span class="n">any</span>     <span class="n">anywhere</span>             <span class="n">anywhere</span>             <span class="n">tcp</span> <span class="n">dpt:ssh</span> <span class="n">DSCP</span> <span class="n">match</span> <span class="mh">0x2e</span>
  <span class="mi">100</span>  <span class="mi">7000</span> <span class="n">ACCEPT</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="n">swp3</span>   <span class="n">any</span>     <span class="n">anywhere</span>             <span class="n">anywhere</span>             <span class="n">DSCP</span> <span class="n">match</span> <span class="mh">0x0e</span>
    <span class="mi">0</span>     <span class="mi">0</span> <span class="n">ACCEPT</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="n">any</span>    <span class="n">any</span>     <span class="mf">10.0.0.17</span>            <span class="n">anywhere</span>             <span class="n">DSCP</span> <span class="n">match</span> <span class="mh">0x00</span>
    <span class="mi">0</span>     <span class="mi">0</span> <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="n">any</span>    <span class="n">any</span>     <span class="mf">10.0.0.17</span>            <span class="mf">10.0.100.27</span>          <span class="n">tcp</span> <span class="n">spts:webmin:20000</span> <span class="n">dpts:webmin:2002Still</span> <span class="n">working</span></code></pre></div>
<h3 id="filter-specific-tcp-flags">Filter Specific TCP Flags</h3>

<p>The example solution below creates rules on the INPUT and FORWARD chains
to drop ingress IPv4 and IPv6 TCP packets when the SYN bit is set
and the RST, ACK and FIN bits are reset. The default for the INPUT and
FORWARD chains allows all other packets. The ACL is applied to
ports swp20 and swp21. After configuring this ACL, new TCP sessions that
originate from ingress ports swp20 and swp21 will not be allowed.
TCP sessions that originate from any other port are allowed.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">INGRESS_INTF = swp20,swp21

[iptables]
-A INPUT,FORWARD --in-interface $INGRESS_INTF -p tcp --syn -j DROP
[ip6tables]
-A INPUT,FORWARD --in-interface $INGRESS_INTF -p tcp --syn -j DROP</code></pre></div>
<p>The <code>--syn</code> flag in the above rule matches packets with the SYN bit set
and the ACK, RST and FIN bits are cleared. It is equivalent to
using <code>-tcp-flags SYN,RST,ACK,FIN SYN</code>. For example, the above rule
could be re-written as:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-A INPUT,FORWARD --in-interface $INGRESS_INTF -p tcp --tcp-flags SYN,RST,ACK,FIN SYN -j DROP</code></pre></div>
<h2 id="example-scenario">Example Scenario</h2>

<p>The following example scenario demonstrates where several different
rules are applied to show what is possible.</p>

<p><img src="attachments/8362584/8362590.png" alt="" /></p>

<p>Following are the configurations for the two switches used in these
examples. The configuration for each switch appears
in <code>/etc/network/interfaces</code> on that switch.</p>

<h3 id="switch-1-configuration">Switch 1 Configuration</h3>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch1:~$ net show configuration files

...

/etc/network/interfaces
=======================


auto swp1 
iface swp1 
 
auto swp2 
iface swp2 
 
auto swp3 
iface swp3 
 
auto swp4 
iface swp4 
 
auto bond2 
iface bond2 
    bond-slaves swp3 swp4 
 
auto br-untagged 
iface br-untagged 
    address 10.0.0.1/24
    bridge_ports swp1 bond2 
    bridge_stp on
 
auto br-tag100 
iface br-tag100 
    address 10.0.100.1/24
    bridge_ports swp2.100 bond2.100 
    bridge_stp on 
 
...</code></pre></div>
<h3 id="switch-2-configuration">Switch 2 Configuration</h3>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch2:~$ net show configuration files
 
...
 
/etc/network/interfaces
=======================
 
auto swp3 
iface swp3 
 
auto swp4 
iface swp4 
 
auto br-untagged 
iface br-untagged 
    address 10.0.0.2/24
    bridge_ports bond2 
    bridge_stp on 
 
auto br-tag100 
iface br-tag100 
    address 10.0.100.2/24 
    bridge_ports bond2.100 
    bridge_stp on 
 
auto bond2 
iface bond2 
    bond-slaves swp3 swp4 
 
...</code></pre></div>
<h3 id="egress-rule">Egress Rule</h3>

<p>The following rule blocks any TCP with destination port 200 traffic
going from host1 or host2 through the switch (corresponding to rule 1
in the diagram above).</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] -A FORWARD -o bond2 -p tcp --dport 200 -j DROP</code></pre></div>
<h3 id="ingress-rule">Ingress Rule</h3>

<p>The following rule blocks any UDP traffic with source port 200 going
from host1 through the switch (corresponding to rule 2 in the diagram
above).</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] -A FORWARD -i swp2 -p udp --sport 200 -j DROP</code></pre></div>
<h3 id="input-rule">Input Rule</h3>

<p>The following rule blocks any UDP traffic with source port 200 and
destination port 50 going from host1 to the switch (corresponding to
rule 3 in the diagram above).</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] -A INPUT -i swp1 -p udp --sport 200 --dport 50 -j DROP</code></pre></div>
<h3 id="output-rule">Output Rule</h3>

<p>The following rule blocks any TCP traffic with source port 123 and
destination port 123 going from Switch 1 to host2 (corresponding to rule
4 in the diagram above). </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] -A OUTPUT -o br-tag100 -p tcp --sport 123 --dport 123 -j DROP</code></pre></div>
<h3 id="combined-rules">Combined Rules</h3>

<p>The following rule blocks any TCP traffic with source port 123 and
destination port 123 going from any switch port egress or generated from
Switch 1 to host1 or host2 (corresponding to rules 1 and 4 in the
diagram above).</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables] -A OUTPUT,FORWARD -o swp+ -p tcp --sport 123 --dport 123 -j DROP</code></pre></div>
<p>This also becomes 2 ACLs, and is effectively the same as:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[iptables]
-A FORWARD -o swp+ -p tcp --sport 123 --dport 123 -j DROP 
-A OUTPUT -o swp+ -p tcp --sport 123 --dport 123 -j DROP</code></pre></div>
<h3 id="layer-2-only-rules-ebtables">Layer 2-only Rules/ebtables</h3>

<p>The following rule blocks any traffic with source MAC address
00:00:00:00:00:12 and destination MAC address 08:9e:01:ce:e2:04 going
from any switch port egress/ingress. </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">[ebtables] -A FORWARD -s 00:00:00:00:00:12 -d 08:9e:01:ce:e2:04 -j DROP</code></pre></div>
<h2 id="useful-links">Useful Links</h2>

<ul>
<li><a href="http://www.netfilter.org/">www.netfilter.org</a></li>
<li><a href="http://www.netfilter.org/documentation/HOWTO//packet-filtering-HOWTO-6.html">Netfilter.org packet filtering
how-to</a></li>
</ul>

<h2 id="caveats-and-errata">Caveats and Errata</h2>

<h3 id="not-all-rules-supported">Not All Rules Supported</h3>

<p>As mentioned in the <a href="#CopyofNetfilter-ACLs-supported">Supported Rules
section</a> above, not
all <code>iptables</code>, <code>ip6tables</code> or <code>ebtables</code> rules are supported. Refer to
that section for specific rule support.</p>

<h3 id="acl-log-policer-limits-traffic">ACL Log Policer Limits Traffic</h3>

<p>Traffic copied to the CPU is limited to 1 pkt/s by an ACL Log Policer,
to protect the CPU from overloading.</p>

<h3 id="bridge-traffic-limitations">Bridge Traffic Limitations</h3>

<p>Bridge traffic that matches LOG ACTION rules are not logged in syslog,
as the kernel and hardware identify packets using different information.</p>

<h3 id="log-actions-cannot-be-forwarded">Log Actions Cannot Be Forwarded</h3>

<p>Logged packets cannot be forwarded. The hardware cannot both forward a
packet and send the packet to the control plane (or kernel) for logging.
To emphasize this, a log action must also have a drop action.</p>

<h3 id="broadcom-hardware-limitations">Broadcom Hardware Limitations</h3>

<p>Broadcom platforms have only 24 range checkers. This is a separate
resource from the total number of ACLs allowed. If you are creating a
large ACL configuration, use port ranges for large ranges of more than 5
ports.</p>

<h3 id="tomahawk-hardware-limitations">Tomahawk Hardware Limitations</h3>

<h4 id="rate-limiting-per-pipeline-not-global">Rate Limiting per Pipeline, Not Global</h4>

<p>On Tomahawk switches, the field processor (FP) polices on a per-pipeline
basis instead of globally, as with a Trident II switch. If packets come
in to different switch ports that are on different pipelines on the
ASIC, they may be rate limited differently.</p>

<p>For example, your switch is set so BFD if rate limited to 2000 packets
per second. When the BFD packets are received on port1/pipe1 and
port2/pipe2, they would each be rate limited at 2000 pps, thus the
switch is rate limiting at 4000 pps overall. Since there are four
pipelines on a Tomahawk switch, you could see a 4 increase of your
configured rate limits.</p>

<h4 id="ping-pong-mode-enabled-by-default">Ping-pong Mode Enabled by Default</h4>

<p>In Cumulus Linux, the ping-pong atomic policy update mode is enabled by
default. If you have Tomahawk switches and plan to use SPAN and/or
mangle rules, you must disable ping-pong mode.</p>

<p>To do so, set the value for <code>acl.non_atomic_update_mode</code> to
true in <code>/etc/cumulus/switchd.conf</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">acl.non_atomic_update_mode = TRUE</code></pre></div>
<p>Then <a href="https://docs.cumulusnetworks.com/display/CL30/Configuring+switchd#Configuringswitchd-restartswitchd">restart
<code>switchd</code></a>
.</p>

<h4 id="packets-undercounted-during-acl-updates">Packets Undercounted during ACL Updates</h4>

<p>On Tomahawk switches, when updating egress FP rules, some packets do not
get counted. This results in an underreporting of counts during
ping-pong/incremental switchover.</p>

<h3 id="trident-ii-and-trident3-hardware-limitations">Trident II+ and Trident3 Hardware Limitations</h3>

<p>On a Trident II+ or Trident3 switch, the TCAM allocation for ACLs is
limited to 2048 rules in atomic mode for a default setup, instead of
4096 as advertised for ingress rules.</p>

<h3 id="iptables-interactions-with-cl-acltool">iptables Interactions with cl-acltool</h3>

<p>Since Cumulus Linux is a Linux operating system, the <code>iptables</code> commands
can be used directly and does work. However, you should consider
using <code>cl-acltool</code> instead because:</p>

<ul>
<li><p>Without using <code>cl-acltool</code>, rules are not installed into hardware.</p></li>

<li><p>Running <code>cl-acltool -i</code> (the installation command) resets all rules
and deletes anything that is not stored
in <code>/etc/cumulus/acl/policy.conf</code>.</p>

<p>For example, running the following command works:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo iptables -A INPUT -p icmp --icmp-type echo-request -j DROP</code></pre></div>
<p>And the rules appear when you run <code>cl-acltool -L</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo cl-acltool -L ip
-------------------------------
Listing rules of type iptables:
-------------------------------
TABLE filter :
Chain INPUT (policy ACCEPT 72 packets, 5236 bytes)
 pkts bytes target  prot opt in   out   source    destination

    0     0 DROP    icmp --  any  any   anywhere  anywhere      icmp echo-request</code></pre></div>
<p>However, running <code>cl-acltool -i</code> or <code>reboot</code> removes them. To ensure
all rules that can be in hardware are hardware accelerated, place
them in <code>/etc/cumulus/acl/policy.conf</code> and run <code>cl-acltool -i</code>.</p></li>
</ul>

<h3 id="where-to-assign-rules">Where to Assign Rules</h3>

<ul>
<li>If a switch port is assigned to a bond, any egress rules must be
assigned to the bond.</li>
<li>When using the OUTPUT chain, rules must be assigned to the source.
For example, if a rule is assigned to the switch port in the
direction of traffic but the source is a bridge (VLAN), the traffic
won’t be affected by the rule and must be applied to the bridge.</li>
<li>If all transit traffic needs to have a rule applied, use the FORWARD
chain, not the OUTPUT chain.</li>
</ul>

<h3 id="generic-error-message-displayed-after-acl-rule-installation-failure">Generic Error Message Displayed after ACL Rule Installation Failure</h3>

<p>After an ACL rule installation failure, a generic error message like the
following is displayed:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:$ sudo cl-acltool -i -p 00control_plane.rules
Using user provided rule file 00control_plane.rules
Reading rule file 00control_plane.rules ...
Processing rules in file 00control_plane.rules ...
error: hw sync failed (sync_acl hardware installation failed)
Installing acl policy... Rolling back ..
failed.</code></pre></div>
<h3 id="dell-s3048-on-supports-only-24k-mac-addresses">Dell S3048-ON Supports only 24K MAC Addresses</h3>

<p>The Dell S3048-ON has a limit of 24576 MAC address entries, instead of
32K for other 1G switches.</p>

<h2 id="attachments">Attachments:</h2>

<p><img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362583.png">Linux Traffic
Inspection Points (Chains).png</a>
(image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362585.png">Linux IPtables
Default Tables.png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362586.png">Linux EBtables
Default Tables.png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362587.png">Legend
(1).png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362588.png">Tables Chains
Rules.png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362584/8362589.png">Anatomy of a
Rule.png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;}
<a href="attachments/8362584/8362590.png">acl-diagram.png</a> (image/png)</p>
</article>

      
<div class="align-center book-git-footer justify-between">
  
  <div>
    <a href="https://github.com/cawleyflower/testDocs/commit/0f1fa77f244c4b4642688df1f5e961e88daa6e08" title='Last modified March 4, 2019 16:11 EST by Cawleyflower' target="_blank" rel="noopener">
      <img src="/svg/code-merge.svg" /> Last Modified Mar 4, 2019
    </a>
  </div>
  
  
</div>


    </div>

    
  
  
  <aside class="book-toc fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#copy-of-netfilter-acls">Copy of Netfilter - ACLs</a>
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#traffic-rules-in-cumulus-linux">Traffic Rules In Cumulus Linux</a>
<ul>
<li><a href="#chains">Chains</a></li>
<li><a href="#tables">Tables</a></li>
<li><a href="#rules">Rules</a></li>
<li><a href="#how-rules-are-parsed-and-applied">How Rules Are Parsed and Applied</a></li>
<li><a href="#rule-placement-in-memory">Rule Placement in Memory</a></li>
<li><a href="#enable-nonatomic-updates">Enable Nonatomic Updates</a></li>
<li><a href="#use-iptables-ip6tables-ebtables-directly">Use iptables/ip6tables/ebtables Directly</a></li>
<li><a href="#estimate-the-number-of-rules">Estimate the Number of Rules</a></li>
<li><a href="#match-svi-bridged-interfaces-in-rules">Match SVI/Bridged Interfaces in Rules</a></li>
</ul></li>
<li><a href="#install-and-manage-acl-rules-with-nclu">Install and Manage ACL Rules with NCLU</a></li>
<li><a href="#install-and-manage-acl-rules-with-cl-acltool">Install and Manage ACL Rules with cl-acltool</a></li>
<li><a href="#install-packet-filtering-acl-rules">Install Packet Filtering (ACL) Rules</a></li>
<li><a href="#specify-the-policy-files-to-install">Specify the Policy Files to Install</a></li>
<li><a href="#hardware-limitations-on-number-of-rules">Hardware Limitations on Number of Rules</a>
<ul>
<li><a href="#broadcom-tomahawk-limits">Broadcom Tomahawk Limits</a></li>
<li><a href="#broadcom-trident-ii-and-trident3-limits">Broadcom Trident II+ and Trident3 Limits</a></li>
<li><a href="#broadcom-trident-ii-limits">Broadcom Trident II Limits</a></li>
<li><a href="#broadcom-helix4-limits">Broadcom Helix4 Limits</a></li>
<li><a href="#mellanox-spectrum-limits">Mellanox Spectrum Limits</a></li>
</ul></li>
<li><a href="#supported-rule-types">Supported Rule Types</a>
<ul>
<li><a href="#iptables-ip6tables-rule-support">iptables/ip6tables Rule Support</a></li>
<li><a href="#ebtables-rule-support">ebtables Rule Support</a></li>
<li><a href="#other-unsupported-rules"><strong>Other Unsupported Rules</strong></a></li>
</ul></li>
<li><a href="#common-examples">Common Examples</a>
<ul>
<li><a href="#control-plane-and-data-plane-traffic">Control Plane and Data Plane Traffic</a></li>
<li><a href="#set-dscp-on-transit-traffic">Set DSCP on Transit Traffic</a></li>
<li><a href="#verify-dscp-values-on-transit-traffic">Verify DSCP Values on Transit Traffic</a></li>
<li><a href="#check-the-packet-and-byte-counters-for-acl-rules">Check the Packet and Byte Counters for ACL Rules</a></li>
<li><a href="#filter-specific-tcp-flags">Filter Specific TCP Flags</a></li>
</ul></li>
<li><a href="#example-scenario">Example Scenario</a>
<ul>
<li><a href="#switch-1-configuration">Switch 1 Configuration</a></li>
<li><a href="#switch-2-configuration">Switch 2 Configuration</a></li>
<li><a href="#egress-rule">Egress Rule</a></li>
<li><a href="#ingress-rule">Ingress Rule</a></li>
<li><a href="#input-rule">Input Rule</a></li>
<li><a href="#output-rule">Output Rule</a></li>
<li><a href="#combined-rules">Combined Rules</a></li>
<li><a href="#layer-2-only-rules-ebtables">Layer 2-only Rules/ebtables</a></li>
</ul></li>
<li><a href="#useful-links">Useful Links</a></li>
<li><a href="#caveats-and-errata">Caveats and Errata</a>
<ul>
<li><a href="#not-all-rules-supported">Not All Rules Supported</a></li>
<li><a href="#acl-log-policer-limits-traffic">ACL Log Policer Limits Traffic</a></li>
<li><a href="#bridge-traffic-limitations">Bridge Traffic Limitations</a></li>
<li><a href="#log-actions-cannot-be-forwarded">Log Actions Cannot Be Forwarded</a></li>
<li><a href="#broadcom-hardware-limitations">Broadcom Hardware Limitations</a></li>
<li><a href="#tomahawk-hardware-limitations">Tomahawk Hardware Limitations</a>
<ul>
<li><a href="#rate-limiting-per-pipeline-not-global">Rate Limiting per Pipeline, Not Global</a></li>
<li><a href="#ping-pong-mode-enabled-by-default">Ping-pong Mode Enabled by Default</a></li>
<li><a href="#packets-undercounted-during-acl-updates">Packets Undercounted during ACL Updates</a></li>
</ul></li>
<li><a href="#trident-ii-and-trident3-hardware-limitations">Trident II+ and Trident3 Hardware Limitations</a></li>
<li><a href="#iptables-interactions-with-cl-acltool">iptables Interactions with cl-acltool</a></li>
<li><a href="#where-to-assign-rules">Where to Assign Rules</a></li>
<li><a href="#generic-error-message-displayed-after-acl-rule-installation-failure">Generic Error Message Displayed after ACL Rule Installation Failure</a></li>
<li><a href="#dell-s3048-on-supports-only-24k-mac-addresses">Dell S3048-ON Supports only 24K MAC Addresses</a></li>
</ul></li>
<li><a href="#attachments">Attachments:</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
