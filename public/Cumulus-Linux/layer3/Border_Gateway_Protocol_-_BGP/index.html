<!DOCTYPE html><html>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Border Gateway Protocol B G P | Cumulus Networks Documentation</title>

<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono:300,400,700" rel="stylesheet">
<link rel="stylesheet" href="/normalize.min.css">

<link rel="stylesheet" href="/book.min.20b2cb98a9208e1e7497525a9f78f7f8eb0ca4b5f4551e9610f12c5b317e6be8.css">

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">
<h2 class="book-brand">
  <a href="http://example.org/">Cumulus Networks Documentation</a>
</h2>



    


  
  
    
  
 
  <ul>
    
    <li><a href="/Cumulus-Linux/installation-management/">
    Installation Management</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/installation-management/Adding_and_Updating_Packages/">Adding and Updating Packages</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Installing_a_New_Cumulus_Linux_Image/">Installing a New Cumulus Linux Image</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Managing_Cumulus_Linux_Disk_Images/">Managing Cumulus Linux Disk Images</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Upgrading_Cumulus_Linux/">Upgrading Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Using_Snapshots/">Using Snapshots</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Zero_Touch_Provisioning_-_ZTP/">Zero Touch Provisioning Z T P</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer1-switch-ports/">
    Layer1 Switch Ports</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/802.1X_Interfaces/">802.1 X Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Buffer_and_Queue_Management/">Buffer and Queue Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Relays/">D H C P Relays</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Servers/">D H C P Servers</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Facebook_Voyager_Optical_Interfaces/">Facebook Voyager Optical Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Prescriptive_Topology_Manager_-_PTM/">Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/Interface_Configuration_and_Management/">Interface Configuration and Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/switch_port_attributes/Switch_Port_Attributes/">Switch Port Attributes</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer2/">
    Layer2</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Prescriptive_Topology_Manager_-_PTM/">Copy of Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Spanning_Tree_and_Rapid_Spanning_Tree/">Copy of Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Ethernet_Bridging_-_VLANs/">Ethernet Bridging v L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/IGMP_and_MLD_Snooping/">I G M P and M L D Snooping</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/LACP_Bypass/">L a C P Bypass</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Link_Layer_Discovery_Protocol/">Link Layer Discovery Protocol</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Multi-Chassis_Link_Aggregation_-_MLAG/">Multi Chassis Link Aggregation M L a G</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Spanning_Tree_and_Rapid_Spanning_Tree/">Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Virtual_Router_Redundancy_-_VRR/">Virtual Router Redundancy v R R</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/bonding_link_aggregation/Bonding_-_Link_Aggregation/">Bonding Link Aggregation</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/Traditional_Bridge_Mode/">Traditional Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN-aware_Bridge_Mode/">V L a N Aware Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN_Tagging/">V L a N Tagging</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/link_layer_discovery_protocol/voice_vlan/Voice_VLAN/">Voice v L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/virtual_router_redundancy/ifplugd/ifplugd/">Ifplugd</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer3/">
    Layer3</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer3/Address_Resolution_Protocol_-_ARP/">Address Resolution Protocol a R P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Bidirectional_Forwarding_Detection_-_BFD/">Bidirectional Forwarding Detection B F D</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Border_Gateway_Protocol_-_BGP/" class="active">Border Gateway Protocol B G P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Configuring_FRRouting/">Configuring F R Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Equal_Cost_Multipath_Load_Sharing_-_Hardware_ECMP/">Equal Cost Multipath Load Sharing Hardware E C M P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/FRRouting_Overview/">F R Routing Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/GRE_Tunneling/">G R E Tunneling</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Introduction_to_Routing_Protocols/">Introduction to Routing Protocols</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Management_VRF/">Management v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Network_Topology/">Network Topology</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_-_OSPF/">Open Shortest Path First O S P F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_v3_-_OSPFv3/">Open Shortest Path First V3 O S P Fv3</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Policy-based_Routing/">Policy Based Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Protocol_Independent_Multicast_-_PIM/">Protocol Independent Multicast P I M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Redistribute_Neighbor/">Redistribute Neighbor</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Routing/">Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Segment_Routing/">Segment Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Virtual_Routing_and_Forwarding_-_VRF/">Virtual Routing and Forwarding v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/configuring_frrouting/comparing_nclu_and_vtysh_commands/Comparing_NCLU_and_vtysh_Commands/">Comparing N C L U and Vtysh Commands</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/frrouting_overview/Upgrading_from_Quagga_to_FRRouting/">Upgrading From Quagga to F R Routing</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/monitoring-troubleshooting/">
    Monitoring Troubleshooting</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/ASIC_Monitoring/">A S I C Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/FRRouting_Log_Message_Reference/">F R Routing Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Best_Practices/">Monitoring Best Practices</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_System_Hardware/">Monitoring System Hardware</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Virtual_Device_Counters/">Monitoring Virtual Device Counters</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Network_Troubleshooting/">Network Troubleshooting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Resource_Diagnostics_Using_cl-resource-query/">Resource Diagnostics Using Cl Resource Query</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Simple_Network_Management_Protocol_SNMP_Monitoring/">Simple Network Management Protocol S N M P Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Single_User_Mode_-_Boot_Recovery/">Single User Mode Boot Recovery</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Troubleshooting_Network_Interfaces/">Troubleshooting Network Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Understanding_the_cl-support_Output_File/">Understanding the Cl Support Output File</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/monitoring_system_hardware/network_switch_port_led_and_stats_led/Network_Switch_Port_LED_and_Status_LED_Guidelines/">Network Switch Port L E D and Status L E D Guidelines</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/monitoring_system_statistics/Monitoring_System_Statistics_and_Network_Traffic_with_sFlow/">Monitoring System Statistics and Network Traffic With S Flow</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/using_nclu_to_troubleshoot/Using_NCLU_to_Troubleshoot_Your_Network_Configuration/">Using N C L U to Troubleshoot Your Network Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/simple_network_management/using_nutanix_prisim_as_monitoring_tool/Using_Nutanix_Prism_as_a_Monitoring_Tool/">Using Nutanix Prism as a Monitoring Tool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/switchd_Log_Message_Reference/">Switchd Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/troubleshooting_network_interfaces/monitoring_interfaces_and_transcievers_using_ethtool/Monitoring_Interfaces_and_Transceivers_Using_ethtool/">Monitoring Interfaces and Transceivers Using Ethtool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_log_files/Troubleshooting_Log_Files/">Troubleshooting Log Files</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_the_etc_directory/Troubleshooting_the_etc_Directory/">Troubleshooting the Etc Directory</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-solutions/">
    Network Solutions</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Anycast_Design_Guide/">Anycast Design Guide</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Hyperconverged_Solution_with_Nutanix/">Cumulus Hyperconverged Solution With Nutanix</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Networks_Services_Demos/">Cumulus Networks Services Demos</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Data_Center_Host_to_ToR_Architecture/">Data Center Host to to R Architecture</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Docker_on_Cumulus_Linux/">Docker on Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/OpenStack_Neutron_ML2_and_Cumulus_Linux/">Open Stack Neutron M L2 and Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/RDMA_over_Converged_Ethernet_-_RoCE/">R D M a Over Converged Ethernet Ro C E</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-visualization/">
    Network Visualization</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Eng_Update_of_VXLAN_Hyperloop/">Eng Update of v X L a N Hyperloop</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Ethernet_Virtual_Private_Network_-_EVPN/">Ethernet Virtual Private Network E v P N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Hybrid_Cloud_Connectivity_with_QinQ_and_VXLANs/">Hybrid Cloud Connectivity With Qin Q and v X L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/LNV_Full_Example/">L N v Full Example</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Lightweight_Network_Virtualization_Overview/">Lightweight Network Virtualization Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Static_VXLAN_Configurations/">Static v X L a N Configurations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Routing/">V X L a N Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Scale/">V X L a N Scale</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Tunnel_DSCP_Operations__DRAFT/">V X L a N Tunnel D S C P Operations — D R a F T</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Virtualization_Integrations/">Virtualization Integrations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_mac_bindings/Static_MAC_Bindings_with_VXLAN/">Static M a C Bindings With v X L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_vxlan_tunnels/Static_VXLAN_Tunnels/">Static v X L a N Tunnels</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_hardware_vteps_vmware_nsx-mh/Integrating_Hardware_VTEPs_with_VMware_NSX-MH/">Integrating Hardware v T E Ps With v Mware N S X M H</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_midonet_openstack/Integrating_Hardware_VTEPs_with_Midokura_MidoNet_and_OpenStack/">Integrating Hardware v T E Ps With Midokura Mido Net and Open Stack</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_vmware_nsx-v/Integrating_Hardware_VTEPs_with_VMware_NSX-V/">Integrating Hardware v T E Ps With v Mware N S X V</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/ovsdb_server_high_availability/OVSDB_Server_High_Availability/">O v S D B Server High Availability</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/system-config/">
    System Config</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/system-config/Authentication_Authorization_and_Accounting/">Authentication Authorization and Accounting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_a_Global_Proxy/">Configuring a Global Proxy</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_switchd/">Configuring Switchd</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Copy_of_Netfilter_-_ACLs/">Copy of Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/HTTP_API/">H T T P a P I</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Netfilter_-_ACLs/">Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Network_Command_Line_Utility_-_NCLU/">Network Command Line Utility N C L U</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Power_over_Ethernet_-_PoE/">Power Over Ethernet Po E</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Services_and_Daemons_in_Cumulus_Linux/">Services and Daemons in Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Setting_Date_and_Time/">Setting Date and Time</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/LDAP_Authentication_and_Authorization/">L D a P Authentication and Authorization</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/RADIUS_AAA/">R a D I U S a a A</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/SSH_for_Remote_Access/">S S H for Remote Access</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/TACACS_Plus/">T a C a C S Plus</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/User_Accounts/">User Accounts</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/Using_sudo_to_Delegate_Privileges/">Using Sudo to Delegate Privileges</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Default_Cumulus_Linux_ACL_Configuration/">Default Cumulus Linux a C L Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Filtering_Learned_MAC_Addresses/">Filtering Learned M a C Addresses</a>
    </li>
    
  </ul>

    </li>
    

    
    <li>
      <a href="/Cumulus-Linux/whats-new/">What&#39;s New</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/cumulus-linux-index/Cumulus_Linux_Index/">Cumulus Linux Index</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/quick-start/Quick_Start_Guide/">Quick Start Guide</a>
    </li>
    
  </ul>
 
  <ul>
    
    <li><a href="/NetQ/Cumulus_NetQ_UI_User_Guide/">
    Cumulus Net Q U I User Guide</a> 
  <ul>
    
    <li><a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/">
    Monitor the Network</a> 
  <ul>
    

    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/Monitor_Alarm_Events/">Monitor Alarm Events</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/Monitor_Informational_Events/">Monitor Informational Events</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/Monitor_Network_Health/">Monitor Network Health</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/Monitor_Network_Inventory/">Monitor Network Inventory</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/Monitor_Network_Protocols_and_Services/">Monitor Network Protocols and Services</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/monitor_the_network/NetQ_User_Interface_Overview/">Net Q User Interface Overview</a>
    </li>
    
  </ul>

    </li>
    

    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/Monitor_Switches/">Monitor Switches</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/NetQ_User_Interface_Overview/">Net Q User Interface Overview</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/UI_Preface/">U I Preface</a>
    </li>
    
    <li>
      <a href="/NetQ/Cumulus_NetQ_UI_User_Guide/Validate_Network_Protocol_and_Service_Operations/">Validate Network Protocol and Service Operations</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/NetQ/cli_user_guide/">
    Cli User Guide</a> 
  <ul>
    

    
    <li>
      <a href="/NetQ/cli_user_guide/CLI_Preface/CLI_Preface/">C L I Preface</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/automate_common_tasks/Automate_Common_and_Repetitive_Tasks/">Automate Common and Repetitive Tasks</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/command_line_overview/NetQ_Command_Line_Overview/">Net Q Command Line Overview</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_containter_environments/Monitor_Container_Environments/">Monitor Container Environments</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_data_link_layer/Monitor_Data_Link_Layer_Devices_and_Protocols/">Monitor Data Link Layer Devices and Protocols</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_linux_hosts/Monitor_Linux_Hosts/">Monitor Linux Hosts</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_network_health/Monitor_Overall_Network_Health/">Monitor Overall Network Health</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_network_layer/Monitor_Network_Protocols_and_Services/">Monitor Network Protocols and Services</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_physical_layer/Monitor_Physical_Layer_Components/">Monitor Physical Layer Components</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_switch_hardware/Monitor_Switch_Hardware_and_Software/">Monitor Switch Hardware and Software</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/monitor_virtual_overlays/Monitor_Virtual_Network_Overlays/">Monitor Virtual Network Overlays</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/resolve_issues/Resolve_Issues/">Resolve Issues</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/resolve_issues/Resolve_MLAG_Issues/">Resolve M L a G Issues</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/resolve_issues/investiage_netq_issues/Investigate_NetQ_Issues/">Investigate Net Q Issues</a>
    </li>
    
    <li>
      <a href="/NetQ/cli_user_guide/resolve_issues/methods_for_diagnosing_issues/Methods_for_Diagnosing_Network_Issues/">Methods for Diagnosing Network Issues</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/NetQ/deployment_guide/">
    Deployment Guide</a> 
  <ul>
    

    
    <li>
      <a href="/NetQ/deployment_guide/config_optional_netq/Configuring_Optional_NetQ_Capabilities/">Configuring Optional Net Q Capabilities</a>
    </li>
    
    <li>
      <a href="/NetQ/deployment_guide/deployment_preface/Deployment_Preface/">Deployment Preface</a>
    </li>
    
    <li>
      <a href="/NetQ/deployment_guide/install_netq/Install_NetQ/">Install Net Q</a>
    </li>
    
    <li>
      <a href="/NetQ/deployment_guide/maintain_netq/Maintain_NetQ/">Maintain Net Q</a>
    </li>
    
    <li>
      <a href="/NetQ/deployment_guide/netq_primer/Cumulus_NetQ_Primer/">Cumulus Net Q Primer</a>
    </li>
    
  </ul>

    </li>
    

    
    <li>
      <a href="/NetQ/Release_Notes/Cumulus_NetQ_2.0_Release_Notes/">Cumulus Net Q 2.0 Release Notes</a>
    </li>
    
    <li>
      <a href="/NetQ/getting_started/Getting_Started_with_the_Cumulus_NetQ_Appliance/">Getting Started With the Cumulus Net Q Appliance</a>
    </li>
    
    <li>
      <a href="/NetQ/software_installation_guide/Cumulus_NetQ_Appliance_Software_Installation_Guide/">Cumulus Net Q Appliance Software Installation Guide</a>
    </li>
    
  </ul>








</nav>

    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/svg/menu.svg" />
  </label>
  <strong>Border Gateway Protocol B G P</strong>
</header>

      
<article class="markdown">

<h1 id="border-gateway-protocol-bgp">Border Gateway Protocol - BGP</h1>

<p>BGP is the routing protocol that runs the Internet. It is an
increasingly popular protocol for use in the data center as it lends
itself well to the rich interconnections in a Clos topology.
Specifically, BGP:</p>

<ul>
<li>Does not require the routing state to be periodically refreshed,
unlike OSPF.</li>
<li>Is less chatty than its link-state siblings. For example, a link or
node transition can result in a bestpath change, causing BGP to send
updates.</li>
<li>Is multi-protocol and extensible.</li>
<li>Has many robust vendor implementations.</li>
<li>Is very mature as a protocol and comes with many years of
operational experience.</li>
</ul>

<p><a href="https://tools.ietf.org/html/rfc7938">RFC 7938</a> provides further details
of the use of BGP within the data center.</p>

<h2 id="contents">Contents</h2>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}This topic
describes &hellip;</p>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-AutonomousSystemNumber(ASN)">Autonomous System Number
(ASN)</a></li>
<li><a href="#BorderGatewayProtocol-BGP-eBGPandiBGP">eBGP and iBGP</a></li>
<li><a href="#BorderGatewayProtocol-BGP-RouteReflectors">Route Reflectors</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ECMPecmpwithBGP">ECMP with BGP</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-MaximumPaths">Maximum Paths</a></li>
<li><a href="#BorderGatewayProtocol-BGP-BGPforBothIPv4andIPv6">BGP for Both IPv4 and
IPv6</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-config_bgpConfigureBGP">Configure BGP</a></li>
<li><a href="#BorderGatewayProtocol-BGP-unnumberedBGPUnnumberedInterfaces">BGP Unnumbered
Interfaces</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-BGPandExtendedNextHopEncoding">BGP and Extended Next Hop
Encoding</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureBGPUnnumberedInterfaces">Configure BGP Unnumbered
Interfaces</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ManageUnnumberedInterfaces">Manage Unnumbered
Interfaces</a></li>
<li><a href="#BorderGatewayProtocol-BGP-HowtracerouteInteractswithBGPUnnumberedInterfaces">How traceroute Interacts with BGP Unnumbered
Interfaces</a></li>
<li><a href="#BorderGatewayProtocol-BGP-Advanced:HowNextHopFieldsAreSet">Advanced: How Next Hop Fields Are
Set</a></li>
<li><a href="#BorderGatewayProtocol-BGP-Limitations">Limitations</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-rfc-5549RFC5549SupportwithGlobalIPv6Peers(CumulusLinux3.7.2andlater)">RFC 5549 Support with Global IPv6 Peers (Cumulus Linux 3.7.2 and
later)</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureRFC5549SupportwithGlobalIPv6Peers">Configure RFC 5549 Support with Global IPv6
Peers  </a></li>
<li><a href="#BorderGatewayProtocol-BGP-ShowIPv4PrefixesLearnedwithIPv6NextHops">Show IPv4 Prefixes Learned with IPv6 Next
Hops</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-add-pathBGPadd-path">BGP add-path</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-BGPadd-pathRX">BGP add-path RX</a></li>
<li><a href="#BorderGatewayProtocol-BGP-BGPadd-pathTX">BGP add-path TX</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-FastConvergenceDesignConsiderations">Fast Convergence Design
Considerations</a></li>
<li><a href="#BorderGatewayProtocol-BGP-peergroupsPeerGroupstoSimplifyConfiguration">Peer Groups to Simplify
Configuration</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureBGPDynamicNeighbors">Configure BGP Dynamic
Neighbors</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureBGPPeeringRelationshipsacrossSwitches">Configure BGP Peering Relationships across
Switches</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureMD5-enabledBGPNeighbors">Configure MD5-enabled BGP
Neighbors</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureeBGPMultihop">Configure eBGP
Multihop</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureBGPTTLSecurity">Configure BGP TTL
Security</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureGracefulBGPShutdown">Configure Graceful BGP
Shutdown</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigurationTips">Configuration Tips</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-BGPAdvertisementBestPractices">BGP Advertisement Best
Practices</a></li>
<li><a href="#BorderGatewayProtocol-BGP-MultipleRoutingTablesandForwarding">Multiple Routing Tables and
Forwarding</a></li>
<li><a href="#BorderGatewayProtocol-BGP-BGPCommunityLists">BGP Community
Lists</a></li>
<li><a href="#BorderGatewayProtocol-BGP-AdditionalDefaultSettings">Additional Default
Settings</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConfigureBGPNeighbormaximum-prefixes">Configure BGP Neighbor
maximum-prefixes</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-Troubleshooting">Troubleshooting</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-LogNeighborStateChanges">Log Neighbor State
Changes</a></li>
<li><a href="#BorderGatewayProtocol-BGP-TroubleshootLink-localAddresses">Troubleshoot Link-local
Addresses</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-EnableRead-onlyMode">Enable Read-only
Mode</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ApplyaRouteMapforRouteUpdates">Apply a Route Map for Route
Updates</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-FilterRoutesfromBGPintoZebra">Filter Routes from BGP into
Zebra</a></li>
<li><a href="#BorderGatewayProtocol-BGP-FilterRoutesfromZebraintotheLinuxKernel">Filter Routes from Zebra into the Linux
Kernel</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-ProtocolTuning">Protocol Tuning</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-ConvergeQuicklyOnLinkFailures">Converge Quickly On Link
Failures</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ConvergeQuicklyOnSoftFailures">Converge Quickly On Soft
Failures</a></li>
<li><a href="#BorderGatewayProtocol-BGP-ReconnectQuickly">Reconnect Quickly</a></li>
<li><a href="#BorderGatewayProtocol-BGP-AdvertisementInterval">Advertisement
Interval</a></li>
</ul></li>
<li><a href="#BorderGatewayProtocol-BGP-CaveatsandErrata">Caveats and Errata</a>

<ul>
<li><a href="#BorderGatewayProtocol-BGP-ttl-securityIssue">ttl-security
Issue</a></li>
<li><a href="#BorderGatewayProtocol-BGP-BGPDynamicCapabilitiesnotSupported">BGP Dynamic Capabilities not
Supported</a></li>
<li><a href="#BorderGatewayProtocol-BGP-RelatedInformation">Related
Information</a></li>
</ul></li>
</ul>

<h2 id="autonomous-system-number-asn">Autonomous System Number (ASN)</h2>

<p>One of the key concepts in BGP is an *autonomous system number* or ASN.
An <a href="https://en.wikipedia.org/wiki/Autonomous_System_%28Internet%29">autonomous
system</a> is
defined as a set of routers under a common administration. Because BGP
was originally designed to peer between independently managed
enterprises and/or service providers, each such enterprise is treated as
an autonomous system, responsible for a set of network addresses. Each
such autonomous system is given a unique number called its ASN. ASNs are
handed out by a central authority (ICANN). However, ASNs between 64512
and 65535 are reserved for private use. Using BGP within the data center
relies on either using this number space or using the single ASN you
own.</p>

<p>The ASN is central to how BGP builds a forwarding topology. A BGP route
advertisement carries with it not only the originator’s ASN, but also
the list of ASNs that this route advertisement has passed through. When
forwarding a route advertisement, a BGP speaker adds itself to this
list. This list of ASNs is called the <em>AS path</em>. BGP uses the AS path to
detect and avoid loops.</p>

<p>ASNs were originally 16-bit numbers, but were later modified to be
32-bit. FRRouting supports both 16-bit and 32-bit ASNs, but most
implementations still run with 16-bit ASNs.</p>

<h2 id="ebgp-and-ibgp">eBGP and iBGP</h2>

<p>When BGP is used to peer between autonomous systems, the peering is
referred to as  *external BGP* or eBGP. When BGP is used within an
autonomous system, the peering used is referred to as  *internal BGP* or
iBGP. eBGP peers have different ASNs while iBGP peers have the same ASN.</p>

<p>The heart of the protocol is the same when used as eBGP or iBGP,
however, there is a key difference in the protocol behavior between use
as eBGP and iBGP: an iBGP speaker does not forward routing information
learned from one iBGP peer to another iBGP peer to prevent loops.  eBGP
prevents loops using the AS_Path attribute.</p>

<p>All iBGP speakers need to be peered with each other in a full mesh. In a
large network, this requirement can quickly become unscalable. The most
popular method to scale iBGP networks is to introduce a <em>route
reflector</em>.</p>

<h2 id="route-reflectors">Route Reflectors</h2>

<p>In a two-tier Clos network, the leaf (or tier 1) switches are the only
ones connected to end stations. The spines themselves do not have any
routes to announce; they are merely <strong>reflecting</strong> the routes announced
by one leaf to the other leaves. Therefore, the spine switches function
as route reflectors while the leaf switches serve as route reflector
clients.</p>

<p>In a three-tier network, the tier 2 nodes (or mid-tier spines) act as
both route reflector servers and route reflector clients. They act as
route reflectors because they announce the routes learned from the tier
1 nodes to other tier 1 nodes and to tier 3 nodes. They also act as
route reflector clients to the tier 3 nodes, receiving routes learned
from other tier 2 nodes. Tier 3 nodes act only as route reflectors.</p>

<p>In the following illustration, tier 2 node 2.1 is acting as a route
reflector server, announcing the routes between tier 1 nodes 1.1 and 1.2
to tier 1 node 1.3. It is also a route reflector client, learning the
routes between tier 2 nodes 2.2 and 2.3 from the tier 3 node, 3.1.</p>

<p><img src="attachments/8362926/8362927.png" alt="" />{width=&ldquo;300&rdquo;}</p>

<p>Configuring route-reflector-client Requires Specific Order</p>

<p>When configuring a router to be a route reflector client, you must
specify the FRRouting configuration in a specific order; otherwise, the
router will not be a route reflector client.</p>

<p>You must run
the <code>net add bgp neighbor &lt;IPv4/IPV6&gt; route-reflector-client</code> command
after the <code>net add bgp neighbor &lt;IPV4/IPV6&gt; activate</code> command;
otherwise, the <code>route-reflector-client</code> command is ignored. For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">cumulus@switch:~$ net add bgp ipv4 unicast neighbor 14.0.0.9 activate 
cumulus@switch:~$ net add bgp neighbor 14.0.0.9 next-hop-self
cumulus@switch:~$ net add bgp neighbor 14.0.0.9 route-reflector-client &gt;&gt;&gt; Must be after activate 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 remote-as 65000
cumulus@switch:~$ net add bgp ipv6 unicast redistribute connected
cumulus@switch:~$ net add bgp maximum-paths ibgp 4 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 activate 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 next-hop-self 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 route-reflector-client &gt;&gt;&gt; Must be after activate </code></pre></div>
<p>A <strong>cluster consists of route reflectors (RRs) and their clients</strong> and
is used in iBGP environments where multiple sets of route reflectors and
their clients are configured. Configuring a unique ID per cluster (on
the route reflector server and clients) prevents looping as a route
reflector does not accept routes from another that has the same cluster
ID. Additionally, because all route reflectors in the cluster recognize
updates from peers in the same cluster, they do not install routes from
a route reflector in the same cluster; this reduces the number of
updates that need to be stored in BGP routing tables.</p>

<p>To configure a cluster ID on a route reflector, run
the <code>net add bgp cluster-id (&lt;ipv4&gt;|&lt;1-4294967295&gt;)</code> command. You can
enter the cluster ID as an IP address or as a 32-bit quantity.</p>

<p>The following example configures a cluster ID on a route reflector in IP
address format:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp cluster-id 14.0.0.9
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>The following example configures a cluster ID on a route reflector as a
32-bit quantity:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp cluster-id 321
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<h2 id="ecmpwith-bgp">ECMPwith BGP</h2>

<p>If a BGP node hears a prefix <strong>p</strong> from multiple peers, it has all the
information necessary to program the routing table to forward traffic
for that prefix <strong>p</strong> through all of these peers; BGP supports
equal-cost multipathing (ECMP).</p>

<p>To perform ECMP in BGP, you may need to
configure <code>net add bgp bestpath as-path multipath-relax</code> (if you are
using eBGP).</p>

<h3 id="maximum-paths">Maximum Paths</h3>

<p>In Cumulus Linux, the BGP <code>maximum-paths</code> setting is enabled by default,
so multiple routes are already installed. The default setting is 64
paths. </p>

<h3 id="bgp-for-both-ipv4-and-ipv6">BGP for Both IPv4 and IPv6</h3>

<p>Unlike OSPF, which has separate versions of the protocol to
announce IPv4 and IPv6 routes, BGP is a multi-protocol routing engine,
capable of announcing both IPv4 and IPv6 prefixes. It supports
announcing IPv4 prefixes over an IPv4 session and IPv6 prefixes over an
IPv6 session. It also supports announcing prefixes of both these address
families over a single IPv4 session or over a single IPv6 session.</p>

<h2 id="configure-bgp">Configure BGP</h2>

<p>The following example shows a basic BGP configuration. The rest of this
chapter discusses how to configure other BGP features, such as
unnumbered interfaces to route maps.</p>

<ol>
<li><p>Enable the BGP and Zebra daemons (<code>zebra</code> and <code>bgpd</code>), then enable
the FRRouting service and start it, as described in <a href="Configuring_FRRouting">Configuring
FRRouting</a>.</p></li>

<li><p>Identify the BGP node by assigning an ASN and <code>router-id</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 65000
cumulus@switch:~$ net add bgp router-id 10.0.0.1</code></pre></div></li>

<li><p>Specify where to disseminate routing information:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 10.0.0.2 remote-as external</code></pre></div>
<p>For an iBGP session, the <code>remote-as</code> is the same as the local AS:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 10.0.0.2 remote-as internal</code></pre></div>
<p>Specifying the IP address of the peer allows BGP to set up a TCP
socket with this peer, but it does not distribute any prefixes to
it, unless it is explicitly told that it must with
the <code>activate</code> command. You must specify the <code>activate</code> command for
each address family that is being announced by the BGP session.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp ipv4 unicast neighbor 10.0.0.2 activate
cumulus@switch:~$ net add bgp ipv6 unicast neighbor 2001:db8:0002::0a00:0002 activate</code></pre></div></li>

<li><p>Specify BGP session properties:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 10.0.0.2 next-hop-self</code></pre></div>
<p>If this is a route reflector client, it can be specified as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switchRR:~$ net add bgp neighbor 10.0.0.1 route-reflector-client</code></pre></div>
<p>It is node <em>switchRR</em>, the route reflector, on which the peer is
specified as a client.</p></li>

<li><p>Specify which prefixes to originate:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp ipv4 unicast network 192.0.2.0/24
cumulus@switch:~$ net add bgp ipv4 unicast network 203.0.113.1/24
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div></li>
</ol>

<h2 id="bgp-unnumbered-interfaces">BGP Unnumbered Interfaces</h2>

<p>Unnumbered interfaces are interfaces without unique IP addresses. In
BGP, you configure unnumbered interfaces using *extended next hop
encoding* (ENHE), which is defined by <a href="https://tools.ietf.org/html/rfc5549">RFC
5549</a>. BGP unnumbered interfaces
provide a means of advertising an IPv4 route with an IPv6 next hop.
Prior to RFC 5549, an IPv4 route could be advertised only with an IPv4
next hop.</p>

<p>BGP unnumbered interfaces are particularly useful in deployments where
IPv4 prefixes are advertised through BGP over a section without any IPv4
address configuration on links. As a result, the routing entries are
also IPv4 for destination lookup and have IPv6 next hops for forwarding
purposes.</p>

<h3 id="bgp-and-extended-next-hop-encoding">BGP and Extended Next Hop Encoding</h3>

<p>When enabled and active, BGP makes use of the available IPv6 next hops
for advertising any IPv4 prefixes. BGP learns the prefixes, calculates
the routes and installs them in IPv4 AFI to IPv6 AFI format. However,
ENHE in Cumulus Linux does not install routes into the kernel in IPv4
prefix to IPv6 next hop format. For link-local peerings enabled by
dynamically learning the other end&rsquo;s link-local address using IPv6
neighbor discovery router advertisements, an IPv6 next hop is converted
into an IPv4 link-local address and a static neighbor entry is installed
for this IPv4 link-local address with the MAC address derived from the
link-local address of the other end.</p>

<p>It is assumed that the IPv6 implementation on the peering device uses
the MAC address as the interface ID when assigning the IPv6 link-local
address, as suggested by RFC 4291.</p>

<p>Cumulus Linux 3.7.2 and later also supports advertising IPv4 prefixes
with IPv6 next hop addresses while peering over IPv6 global unicast
addresses. See <a href="#BorderGatewayProtocol-BGP-rfc-5549">RFC 5549 Support with Global IPv6
Peers</a> below.</p>

<h3 id="configure-bgp-unnumbered-interfaces">Configure BGP Unnumbered Interfaces</h3>

<p>To configure a BGP unnumbered interface, you must enable IPv6 neighbor
discovery router advertisements. The <code>interval</code> you specify is measured
in seconds and defaults to 10 seconds.</p>

<p>In Cumulus Linux 3.7.1 and earlier, extended next hop encoding is sent
only for the link-local address peerings (as shown below). In Cumulus
Linux 3.7.2 and later, extended next hop encoding can be sent for the
both link-local and global unicast address peerings (see <a href="#BorderGatewayProtocol-BGP-rfc-5549">RFC 5549
Support with Global IPv6 Peers</a>).</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 65020
cumulus@switch:~$ net add bgp router-id 10.0.0.21
cumulus@switch:~$ net add bgp bestpath as-path multipath-relax
cumulus@switch:~$ net add bgp bestpath compare-routerid
cumulus@switch:~$ net add bgp neighbor fabric peer-group
cumulus@switch:~$ net add bgp neighbor fabric remote-as external
cumulus@switch:~$ net add bgp neighbor fabric description Internal Fabric Network
cumulus@switch:~$ net add bgp neighbor fabric capability extended-nexthop
cumulus@switch:~$ net add bgp neighbor swp1 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp2 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp3 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp4 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp29 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp30 interface peer-group fabric</code></pre></div>
<p>These commands create the following configuration in
the <code>/etc/frr/frr.conf</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 65020
 bgp router-id 10.0.0.21
 bgp bestpath as-path multipath-relax
 bgp bestpath compare-routerid
 neighbor fabric peer-group
 neighbor fabric remote-as external
 neighbor fabric description Internal Fabric Network
 neighbor fabric capability extended-nexthop
 neighbor swp1 interface peer-group fabric
 neighbor swp2 interface peer-group fabric
 neighbor swp3 interface peer-group fabric
 neighbor swp4 interface peer-group fabric
 neighbor swp29 interface peer-group fabric
 neighbor swp30 interface peer-group fabric
!</code></pre></div>
<p>For an unnumbered configuration, you can use a single command to
configure a neighbor and attach it to a <a href="#BorderGatewayProtocol-BGP-peergroups">peer
group</a> (making sure to substitute
for the interface and peer group below):</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor &lt;swpX&gt; interface peer-group &lt;group name&gt;</code></pre></div>
<h3 id="manage-unnumbered-interfaces">Manage Unnumbered Interfaces</h3>

<p>All the relevant BGP commands show IPv6 next hops and/or the interface
name for any IPv4 prefix:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp

show bgp ipv4 unicast
=====================
BGP table version is 6, local router ID is 10.0.0.11
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath,
              i internal, r RIB-failure, S Stale, R Removed
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.11/32     0.0.0.0                  0         32768 ?
*&gt; 10.0.0.12/32     swp51                         0 65020 65012 ?
*=                  swp52                         0 65020 65012 ?
*&gt; 10.0.0.21/32     swp51           0             0 65020 ?
*&gt; 10.0.0.22/32     swp52           0             0 65020 ?
*&gt; 172.16.1.0/24    0.0.0.0                  0         32768 i
*&gt; 172.16.2.0/24    swp51                         0 65020 65012 i
*=                  swp52                         0 65020 65012 i
Total number of prefixes 6

show bgp ipv6 unicast
=====================
No BGP network exists</code></pre></div>
<p>FRRouting RIB commands are also modified:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show route
RIB entry for route
===================
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, P - PIM, T - Table,
       &gt; - selected route, * - FIB route
K&gt;* 0.0.0.0/0 via 192.168.0.254, eth0
C&gt;* 10.0.0.11/32 is directly connected, lo
B&gt;* 10.0.0.12/32 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
  *                     via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
B&gt;* 10.0.0.21/32 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
B&gt;* 10.0.0.22/32 [20/0] via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
C&gt;* 172.16.1.0/24 is directly connected, br0
B&gt;* 172.16.2.0/24 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
  *                      via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
C&gt;* 192.168.0.0/24 is directly connected, eth0</code></pre></div>
<p>The following commands show how the IPv4 link-local
address *169.254.0.1* is used to install the route and static neighbor
entry to facilitate proper forwarding without having to install an IPv4
prefix with IPv6 next hop in the kernel:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show route 10.0.0.12
RIB entry for 10.0.0.12
=======================
Routing entry for 10.0.0.12/32
  Known via &#34;bgp&#34;, distance 20, metric 0, best
  Last update 1d01h06m ago
  * fe80::4638:39ff:fe00:5c, via swp51
  * fe80::4638:39ff:fe00:2b, via swp52

FIB entry for 10.0.0.12
=======================
10.0.0.12  proto zebra  metric 20 
    nexthop via 169.254.0.1  dev swp51 weight 1 onlink
    nexthop via 169.254.0.1  dev swp52 weight 1 onlink</code></pre></div>
<p>You can use the following command to display more neighbor information:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ ip neighbor
192.168.0.254 dev eth0 lladdr 44:38:39:00:00:5f REACHABLE
169.254.0.1 dev swp52 lladdr 44:38:39:00:00:2b PERMANENT
169.254.0.1 dev swp51 lladdr 44:38:39:00:00:5c PERMANENT
fe80::4638:39ff:fe00:2b dev swp52 lladdr 44:38:39:00:00:2b router REACHABLE
fe80::4638:39ff:fe00:5c dev swp51 lladdr 44:38:39:00:00:5c router REACHABLE</code></pre></div>
<h3 id="how-traceroute-interacts-with-bgp-unnumbered-interfaces">How traceroute Interacts with BGP Unnumbered Interfaces</h3>

<p>Every router or end host must have an IPv4 address to complete
a <code>traceroute</code> of IPv4 addresses. In this case, the IPv4 address used is
that of the loopback device.</p>

<p>Even if ENHE is not used in the data center, link addresses are not
typically advertised. This is because:</p>

<ul>
<li>Link addresses take up valuable FIB resources. In a large Clos
environment, the number of such addresses can be quite large.</li>
<li>Link addresses expose an additional attack vector for intruders to
use to either break in or engage in DDOS attacks.</li>
</ul>

<p>Assigning an IP address to the loopback device is essential.</p>

<h3 id="advanced-how-next-hop-fields-are-set">Advanced: How Next Hop Fields Are Set</h3>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}Click here
to expand&hellip;</p>

<p>This section describes how the IPv6 next hops are set in the
MP_REACH_NLRI (<a href="https://www.ietf.org/rfc/rfc2858.txt">multiprotocol reachable
NLRI</a>) initiated by the system,
which applies whether IPv6 prefixes or IPv4 prefixes are exchanged with
ENHE. There are two main aspects to determine — how many IPv6 next hops
are included in the MP_REACH_NLRI (since the RFC allows either one or
two next hops) and the values of the nexthop(s). This section also
describes how a received MP_REACH_NLRI is handled as far as processing
IPv6 next hops.</p>

<ul>
<li>Whether peering to a global IPv6 address or link-local IPv6 address,
the determination whether to send one or two next hops is as
follows:

<ol>
<li>If reflecting the route, two next hops are sent only if the peer
has <code>nexthop-local unchanged</code> configured and the attribute of
the received route has an IPv6 link-local next hop; otherwise,
only one next hop is sent.</li>
<li>Otherwise (if it is not reflecting the route), two next hops are
sent if explicitly configured (<code>nexthop-local unchanged</code>) or the
peer is directly connected (that is, either peering is on
link-local address or the global IPv4 or IPv6 address
is <em>directly connected</em>) and the route is either a
local/self-originated route or the peer is an eBGP peer.</li>
<li>In all other cases, only one next hop gets sent, unless an
outbound route map adds another next hop.</li>
</ol></li>
<li><code>route-map</code> can impose two next hops in scenarios where Cumulus
Linux only sends one next hop — by
specifying <code>set ipv6 nexthop link-local</code>.</li>
<li>For all routes to eBGP peers and self-originated routes to iBGP
peers, the global next hop (first value) is the peering address of
the local system. If the peering is on the link-local address, this
is the global IPv6 address on the peering interface, if
present; otherwise, it is the link-local IPv6 address on the peering
interface.</li>

<li><p>For other routes to iBGP peers (eBGP to iBGP or reflected), the
global next hop will be the global next hop in the received
attribute.</p>

<p>If this address is a link-local IPv6 address, it is reset so that
the link-local IPv6 address of the eBGP peer is not passed along to
an iBGP peer, which most likely is on a different link.</p></li>

<li><p><code>route-map</code> and/or the peer configuration can change the above
behavior. For example, <code>route-map</code> can set the global IPv6 next hop
or the peer configuration can set it to *self* — which is relevant
for *iBGP* peers. The route map or peer configuration can also set
the next hop to unchanged, which ensures the source IPv6 global next
hop is passed around — which is relevant for *eBGP* peers.</p></li>

<li><p>Whenever two next hops are being sent, the link-local next hop (the
second value of the two) is the link-local IPv6 address on the
peering interface unless it is due
to <code>nh-local-unchanged</code> or <code>route-map</code> has set the link-local next
hop.</p></li>

<li><p>Network administrators cannot set <a href="http://en.wikipedia.org/wiki/Martian_packet">martian
values</a> for IPv6 next
hops in <code>route-map</code>. Also, global and link-local next hops are
validated to ensure they match the respective address types.</p></li>

<li><p>In a received update, a martian check is imposed for the IPv6 global
next hop. If the check fails, it gets treated as an implicit
withdraw.</p></li>

<li><p>If two next hops are received in an update and the second next hop
is not a link-local address, it gets ignored and the update is
treated as if only one next hop was received.</p></li>

<li><p>Whenever two next hops are received in an update, the second next
hop is used to install the route into <code>zebra</code>. As per the previous
point, it is already assured that this is a link-local IPv6
address. Currently, this is assumed to be reachable and is not
registered with NHT.</p></li>

<li><p>When <code>route-map</code> specifies the next hop as <code>peer-address</code>, the
global IPv6 next hop as well as the link-local IPv6 next hop (if
it&rsquo;s being sent) is set to the <em>peering address</em>. If the peering is
on a link-local address, the former could be the link-local address
on the peering interface, unless there is a global IPv6 address
present on this interface.</p></li>

<li><p>When using iBGP unnumbered with IPv6 Link Local Addresses (the
default), FRR rewrites the BGP next hop to be the adjacent link.
This is similar behavior to eBGP next hops. However, iBGP route
advertisement rules do not change and a full mesh or route
reflectors is still required.</p></li>
</ul>

<p>The above rules imply that there are scenarios where a generated update
has two IPv6 next hops, and both of them are the IPv6 link-local address
of the peering interface on the local system. If you are peering with a
switch or router that is not running Cumulus Linux and expects the first
next hop to be a global IPv6 address, a route map can be used on the
sender to specify a global IPv6 address. This conforms with the
recommendations in the Internet
draft <a href="https://tools.ietf.org/html/draft-kato-bgp-ipv6-link-local-00">draft-kato-bgp-ipv6-link-local-00.txt</a>, &rdquo;BGP4+
Peering Using IPv6 Link-local Address&rdquo;.</p>

<p> </p>

<hr />

<h3 id="limitations">Limitations</h3>

<ul>
<li>Interface-based peering with separate IPv4 and IPv6 sessions is not
supported.</li>
<li>In Cumulus Linux 3.7.1 and earlier, ENHE is sent for IPv6 link-local
peerings only. In Cumulus Linux 3.7.2 and later, ENHE can also be
also sent for IPv6 GUA peerings (see below).</li>
<li>If an IPv4 /30 or /31 IP address is assigned to the interface, IPv4
peering is used over IPv6 link-local peering.</li>

<li><p>If the default router lifetime in the generated IPv6 route
advertisements (RA) is set to <em>0</em>, the receiving FRRouting instance
drops the RA if it is on a Cumulus Linux <strong>2.5.z</strong> switch. To work
around this issue, either:</p>

<ul>
<li>Explicitly configure the switch to advertise a router lifetime
of 0, unless a value is specifically set by the operator — with
the assumption that the host is running Cumulus Linux 3.y.z
version of FRRouting. When hosts see an IPv6 RA with a router
lifetime of 0, they do not make that router a default router.</li>
<li>Use the <code>sysctl</code> on the host
— <code>net.ipv6.conf.all.accept_ra_defrtr</code>. However, this requires
applying this setting on all hosts, which might mean many hosts,
especially if FRRouting is run on the hosts.</li>
</ul></li>
</ul>

<h2 id="rfc-5549-support-with-global-ipv6-peers-cumulus-linux-3-7-2-and-later">RFC 5549 Support with Global IPv6 Peers (Cumulus Linux 3.7.2 and later)</h2>

<p><a href="https://tools.ietf.org/html/rfc5549">RFC 5549</a> defines the method used
for BGP to advertise IPv4 prefixes with IPv6 next hops. The RFC does not
make a distinction between whether the IPv6 peering and next hop values
should be global unicast addresses (GUA) or link-local addresses.
Cumulus Linux 3.7.1 and earlier only supports advertising IPv4 prefixes
using link-local IPv6 next hop addresses via BGP *unnumbered* peering.
Cumulus Linux 3.7.2 supports advertising IPv4 prefixes with IPv6 global
unicast and link-local next hop addresses, with either <em>unnumbered</em>
or *numbered* BGP.</p>

<p>When BGP peering uses IPv6 global addresses and IPv4 prefixes are being
advertised and installed, IPv6 route advertisements are used to derive
the MAC address of the peer so that FRR can create an IPv4 route with a
link-local IPv4 next hop address (defined by RFC 3927). This is required
to install the route into the kernel. These route advertisement settings
are configured automatically when FRR receives an update from a BGP peer
using IPv6 global addresses that contain an IPv4 prefix with an IPv6
nexthop, and the enhanced-nexthop capability has been negotiated.</p>

<h3 id="configure-rfc-5549-support-with-global-ipv6-peers">Configure RFC 5549 Support with Global IPv6 Peers  </h3>

<p>To enable advertisement of IPv4 prefixes with IPv6 next hops over global
IPv6 peerings, add the <code>extended-nexthop</code> capability to the global IPv6
neighbor statements on each end of the BGP sessions.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 2001:1:1::3 capability extended-nexthop 
cumulus@switch:~$ net pending 
cumulus@switch:~$ net commit</code></pre></div>
<p>The above commands create the following configuration in
the <code>/etc/frr/frr.conf</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 1 
 bgp router-id 10.0.0.11 
 neighbor 2001:1:1::3 remote-as external 
 neighbor 2001:1:1::3 capability extended-nexthop 
 !</code></pre></div>
<p>Ensure that the IPv6 peers are activated under the IPv4 unicast address
family; otherwise, all peers are activated in the IPv4 unicast address
family by default. <br />
If <code>no bgp default ipv4-unicast</code> is configured, you need to explicitly
activate the IPv6 neighbor under the IPv4 unicast address family as
shown below:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 2001:1:1::3 capability extended-nexthop 
cumulus@switch:~$ net add bgp ipv4 unicast neighbor 2001:1:1::3 activate 
cumulus@switch:~$ net pending 
cumulus@switch:~$ net commit</code></pre></div>
<p>The above commands create the following configuration in
the <code>/etc/frr/frr.conf</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 1 bgp 
router-id 10.0.0.11 
no bgp default ipv4-unicast 
neighbor 2001:1:1::3 remote-as external 
neighbor 2001:1:1::3 capability extended-nexthop 
! 
address-family ipv4 unicast 
 neighbor 2001:1:1::3 activate 
exit-address-family</code></pre></div>
<h3 id="show-ipv4-prefixes-learned-with-ipv6-next-hops">Show IPv4 Prefixes Learned with IPv6 Next Hops</h3>

<p>To show IPv4 prefixes learned with IPv6 next hops, you can
run <code>net show bgp ipv4 unicast</code> commands.</p>

<p>The following examples show an IPv4 prefix learned from a BGP peer over
an IPv6 session using IPv6 global addresses, but where the next hop
installed by BGP is a link-local IPv6 address. This occurs when the
session is directly between peers and both link-local and global IPv6
addresses are included as next hops in the BGP update for the prefix. If
both global and link-local next hops exist, BGP prefers the link-local
address for route installation.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">root@Spine01:~# net show bgp ipv4 unicast summary
BGP router identifier 10.0.0.11, local AS number 1 vrf-id 0 
BGP table version 3 
RIB entries 1, using 152 bytes of memory 
Peers 1, using 19 KiB of memory 
 
Neighbor            V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down  State/PfxRcd 
Leaf01(2001:1:1::3) 4 3   6432    6431    0      0   0   05:21:25           1 
 
Total number of neighbors 1 
 
root@Spine01:~# net show bgp ipv4 unicast 
BGP table version is 3, 
local router ID is 10.0.0.11 
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath, 
              i internal, r RIB-failure, S Stale, R Removed 
Origin codes: i - IGP, e - EGP, ?   - incomplete
  
 Network         Next Hop                 Metric LocPrf Weight Path 
*&gt; 172.16.3.0/24 fe80::a00:27ff:fea6:b9fe  0       0       3     i 
 
Displayed 1 routes and 1 total paths 
 
root@Spine01:~# net show bgp ipv4 unicast 172.16.3.0/24 
BGP routing table entry for 172.16.3.0/24 
Paths: (1 available, best #1, table default) 
 Advertised to non peer-group peers: 
 Leaf01(2001:1:1::3) 
 3 
   2001:1:1::3 from Leaf01(2001:1:1::3) (10.0.0.13) 
   (fe80::a00:27ff:fea6:b9fe) (used) 
     Origin IGP, metric 0, valid, external, bestpath-from-AS 3, best 
     AddPath ID: RX 0, TX 3 
     Last update: Mon Oct 22 08:09:22 2018</code></pre></div>
<p>The example output below shows the results of installing the route in
the FRR RIB as well as the kernel FIB. Note that the next hop used for
installation in the FRR RIB is the link-local IPv6 address, but then it
is converted into an IPv4 link-local address as required for
installation into the kernel FIB.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">root@Spine01:~# net show route 172.16.3.0/24 
RIB entry for 172.16.3.0/24 
=========================== 
Routing entry for 172.16.3.0/24 
 Known via &#34;bgp&#34;, distance 20, metric 0, best 
 Last update 2d17h05m ago 
 * fe80::a00:27ff:fea6:b9fe, via swp1 
 
FIB entry for 172.16.3.0/24 
=========================== 
172.16.3.0/24 via 169.254.0.1 dev swp1 proto bgp metric 20 onlink</code></pre></div>
<p>If an IPv4 prefix is learned with only an IPv6 global next hop address
(for example, when the route is learned through a route reflector), the
command output shows the IPv6 global address as the next hop value and
shows that it is learned recursively through the link-local address of
the route reflector. Note that when a global IPv6 address is used as a
next hop for route installation in the FRR RIB, it is still converted
into an IPv4 link-local address for installation into the kernel.  </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">root@Leaf01:~# net show bgp ipv4 unicast summary 
BGP router identifier 10.0.0.13, local AS number 1 vrf-id 0 
BGP table version 1 
RIB entries 1, using 152 bytes of memory 
Peers 1, using 19 KiB of memory 
 
Neighbor             V AS MsgRcvd  MsgSent  TblVer  InQ  OutQ  Up/Down  State/PfxRcd 
Spine01(2001:1:1::1) 4 1   74       68         0     0     0     00:00:45      1 
 
Total number of neighbors 1 
 
root@Leaf01:~# net show bgp ipv4 unicast 
BGP table version is 1, local router ID is 10.0.0.13 
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath, 
              i internal, r RIB-failure, S Stale, R Removed 
Origin codes: i - IGP, e - EGP, ? - incomplete 
 
Network Next Hop Metric LocPrf Weight Path 
*&gt;i172.16.4.0/24 2001:2:2::4 0 100 0 i 
 
Displayed 1 routes and 1 total paths 
 
root@Leaf01:~# net show bgp ipv4 unicast 172.16.4.0/24 
BGP routing table entry for 172.16.4.0/24 
Paths: (1 available, best #1, table default) 
 Not advertised to any peer 
 Local 
  2001:2:2::4 from Spine01(2001:1:1::1) (10.0.0.14) 
   Origin IGP, metric 0, localpref 100, valid, internal, bestpath-from-AS Local, best 
   Originator: 10.0.0.14, Cluster list: 10.0.0.11 
   AddPath ID: RX 0, TX 5 
   Last update: Mon Oct 22 14:25:30 2018 
 
root@Leaf01:~# net show route 172.16.4.0/24 
RIB entry for 172.16.4.0/24 
=========================== 
Routing entry for 172.16.4.0/24 
 Known via &#34;bgp&#34;, distance 200, metric 0, best 
 Last update 00:01:13 ago 
  2001:2:2::4 (recursive) 
 * fe80::a00:27ff:fe5a:84ae, via swp1 
 
FIB entry for 172.16.4.0/24 
=========================== 
172.16.4.0/24 via 169.254.0.1 dev swp1 proto bgp metric 20 onlink</code></pre></div>
<p>To have only IPv6 global addresses used for route installation into the
FRR RIB, you must add an additional route map to the neighbor or peer
group statement in the appropriate address family. When the route map
command <code>set ipv6 next-hop prefer-global</code> is applied to a neighbor, if
both a link-local and global IPv6 address are in the BGP update for a
prefix, the IPv6 global address is preferred for route installation.</p>

<p>With this additional configuration, the output in the FRR RIB changes in
the direct neighbor case, as shown below:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 1 
 bgp router-id 10.0.0.11 
 neighbor 2001:2:2::4 remote-as internal 
 neighbor 2001:2:2::4 capability extended-nexthop 
 ! 
 address-family ipv4 unicast 
  neighbor 2001:2:2::4 route-map GLOBAL in 
 exit-address-family 
! 
route-map GLOBAL permit 20 
 set ipv6 next-hop prefer-global 
!</code></pre></div>
<p>The resulting FRR RIB output is as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Spine01# sh ip route 
Codes: K - kernel route, C - connected, S - static, R - RIP, 
   O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP, 
   T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP, 
   F - PBR, 
   &gt; - selected route, * - FIB route 
 
B 0.0.0.0/0 [200/0] via 2001:2:2::4, swp2, 00:01:00 
K 0.0.0.0/0 [0/0] via 10.0.2.2, eth0, 1d02h29m 
C&gt;* 10.0.0.9/32 is directly connected, lo, 5d18h32m 
C&gt;* 10.0.2.0/24 is directly connected, eth0, 03:51:31 
B&gt;* 172.16.4.0/24 [200/0] via 2001:2:2::4, swp2, 00:01:00 
C&gt;* 172.16.10.0/24 is directly connected, swp3, 5d18h32m</code></pre></div>
<p>When the route is learned through a route reflector, it appears like
this:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 1 
 bgp router-id 10.0.0.13 
 neighbor 2001:1:1::1 remote-as internal 
 neighbor 2001:1:1::1 capability extended-nexthop 
 ! 
 address-family ipv6 unicast 
  neighbor 2001:1:1::1 activate 
  neighbor 2001:1:1::1 route-map GLOBAL in 
 exit-address-family 
! 
route-map GLOBAL permit 10 
 set ipv6 next-hop prefer-global
 
Leaf01# sh ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR,
       &gt; - selected route, * - FIB route

B   0.0.0.0/0 [200/0] via 2001:2:2::4, 00:00:01
K   0.0.0.0/0 [0/0] via 10.0.2.2, eth0, 3d00h26m
C&gt;* 10.0.0.8/32 is directly connected, lo, 3d00h26m
C&gt;* 10.0.2.0/24 is directly connected, eth0, 03:39:18
C&gt;* 172.16.3.0/24 is directly connected, swp2, 3d00h26m
B&gt;  172.16.4.0/24 [200/0] via 2001:2:2::4 (recursive), 00:00:01
  *                         via 2001:1:1::1, swp1, 00:00:01
C&gt;* 172.16.10.0/24 is directly connected, swp3, 3d00h26m</code></pre></div>
<h2 id="bgp-add-path">BGP add-path</h2>

<p>Cumulus Linux supports both BGP add-path RX and BGP add-path TX.</p>

<h3 id="bgp-add-path-rx">BGP add-path RX</h3>

<p>*BGP add-path RX* allows BGP to receive multiple paths for the same
prefix. A path identifier is used so that additional paths do not
override previously advertised paths. No additional configuration is
required for BGP add-path RX.</p>

<p>BGP advertises the add-path RX capability by default. Add-Path TX
requires an administrator to enable it. Enabling TX resets the session.</p>

<p>To view the existing capabilities, run <code>net show bgp neighbor</code>. The
existing capabilities are listed in the subsection <em>Add Path</em>,
below <em>Neighbor capabilities:</em></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp neighbor 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 10.0.0.21
  BGP state = Established, up for 1d01h15m
  Last read 00:00:00, Last write 1d01h15m
  Hold time is 3, keepalive interval is 1 seconds
  Configured hold time is 3, keepalive interval is 1 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address family IPv4 Unicast: advertised and received
    Hostname Capability: advertised and received
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none

...</code></pre></div>
<p>The example output above shows that additional BGP paths can be sent and
received (TX and RX are advertised). It also shows that the BGP
neighbor, fe80::4638:39ff:fe00:5c, supports both.</p>

<p>To view the current additional paths, run <code>net show bgp &lt;network&gt;</code>. The
example output shows an additional path that has been added by the TX
node for receiving. Each path has a unique AddPath ID.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp 10.0.0.12
BGP routing table entry for 10.0.0.12/32
Paths: (2 available, best #1, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  spine01(swp51) spine02(swp52)
  65020 65012
    fe80::4638:39ff:fe00:5c from spine01(swp51) (10.0.0.21)
    (fe80::4638:39ff:fe00:5c) (used)
      Origin incomplete, localpref 100, valid, external, multipath, bestpath-from-AS 65020, best
      AddPath ID: RX 0, TX 6
      Last update: Wed Nov 16 22:47:00 2016
  65020 65012
    fe80::4638:39ff:fe00:2b from spine02(swp52) (10.0.0.22)
    (fe80::4638:39ff:fe00:2b) (used)
      Origin incomplete, localpref 100, valid, external, multipath
      AddPath ID: RX 0, TX 3
      Last update: Wed Nov 16 22:47:00 2016</code></pre></div>
<h3 id="bgp-add-path-tx">BGP add-path TX</h3>

<p>AddPath TX allows BGP to advertise more than just the bestpath for a
prefix. Consider the following topology:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">          r8
          |
          |
  r1 ----    ---- r6
  r2 ---- r7 ---- r5
          ||
          ||
        r3 r4</code></pre></div>
<p>In this topology:</p>

<ul>
<li>r1 and r2 are in AS 100</li>
<li>r3 and r4 are in AS 300</li>
<li>r5 and r6 are in AS 500</li>
<li>r7 is in AS 700</li>
<li>r8 is in AS 800</li>
<li>r7 learns 1.1.1.<sup>1</sup>&frasl;<sub>32</sub> from r1, r2, r3, r4, r5, and r6. Among these r7
picks the path from r1 as the bestpath for 1.1.1.<sup>1</sup>&frasl;<sub>32</sub></li>
</ul>

<p>The example below configures the r7 session to advertise the bestpath
learned from each AS. In this case, this means a path from AS 100, a
path from AS 300, and a path from AS 500.
The <code>net show bgp 1.1.1.1/32</code> from r7 has &ldquo;bestpath-from-AS 100&rdquo; so the
user can see what the bestpath is from each AS:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@r7:~$ net add bgp autonomous-system 700
cumulus@r7:~$ net add bgp neighbor 192.0.2.2 addpath-tx-bestpath-per-AS</code></pre></div>
<p>The output below shows the result on r8:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@r8:~$ net show bgp 1.1.1.1/32
BGP routing table entry for 1.1.1.1/32
Paths: (3 available, best #3, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  r7(10.7.8.1)
  700 100
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 1:1
      AddPath ID: RX 2, TX 4
      Last update: Thu Jun  2 00:57:14 2016

  700 300
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 3:3
      AddPath ID: RX 4, TX 3
      Last update: Thu Jun  2 00:57:14 2016

  700 500
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external, bestpath-from-AS 700, best
      Community: 5:5
      AddPath ID: RX 6, TX 2
      Last update: Thu Jun  2 00:57:14 2016</code></pre></div>
<p>The example below shows the results if r7 is configured to advertise all
paths to r8:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@r7:~$ net add bgp autonomous-system 700
cumulus@r7:~$ net add bgp neighbor 192.0.2.2 addpath-tx-all-paths</code></pre></div>
<p>The output below shows the result on r8:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@r8:~$ net show bgp 1.1.1.1/32
BGP routing table entry for 1.1.1.1/32
Paths: (3 available, best #3, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  r7(10.7.8.1)
  700 100
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 1:1
      AddPath ID: RX 2, TX 4
      Last update: Thu Jun  2 00:57:14 2016

  700 300
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 3:3
      AddPath ID: RX 4, TX 3
      Last update: Thu Jun  2 00:57:14 2016

  700 500
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external, bestpath-from-AS 700, best
      Community: 5:5
      AddPath ID: RX 6, TX 2
      Last update: Thu Jun  2 00:57:14 2016</code></pre></div>
<h2 id="fast-convergence-design-considerations">Fast Convergence Design Considerations</h2>

<p>Cumulus Networks strongly recommends the following use of addresses in
the design of a BGP-based data center network:</p>

<ul>
<li>Set up BGP sessions only using interface-scoped addresses. This
allows BGP to react quickly to link failures.</li>
<li>Use of next hop-self: Every BGP node says that it knows how to
forward traffic to the prefixes it is announcing. This reduces the
requirement to announce interface-specific addresses and thereby
reduces the size of the forwarding table.</li>
</ul>

<p>When you configure BGP for the neighbors of a given interface, you can
specify the interface name instead of its IP address. All the
other <code>neighbor</code> command options remain the same.</p>

<p>This is equivalent to BGP peering to the link-local IPv6 address of the
neighbor on the given interface. The link-local address is learned via
IPv6 neighbor discovery router advertisements.</p>

<p>Consider the following example configuration in
the <code>/etc/frr/frr.conf</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 65000
  bgp router-id 10.0.0.1
  neighbor swp1 interface
  neighbor swp1 remote-as internal
  neighbor swp1 next-hop-self
!
  address-family ipv6
  neighbor swp1 activate
  exit-address-family</code></pre></div>
<p>You create the above configuration with the following NCLU commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 65000
cumulus@switch:~$ net add bgp router-id 10.0.0.1
cumulus@switch:~$ net add bgp neighbor swp1 interface
cumulus@switch:~$ net add bgp neighbor swp1 remote-as internal
cumulus@switch:~$ net add bgp neighbor swp1 next-hop-self
cumulus@switch:~$ net add bgp ipv6 unicast neighbor swp1 activate</code></pre></div>
<p>By default, Cumulus Linux sends IPv6 neighbor discovery router
advertisements. Cumulus Networks recommends you adjust the interval of
the router advertisement to a shorter value
(<code>net add interface &lt;interface&gt; ipv6 nd ra-interval &lt;interval&gt;</code>) to
address scenarios when nodes come up and miss router advertisement
processing to relay the neighbor’s link-local address to BGP. The
<code>interval</code> is measured in seconds and defaults to 10 seconds.</p>

<h2 id="peer-groups-to-simplify-configuration">Peer Groups to Simplify Configuration</h2>

<p>When a switch has many peers to connect to, the amount of redundant
configuration becomes overwhelming. For example, repeating
the <code>activate</code> and <code>next-hop-self</code> commands for even 60 neighbors makes
for a very long configuration file. To address this problem, you can
use <code>peer-group</code> .</p>

<p>Instead of specifying properties of each individual peer, FRRouting
allows you to define one or more peer groups and associate all the
attributes common to that peer session to a peer group. A peer needs to
be attached to a peer group only once, when it then inherits all address
families activated for that peer group.</p>

<p>After you attach a peer to a peer group, you need to associate an IP
address with the peer group. The following example shows how to define
and use peer groups:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor tier-2 peer-group
cumulus@switch:~$ net add bgp ipv4 unicast
cumulus@switch:~$ net add bgp neighbor tier-2 activate
cumulus@switch:~$ net add bgp neighbor tier-2 next-hop-self
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 peer-group tier-2
cumulus@switch:~$ net add bgp neighbor 192.0.2.2 peer-group tier-2</code></pre></div>
<p>BGP peer-group restrictions have been replaced with update-groups, which
dynamically examine all peers and group them if they have the same
outbound policy.</p>

<h2 id="configure-bgp-dynamic-neighbors">Configure BGP Dynamic Neighbors</h2>

<p>*BGP dynamic neighbor* provides BGP peering to a group of remote
neighbors within a specified range of IPv4 or IPv6 addresses for a BGP
peer group. You can configure each range as a subnet IP address. </p>

<p>You configure dynamic neighbors using
the <code>bgp listen range &lt;IP address&gt; peer-group &lt;GROUP&gt;</code> command. After
you configure the dynamic neighbors, a BGP speaker can listen for, and
form peer relationships with, any neighbor in the IP address range and
mapped to a peer group. </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 65001
cumulus@switch:~$ net add bgp listen range 10.1.1.0/24 peer-group SPINE</code></pre></div>
<p>To limit the number of dynamic peers, specify the limit in
the <code>bgp listen limit</code> command (the default value is <em>100</em>):</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp listen limit 5</code></pre></div>
<p>Collectively, a sample configuration for IPv4 looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 65001
cumulus@switch:~$ net add bgp neighbor SPINE peer-group
cumulus@switch:~$ net add bgp neighbor SPINE remote-as 65000
cumulus@switch:~$ net add bgp listen limit 5
cumulus@switch:~$ net add bgp listen range 10.1.1.0/24 peer-group SPINE</code></pre></div>
<p>These commands produce an IPv4 configuration that looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 65001 
 neighbor SPINE peer-group
 neighbor SPINE remote-as 65000
  bgp listen limit 5
  bgp listen range 10.1.1.0/24 peer-group SPINE</code></pre></div>
<h2 id="configure-bgp-peering-relationships-across-switches">Configure BGP Peering Relationships across Switches</h2>

<p>A BGP peering relationship is typically initiated with
the <code>neighbor x.x.x.x remote-as [internal|external]</code> command.</p>

<p>Specifying *internal* signifies an iBGP peering; that is, the neighbor
only creates or accepts a connection with the specified neighbor if the
remote peer AS number matches this BGP AS number.</p>

<p>Specifying  *external* signifies an eBGP peering; that is, the neighbor
will only create a connection with the neighbor if the remote peer AS
number does <strong>not</strong> match this BGP AS number.</p>

<p>You can make this distinction using the <code>neighbor</code> command or
the <code>peer-group</code> command. </p>

<p>In general, use the following syntax with the <code>neighbor</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor [&lt;IP address&gt;|&lt;BGP peer&gt;|&lt;interface&gt;] remote-as [&lt;value&gt;|internal|external]</code></pre></div>
<p>Some example configurations follow.</p>

<p>To connect to <strong>the same AS</strong> using the <code>neighbor</code> command, modify your
configuration similar to the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor 192.168.1.2 remote-as internal</code></pre></div>
<p>These commands create the following configuration snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 500
neighbor 192.168.1.2 remote-as internal</code></pre></div>
<p>To connect to a <strong>different AS</strong> using the <code>neighbor</code> command, modify
your configuration similar to the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor 192.168.1.2 remote-as external</code></pre></div>
<p>These commands create the following configuration snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 500
neighbor 192.168.1.2 remote-as external</code></pre></div>
<p>To connect to <strong>the same AS</strong> using the <code>peer-group</code> command, modify
your configuration similar to the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor swp1 interface
cumulus@switch:~$ net add bgp neighbor IBGP peer-group
cumulus@switch:~$ net add bgp neighbor IBGP remote-as internal
cumulus@switch:~$ net add bgp neighbor swp1 interface peer-group IBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.3 peer-group IBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.4 peer-group IBGP</code></pre></div>
<p>These commands create the following configuration snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 500
neighbor swp1 interface
neighbor IBGP peer-group
neighbor IBGP remote-as internal
neighbor swp1 peer-group IBGP
neighbor 192.0.2.3 peer-group IBGP
neighbor 192.0.2.4 peer-group IBGP</code></pre></div>
<p>To connect to a <strong>different AS</strong> using the <code>peer-group</code> command, modify
your configuration similar to the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor swp2 interface
cumulus@switch:~$ net add bgp neighbor EBGP peer-group
cumulus@switch:~$ net add bgp neighbor EBGP remote-as external
cumulus@switch:~$ net add bgp neighbor 192.0.2.2 peer-group EBGP
cumulus@switch:~$ net add bgp neighbor swp2 interface peer-group EBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.4 peer-group EBGP</code></pre></div>
<p>These commands create the following configuration snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">router bgp 500
neighbor swp2 interface
neighbor EBGP peer-group
neighbor EBGP remote-as external
neighbor 192.0.2.2 peer-group EBGP
neighbor swp2 peer-group EBGP
neighbor 192.0.2.4 peer-group EBGP</code></pre></div>
<h2 id="configure-md5-enabled-bgp-neighbors">Configure MD5-enabled BGP Neighbors</h2>

<p>The following sections outline how to configure an MD5-enabled BGP
neighbor. Each process assumes that FRRouting is used as the routing
platform, and consists of two switches (<code>AS 65011</code> and <code>AS 65020</code>),
connected by the link 10.0.0.<sup>100</sup>&frasl;<sub>30</sub>, with the following configurations:</p>

<p><strong>switch1</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">cumulus@leaf01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 6
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020   93587   93587        0    0    0 1d02h00m        3
spine02(swp52)  4 65020   93587   93587        0    0    0 1d02h00m        3
Total number of neighbors 2

show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured</code></pre></div>
<p><strong>switch2</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">cumulus@spine01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 5
RIB entries 9, using 1080 bytes of memory
Peers 4, using 73 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011     782     782        0    0    0 00:12:54        2
leaf02(swp2)    4 65012     781     781        0    0    0 00:12:53        2
swp3            4     0       0       0        0    0    0 never    Idle       
swp4            4     0       0       0        0    0    0 never    Idle       
Total number of neighbors 4

show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
 </code></pre></div>
<p><strong>To manually configure an MD5-enabled BGP neighbor:</strong></p>

<ol>
<li><p>SSH into leaf01.</p></li>

<li><p>Configure the password for the neighbor:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net add bgp neighbor 10.0.0.102 password mypassword</code></pre></div></li>

<li><p>Confirm the configuration has been implemented with
the <code>net show bgp summary</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 18
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020   96144   96146        0    0    0 00:30:29        3
spine02(swp52)  4 65020   96209   96217        0    0    0 1d02h44m        3
Total number of neighbors 2

show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured</code></pre></div></li>

<li><p>SSH into spine01.</p></li>

<li><p>Configure the password for the neighbor:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@spine01:~$ net add bgp neighbor 10.0.0.101 password mypassword</code></pre></div></li>

<li><p>Confirm the configuration has been implemented with
the <code>net show bgp summary</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@spine01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 5
RIB entries 9, using 1080 bytes of memory
Peers 4, using 73 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011     782     782        0    0    0 00:12:54        2
leaf02(swp2)    4 65012     781     781        0    0    0 00:12:53        2
swp3            4     0       0       0        0    0    0 never    Idle       
swp4            4     0       0       0        0    0    0 never    Idle       
Total number of neighbors 4

show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured</code></pre></div></li>
</ol>

<p>The MD5 password configured against a BGP listen-range peer-group (used
to accept and create dynamic BGP neighbors) is not enforced. This means
that connections are accepted from peers that do not specify a password.</p>

<h2 id="configure-ebgp-multihop">Configure eBGP Multihop</h2>

<p>The eBGP Multihop option lets you use BGP to exchange routes with an
external peer that is more than one hop away.</p>

<ol>
<li><p>To establish a connection between two eBGP peers that are not
directly connected:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf02:mgmt-vrf:~$ net add bgp neighbor &lt;ip&gt; remote-as external
cumulus@leaf02:mgmt-vrf:~$ net add bgp neighbor &lt;ip&gt; ebgp-multihop</code></pre></div></li>

<li><p>Confirm the configuration with
the <code>net show bgp neighbor &lt;ip&gt;</code> command:</p>

<pre><code>cumulus@leaf02:mgmt-vrf:~$ net show bgp neighbor 10.0.0.11
BGP neighbor is 10.0.0.11, remote AS 65011, local AS 65012, external link
Hostname: leaf01
  BGP version 4, remote router ID 10.0.0.11
  BGP state = Established, up for 00:02:54
  Last read 00:00:00, Last write 00:00:00
  Hold time is 9, keepalive interval is 3 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Route refresh: advertised and received(old &amp; new)
    Address Family IPv4 Unicast: advertised and received
    Hostname Capability: advertised (name: leaf02,domain name: n/a) received (name: leaf01,domain name: n/a)
    Graceful Restart Capability: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          0          0
    Updates:             2868       2872
    Keepalives:            60         60
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2929       2933
  Minimum time between advertisement runs is 0 seconds
 For address family: IPv4 Unicast
  Update group 2, subgroup 4
  Packet Queue length 0
  Community attribute sent to this neighbor(all)
  9 accepted prefixes
  Connections established 1; dropped 0
  Last reset never
  External BGP neighbor may be up to 255 hops away.
Local host: 10.0.0.12, Local port: 40135
Foreign host: 10.0.0.11, Foreign port: 179
Nexthop: 10.0.0.12
Nexthop global: ::
Nexthop local: ::
BGP connection: non shared network
BGP Connect Retry Timer in Seconds: 10
Estimated round trip time: 1 ms
Read thread: on  Write thread: on
</code></pre></li>
</ol>

<h2 id="configure-bgp-ttl-security">Configure BGP TTL Security</h2>

<p>The steps below show how to configure BGP TTL security on Cumulus Linux
using a leaf (<code>leaf01</code>) and spine (<code>spine01</code>) for the example output:</p>

<ol>
<li><p>SSH into leaf01 and configure it for TTL security:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net add bgp autonomous-system 65000
cumulus@leaf01:~$ net add bgp neighbor [spine01-IP] ttl-security hops [value]</code></pre></div></li>

<li><p>SSH into spine01 and configure it for TTL security:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@spine01:~$ net add bgp autonomous-system 65001
cumulus@spine01:~$ net add bgp neighbor [leaf01-IP] ttl-security hops [value]</code></pre></div></li>

<li><p>Confirm the configuration with the <code>show ip bgp neighbor</code> command:</p>

<pre><code>cumulus@spine01:mgmt-vrf:~$ net show bgp neighbor swp1
BGP neighbor on swp1: fe80::4638:39ff:fe00:5b, remote AS 65011, local AS 65020, external link
Hostname: leaf01
  BGP version 4, remote router ID 10.0.0.11
  BGP state = Established, up for 00:10:45
  Last read 00:00:03, Last write 00:00:03
  Hold time is 9, keepalive interval is 3 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address Family IPv4 Unicast: advertised and received
    Hostname Capability: advertised (name: spine01,domain name: n/a) received (name: leaf01,domain name: n/a)
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                 46          2
    Notifications:         41          0
    Updates:               38         34
    Keepalives:         49334      49331
    Route Refresh:          0          0
    Capability:             0          0
    Total:              49459      49367
  Minimum time between advertisement runs is 0 seconds

 For address family: IPv4 Unicast
  Update group 1, subgroup 1
  Packet Queue length 0
  Community attribute sent to this neighbor(all)
  3 accepted prefixes

  Connections established 2; dropped 1
  Last reset 00:17:37, due to NOTIFICATION sent (Hold Timer Expired)
  External BGP neighbor may be up to 1 hops away.
Local host: fe80::4638:39ff:fe00:5c, Local port: 35564
Foreign host: fe80::4638:39ff:fe00:5b, Foreign port: 179
Nexthop: 10.0.0.21
Nexthop global: fe80::4638:39ff:fe00:5c
Nexthop local: fe80::4638:39ff:fe00:5c
BGP connection: shared network
BGP Connect Retry Timer in Seconds: 10
Read thread: on  Write thread: on
</code></pre></li>
</ol>

<h2 id="configure-graceful-bgp-shutdown">Configure Graceful BGP Shutdown</h2>

<p>To reduce packet loss during planned maintenance of a router or link,
you can configure graceful BGP shutdown, which forces traffic to route
around the node.</p>

<p>To configure graceful BGP shutdown for the current node, run
the <code>net add bgp graceful-shutdown</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@spine01:~$ net add bgp graceful-shutdown
cumulus@spine01:~$ net pending
cumulus@spine01:~$ net commit</code></pre></div>
<p>When configured, the <code>graceful-shutdown</code> community is added to all paths
from eBGP peers and the <code>local-pref</code> for that route is set to 0. An
example configuration is shown below:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ show ip bgp 10.1.3.0/24
BGP routing table entry for 10.1.3.0/24
Paths: (2 available, best #1, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  bottom0(10.1.2.2)
  30 20
    10.1.1.2 (metric 10) from top1(10.1.1.2) (10.1.1.2)
      Origin IGP, localpref 100, valid, internal, bestpath-from-AS 30, best
      Community: 99:1
      AddPath ID: RX 0, TX 52
      Last update: Mon Sep 18 17:01:18 2017

  20
    10.1.2.2 from bottom0(10.1.2.2) (10.1.1.1)
      Origin IGP, metric 0, localpref 0, valid, external, bestpath-from-AS 20
      Community: 99:1 graceful-shutdown
      AddPath ID: RX 0, TX 2
      Last update: Mon Sep 18 17:01:18 2017</code></pre></div>
<p>To disable graceful shutdown for the current node, run
the <code>net del bgp graceful-shutdown</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@spine01:~$ net del bgp graceful-shutdown
cumulus@spine01:~$ net pending
cumulus@spine01:~$ net commit</code></pre></div>
<h2 id="configuration-tips">Configuration Tips</h2>

<h3 id="bgp-advertisement-best-practices">BGP Advertisement Best Practices</h3>

<p>Limiting the exchange of routing information at various parts in the
network is a best practice you should follow. The following image
illustrates one way you can do so in a typical Clos architecture:</p>

<p><img src="attachments/8362926/8362925.png" alt="" />{height=&ldquo;400&rdquo;}</p>

<h3 id="multiple-routing-tables-and-forwarding">Multiple Routing Tables and Forwarding</h3>

<p>You can run multiple routing tables (one for in-band/data plane traffic
and one for out-of-band/management plane traffic) on the same switch
using <a href="Management_VRF">management VRF</a> (multiple routing tables and
forwarding).</p>

<p>BGP and static routing (IPv4 and IPv6) are supported within a VRF
context. For more information, refer to <a href="Virtual_Routing_and_Forwarding_-_VRF">Virtual Routing and Forwarding
- VRF</a>.</p>

<h3 id="bgp-community-lists">BGP Community Lists</h3>

<p>You can use <a href="http://www.nongnu.org/quagga/docs/docs-multi/BGP-Community-Lists.html#BGP-Community-Lists"> *community
lists* </a> to
define a BGP community to tag one or more routes. You can then use the
communities to apply route policy on either egress or ingress.</p>

<p>The BGP community list can be either *standard* or *expanded.* The
standard BGP community list is a pair of values (such as <em>100:100</em>) that
can be tagged on a specific prefix and advertised to other neighbors or
applied on route ingress. Alternately, it can be one of four BGP default
communities:</p>

<ul>
<li><em>internet</em>: a BGP community that matches all routes</li>
<li><em>local-AS</em>: a BGP community that restrict routes to your
confederation&rsquo;s sub-AS</li>
<li><em>no-advertise</em>: a BGP community that isn&rsquo;t advertised to anyone</li>
<li><em>no-export</em>: a BGP community that isn&rsquo;t advertised to the eBGP peer</li>
</ul>

<p>An expanded BGP community list takes a regular expression of communities
matches the listed communities.</p>

<p>When the neighbor receives the prefix, it examines the community value
and takes action accordingly, such as permitting or denying the
community member in the routing policy. </p>

<p>Here is an example of a standard community list filter:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add routing community-list standard COMMUNITY1 permit 100:100</code></pre></div>
<p>You can apply the community list to a route map to define the routing
policy: </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp table-map ROUTE-MAP1</code></pre></div>
<h3 id="additional-default-settings">Additional Default Settings</h3>

<p>Other settings not discussed in detail in this chapter that are enabled
by default, include the following:</p>

<ul>
<li><code>bgp deterministic-med</code>, which ensures path ordering no longer
impacts bestpath selection.</li>
<li><code>bgp show-hostname</code>, which displays the hostname in show command
output.</li>
<li><code>bgp network import-check</code>, which enables the advertising of the BGP
network in IGP.</li>
</ul>

<h3 id="configure-bgp-neighbor-maximum-prefixes">Configure BGP Neighbor maximum-prefixes</h3>

<p>The maximum number of route announcements, or prefixes, allowed by a BGP
neighbor can be configured using the FRR <code>maximum-prefixes</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">frr(config)# neighbor &lt;peer&gt; maximum-prefix &lt;number&gt;</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>

<p>To troubleshoot BGP, you can view the summary of neighbors to which the
switch is connected and see information about these connections. The
following example shows sample command output:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 8
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020     549     551        0    0    0 00:09:03        3
spine02(swp52)  4 65020     548     550        0    0    0 00:09:02        3
Total number of neighbors 2

show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured</code></pre></div>
<p>To determine if the sessions above are iBGP or eBGP sessions, look at
the ASNs.</p>

<p>It is also useful to view the routing table as defined by BGP:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp ipv4
ERROR: Command not found
Use &#39;net help KEYWORD(s)&#39; to list all options that use KEYWORD(s)
cumulus@leaf01:~$ net show bgp ipv4 
    unicast  :  add help text
cumulus@leaf01:~$ net show bgp ipv4 unicast 
BGP table version is 8, local router ID is 10.0.0.11
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath,
              i internal, r RIB-failure, S Stale, R Removed
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.11/32     0.0.0.0                  0         32768 ?
*= 10.0.0.12/32     swp52                         0 65020 65012 ?
*&gt;                  swp51                         0 65020 65012 ?
*&gt; 10.0.0.21/32     swp51           0             0 65020 ?
*&gt; 10.0.0.22/32     swp52           0             0 65020 ?
*&gt; 172.16.1.0/24    0.0.0.0                  0         32768 i
*= 172.16.2.0/24    swp52                         0 65020 65012 i
*&gt;                  swp51                         0 65020 65012 i
Total number of prefixes 6</code></pre></div>
<p>To show a more detailed breakdown of a specific neighbor, run
the <code>net show bgp neighbor &lt;neighbor&gt;</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp neighbor swp51
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 10.0.0.21
  BGP state = Established, up for 00:11:30
  Last read 00:00:00, Last write 00:11:26
  Hold time is 3, keepalive interval is 1 seconds
  Configured hold time is 3, keepalive interval is 1 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address family IPv4 Unicast: advertised and received
    Hostname Capability: advertised and received
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          0          0
    Updates:                7          6
    Keepalives:           690        689
    Route Refresh:          0          0
    Capability:             0          0
    Total:                698        696
  Minimum time between advertisement runs is 0 seconds
 For address family: IPv4 Unicast
  fabric peer-group member
  Update group 1, subgroup 1
  Packet Queue length 0
  Community attribute sent to this neighbor(both)
  Inbound path policy configured
  Outbound path policy configured
  Incoming update prefix filter list is *dc-leaf-in
  Outgoing update prefix filter list is *dc-leaf-out
  3 accepted prefixes
  Connections established 1; dropped 0
  Last reset never
Local host: fe80::4638:39ff:fe00:5b, Local port: 48424
Foreign host: fe80::4638:39ff:fe00:5c, Foreign port: 179
Nexthop: 10.0.0.11
Nexthop global: fe80::4638:39ff:fe00:5b
Nexthop local: fe80::4638:39ff:fe00:5b
BGP connection: shared network
BGP Connect Retry Timer in Seconds: 3
Estimated round trip time: 3 ms
Read thread: on  Write thread: off</code></pre></div>
<p>To see details of a specific route, such as from where it is received
and where it is sent, run
the <code>net show bgp &lt;ip address/prefix&gt;</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp 10.0.0.11/32
BGP routing table entry for 10.0.0.11/32
Paths: (1 available, best #1, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  spine01(swp51) spine02(swp52)
  Local
    0.0.0.0 from 0.0.0.0 (10.0.0.11)
      Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced, bestpath-from-AS Local, best
      AddPath ID: RX 0, TX 9
      Last update: Fri Nov 18 01:48:17 2016</code></pre></div>
<p>The above example shows that the routing table prefix seen by BGP is
10.0.0.<sup>11</sup>&frasl;<sub>32</sub>, that this route is advertised to two neighbors, and that
it is not heard by any neighbors.</p>

<h3 id="log-neighbor-state-changes">Log Neighbor State Changes</h3>

<p>To log the changes that a neighbor goes through so that you can
troubleshoot issues associated with that neighbor, run
the <code>log-neighbor-changes</code> command, which is enabled by default.</p>

<p>The output is sent to the specified log file,
usually <code>/var/log/frr/bgpd.log</code>, and looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">2016/07/08 10:12:06.572827 BGP: %NOTIFICATION: sent to neighbor 10.0.0.2 6/3 (Cease/Peer Unconfigured) 0 bytes
2016/07/08 10:12:06.572954 BGP: Notification sent to neighbor 10.0.0.2: type 6/3
2016/07/08 10:12:16.682071 BGP: %ADJCHANGE: neighbor 192.0.2.2 Up
2016/07/08 10:12:16.682660 BGP: %ADJCHANGE: neighbor 10.0.0.2 Up</code></pre></div>
<h3 id="troubleshoot-link-local-addresses">Troubleshoot Link-local Addresses</h3>

<p>To verify that <code>frr</code> learned the neighboring link-local IPv6 address via
the IPv6 neighbor discovery router advertisements on a given interface,
run the <code>show interface &lt;if-name&gt;</code> command. If <code>ipv6 nd suppress-ra</code> is
not enabled on both ends of the interface,
then <code>Neighbor address(s):</code> has the other end&rsquo;s link-local address. That
is the address that BGP uses when BGP is enabled on that interface.</p>

<p>IPv6 route advertisements (RAs) are automatically enabled on an
interface with IPv6 addresses; the <code>no ipv6 nd suppress-ra</code> command is
not needed for BGP unnumbered.</p>

<p>Use <code>vtysh</code> to verify the configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ sudo vtysh

Hello, this is FRRouting (version 4.0+cl3u8).
Copyright 1996-2005 Kunihiro Ishiguro, et al.

R7# show interface swp1
Interface swp1 is up, line protocol is up
  Link ups:       0    last: (never)
  Link downs:     0    last: (never)
  PTM status: disabled
  vrf: Default-IP-Routing-Table
  index 4 metric 0 mtu 1500 
  flags: &lt;UP,BROADCAST,RUNNING,MULTICAST&gt;
  HWaddr: 44:38:39:00:00:5c
  inet6 fe80::4638:39ff:fe00:5c/64
  ND advertised reachable time is 0 milliseconds
  ND advertised retransmit interval is 0 milliseconds
  ND router advertisements are sent every 10 seconds
  ND router advertisements lifetime tracks ra-interval
  ND router advertisement default router preference is medium
  Hosts use stateless autoconfig for addresses.
  Neighbor address(s):
  inet6 fe80::4638:39ff:fe00:5b/128</code></pre></div>
<p>Instead of the IPv6 address, the peering interface name is displayed in
the <code>show ip bgp summary</code> command and wherever else applicable:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp summary
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 15
RIB entries 17, using 2040 bytes of memory
Peers 6, using 97 KiB of memory
Peer groups 1, using 56 bytes of memory

Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011    2834    2843        0    0    0 02:21:35        2
leaf02(swp2)    4 65012    2834    2844        0    0    0 02:21:36        2
leaf03(swp3)    4 65013    2834    2843        0    0    0 02:21:35        2
leaf04(swp4)    4 65014    2834    2844        0    0    0 02:21:36        2
edge01(swp29)   4 65051    8509    8505        0    0    0 02:21:37        3
edge01(swp30)   4 65051    8506    8503        0    0    0 02:21:35        3

Total number of neighbors 6</code></pre></div>
<p>Most of the <code>net show</code> commands can take the interface name instead of
the IP address.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp neighbor 
    fabric  :  BGP neighbor or peer-group
    swp51   :  BGP neighbor or peer-group
    swp52   :  BGP neighbor or peer-group
    &lt;ENTER&gt;</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@leaf01:~$ net show bgp neighbor swp51
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 20:16:21, Last write 20:55:51
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          1          0
    Updates:                7          6
    Keepalives:          2374       2373
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2383       2380
  Minimum time between advertisement runs is 5 seconds
 For address family: IPv4 Unicast
  fabric peer-group member
  Not part of any update group
  Community attribute sent to this neighbor(both)
  Inbound path policy configured
  Outbound path policy configured
  Incoming update prefix filter list is *dc-leaf-in
  Outgoing update prefix filter list is *dc-leaf-out
  0 accepted prefixes
  Connections established 1; dropped 1
  Last reset 20:16:20, due to NOTIFICATION sent (Cease/Other Configuration Change)
BGP Connect Retry Timer in Seconds: 3
Next connect timer due in 1 seconds
Read thread: on  Write thread: on</code></pre></div>
<h2 id="enable-read-only-mode">Enable Read-only Mode</h2>

<p>As BGP peers are established and updates are received, prefixes might be
installed in the RIB and advertised to BGP peers even though the
information from all peers has not yet been received and processed.
Depending on the timing of the updates, prefixes might be installed and
propagated through BGP, and then immediately withdrawn and replaced with
new routing information. Read-only mode minimizes this BGP route churn
in both the local RIB and with BGP peers.</p>

<p>Enable read-only mode to reduce CPU and network usage when you restart
the BGP process, or when you issue the <code>clear</code> <code>ip bgp</code> command. Because
intermediate best paths are possible for the same prefix as peers get
established and start receiving updates at different times, read-only
mode is particularly useful in topologies where BGP learns a prefix from
many peers and the network has a high number of prefixes.</p>

<p>To enable read-only mode, run
the <code>net add bgp update-delay &lt;max-delay in 0-3600 seconds&gt; [&lt;establish-wait in 1-3600 seconds&gt;]</code> command. <br />
The following example command enables read-only mode, sets
the <code>max-delay</code> timer to 300 seconds and the <code>establish-wait</code> timer to
90 seconds.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:$ net add bgp update-delay 300 90</code></pre></div>
<p>The default value for max-delay is 0, which disables read-only mode.<br />
The <code>establish-wait</code> option is optional; however, if specified, the
<code>establish-wait</code> option must be shorter than the <code>max-delay</code>.</p>

<p>Read-only mode begins as soon as the first peer reaches its established
state and the <code>max-delay</code> timer starts, and continues until either of
the following two conditions are met:</p>

<ul>
<li><p>All the configured peers (except the shutdown peers) have sent an
explicit EOR (End-Of-RIB) or an implicit EOR. The first keep-alive
after BGP has reached the established state is considered an
implicit EOR. <br />
If you specify the <code>establish-wait</code> option, BGP only considers peers
that have reached the established state from the moment
the <code>max-delay</code> timer starts until the <code>establish-wait</code> period
ends. </p>

<p>The minimum set of established peers for which EOR is expected are
the peers that are established during the <code>establish-wait window,</code>
not necessarily all the configured neighbors.</p></li>

<li><p>The timer reaches the configured <code>max-delay</code>.</p></li>
</ul>

<p>While in read-only mode, BGP does not run best-path or generate any
updates to its peers.</p>

<p>To show information about the state of the update delay, run
the <code>show bgp summary</code> command.</p>

<h2 id="apply-a-route-map-for-route-updates">Apply a Route Map for Route Updates</h2>

<p>There are two ways you can apply <a href="http://www.nongnu.org/quagga/docs/docs-multi/Route-Map.html#Route-Map">route
maps</a> for
BGP:</p>

<ul>
<li>By filtering routes from BGP into Zebra</li>
<li>By filtering routes from Zebra into the Linux kernel</li>
</ul>

<h3 id="filter-routes-from-bgp-into-zebra">Filter Routes from BGP into Zebra</h3>

<p>You can apply a route map on route updates from BGP to Zebra. All the
applicable match operations are allowed, such as match on prefix, next
hop, communities, and so on. Set operations for this attach-point are
limited to metric and next hop only. Any operation of this feature does
not affect BGPs internal RIB.</p>

<p>Both IPv4 and IPv6 address families are supported. Route maps work on
multi-paths; however, the metric setting is based on the best path only.</p>

<p>To apply a route map to filter route updates from BGP into Zebra, run
the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:$ net add bgp table-map &lt;route-map-name&gt;</code></pre></div>
<h3 id="filter-routes-from-zebra-into-the-linux-kernel">Filter Routes from Zebra into the Linux Kernel</h3>

<p>To apply a route map to filter route updates from Zebra into the Linux
kernel, run the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:$ net add routing protocol bgp route-map &lt;route-map-name&gt;</code></pre></div>
<h2 id="protocol-tuning">Protocol Tuning</h2>

<h3 id="converge-quickly-on-link-failures">Converge Quickly On Link Failures</h3>

<p>In the Clos topology, we recommend that you only use interface addresses
to set up peering sessions. This means that when the link fails, the BGP
session is torn down immediately, triggering route updates to propagate
through the network quickly. This requires the following commands be
enabled for all
links: <code>link-detect</code> and <code>ttl-security hops &lt;hops&gt;</code>. <code>ttl-security hops</code> specifies
how many hops away the neighbor is. For example, in a Clos topology,
every peer is at most 1 hop away.</p>

<p>See Caveats and Errata below for information regarding
<code>ttl-security hops</code>.</p>

<p>Here is an example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor 10.0.0.2 ttl-security hops 1</code></pre></div>
<h3 id="converge-quickly-on-soft-failures">Converge Quickly On Soft Failures</h3>

<p>It is possible that the link is up, but the neighboring BGP process is
hung or has crashed. If a BGP process crashes, the
FRRouting <code>watchquagga</code> daemon, which monitors the various FRRouting
daemons, will attempt to restart it. If the process is also
hung, <code>watchquagga</code> will attempt to restart the process. BGP itself has
a keepalive timer that is exchanged between neighbors. By default, this
keepalive timer is set to three seconds. This time can be increased to a
higher number, which decreases CPU load, especially in the presence of a
lot of neighbors. <code>keepalive-time</code> is the periodicity with which the
keepalive message is sent. <code>hold-time</code> specifies how many keepalive
messages can be lost before the connection is considered invalid. It is
usually set to three times the keepalive time, and defaults to nine
seconds. The following example shows how to change these timers:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor swp51 timers 10 30</code></pre></div>
<p>The following snippet shows that the default values have been modified
for this neighbor:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp neighbor swp51 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 00:00:13, Last write 00:39:43
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
...</code></pre></div>
<h3 id="reconnect-quickly">Reconnect Quickly</h3>

<p>A BGP process attempts to connect to a peer after a failure (or on
startup) every <code>connect-time</code> seconds. By default, this is 10 seconds.
To modify this value, run the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor swp51 timers connect 30</code></pre></div>
<p>You must specify this command for each neighbor.</p>

<h3 id="advertisement-interval">Advertisement Interval</h3>

<p>BGP by default chooses stability over fast convergence. This is very
useful when routing for the Internet. For example, unlike link-state
protocols, BGP typically waits for a duration
of <code>advertisement-interval</code> seconds between sending consecutive updates
to a neighbor. This ensures that an unstable neighbor flapping routes
are not propagated throughout the network. By default, this is set to
zero seconds for both eBGP and iBGP sessions, which allows for very fast
convergence. You can modify this as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add bgp neighbor swp51 advertisement-interval 5</code></pre></div>
<p>The following output shows the modified value:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show bgp neighbor swp51 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 00:04:37, Last write 00:44:07
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          1          0
    Updates:                7          6
    Keepalives:          2374       2373
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2383       2380
  Minimum time between advertisement runs is 5 seconds
...</code></pre></div>
<p>This command is not supported with peer-groups.</p>

<p>See this <a href="http://tools.ietf.org/html/draft-jakma-mrai-02">IETF
draft</a> for more details
on the use of this value.</p>

<h2 id="caveats-and-errata">Caveats and Errata</h2>

<h3 id="ttl-security-issue">ttl-security Issue</h3>

<p>Enabling <code>ttl-security</code> does not cause the hardware to be programmed
with the relevant information. This means that frames will come up to
the CPU and be dropped there. It is recommended that you use
the <code>net add acl</code> command to explicitly add the relevant entry to
hardware.</p>

<p>For example, you can configure a file, such
as <code>/etc/cumulus/acl/policy.d/01control_plane_bgp.rules</code>, with a rule
like this for TTL:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">INGRESS_INTF = swp1 
    INGRESS_CHAIN = INPUT, FORWARD 

    [iptables]
    -A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bgp -m ttl --ttl 255 POLICE --set-mode pkt --set-rate 2000 --set-burst 1000 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bgp DROP</code></pre></div>
<p>For more information about ACLs, see <a href="Netfilter_-_ACLs">Netfilter
(ACLs)</a>.</p>

<h3 id="bgp-dynamic-capabilities-not-supported">BGP Dynamic Capabilities not Supported</h3>

<p>Dynamic capabilities, which enable BGP to renegotiate a new feature for
an already established peer, are not supported in Cumulus Linux.</p>

<h3 id="related-information">Related Information</h3>

<ul>
<li><a href="Bidirectional_Forwarding_Detection_-_BFD">Bidirectional forwarding
detection</a> (BFD) and BGP</li>
<li><a href="http://en.wikipedia.org/wiki/Border_Gateway_Protocol">Wikipedia entry for
BGP</a> (includes
list of useful RFCs)</li>
<li><a href="https://frrouting.org/user-guide/bgp.html">FRR BGP documentation</a></li>
<li><a href="http://tools.ietf.org/html/draft-lapukhov-bgp-routing-large-dc-04">IETF draft discussing BGP use within data
centers</a></li>
<li><a href="https://tools.ietf.org/html/rfc1657">RFC 1657, Definitions of Managed Objects for the Fourth Version of
the Border Gateway Protocol (BGP-4) using
SMIv2</a></li>

<li><p><a href="https://tools.ietf.org/html/rfc1997">RFC 1997, BGP Communities
Attribute</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc2385">RFC 2385, Protection of BGP Sessions via the TCP MD5 Signature
Option</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc2439">RFC 2439, BGP Route Flap
Damping</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc2545">RFC 2545, Use of BGP-4 Multiprotocol Extensions for IPv6
Inter-Domain Routing</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc2918">RFC 2918, Route Refresh Capability for
BGP-4</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc4271">RFC 4271, A Border Gateway Protocol 4
(BGP-4)</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc4360">RFC 4360, BGP Extended Communities
Attribute</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc4456">RFC 4456, BGP Route Reflection – An Alternative to Full Mesh
Internal BGP (iBGP)</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc4760">RFC 4760, Multiprotocol Extensions for
BGP-4</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc5004">RFC 5004, Avoid BGP Best Path Transitions from One External to
Another</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc5065">RFC 5065, Autonomous System Confederations for
BGP</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc5291">RFC 5291, Outbound Route Filtering Capability for
BGP-4</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc5492">RFC 5492, Capabilities Advertisement with
BGP-4</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc5549">RFC 5549, Advertising IPv4 Network Layer Reachability Information
with an IPv6 Next Hop</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc6793">RFC 6793, BGP Support for Four-Octet Autonomous System (AS) Number
Space</a></p></li>

<li><p><a href="https://tools.ietf.org/html/rfc7911">RFC 7911, Advertisement of Multiple Paths in
BGP </a></p></li>

<li><p><a href="https://tools.ietf.org/html/draft-walton-bgp-hostname-capability-00">draft-walton-bgp-hostname-capability-02, Hostname Capability for
BGP</a></p></li>
</ul>

<h2 id="attachments">Attachments:</h2>

<p><img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;}
<a href="attachments/8362926/8362927.png">bgp_route_reflectors.png</a>
(image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;} <a href="attachments/8362926/8362925.png">BGP
Advertisement Best Practices.png</a>
(image/png)</p>
</article>

      
<div class="align-center book-git-footer justify-between">
  
  <div>
    <a href="https://github.com/cawleyflower/testDocs/commit/0f1fa77f244c4b4642688df1f5e961e88daa6e08" title='Last modified March 4, 2019 16:11 EST by Cawleyflower' target="_blank" rel="noopener">
      <img src="/svg/code-merge.svg" /> Last Modified Mar 4, 2019
    </a>
  </div>
  
  
</div>


    </div>

    
  
  
  <aside class="book-toc fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#border-gateway-protocol-bgp">Border Gateway Protocol - BGP</a>
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#autonomous-system-number-asn">Autonomous System Number (ASN)</a></li>
<li><a href="#ebgp-and-ibgp">eBGP and iBGP</a></li>
<li><a href="#route-reflectors">Route Reflectors</a></li>
<li><a href="#ecmpwith-bgp">ECMPwith BGP</a>
<ul>
<li><a href="#maximum-paths">Maximum Paths</a></li>
<li><a href="#bgp-for-both-ipv4-and-ipv6">BGP for Both IPv4 and IPv6</a></li>
</ul></li>
<li><a href="#configure-bgp">Configure BGP</a></li>
<li><a href="#bgp-unnumbered-interfaces">BGP Unnumbered Interfaces</a>
<ul>
<li><a href="#bgp-and-extended-next-hop-encoding">BGP and Extended Next Hop Encoding</a></li>
<li><a href="#configure-bgp-unnumbered-interfaces">Configure BGP Unnumbered Interfaces</a></li>
<li><a href="#manage-unnumbered-interfaces">Manage Unnumbered Interfaces</a></li>
<li><a href="#how-traceroute-interacts-with-bgp-unnumbered-interfaces">How traceroute Interacts with BGP Unnumbered Interfaces</a></li>
<li><a href="#advanced-how-next-hop-fields-are-set">Advanced: How Next Hop Fields Are Set</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul></li>
<li><a href="#rfc-5549-support-with-global-ipv6-peers-cumulus-linux-3-7-2-and-later">RFC 5549 Support with Global IPv6 Peers (Cumulus Linux 3.7.2 and later)</a>
<ul>
<li><a href="#configure-rfc-5549-support-with-global-ipv6-peers">Configure RFC 5549 Support with Global IPv6 Peers  </a></li>
<li><a href="#show-ipv4-prefixes-learned-with-ipv6-next-hops">Show IPv4 Prefixes Learned with IPv6 Next Hops</a></li>
</ul></li>
<li><a href="#bgp-add-path">BGP add-path</a>
<ul>
<li><a href="#bgp-add-path-rx">BGP add-path RX</a></li>
<li><a href="#bgp-add-path-tx">BGP add-path TX</a></li>
</ul></li>
<li><a href="#fast-convergence-design-considerations">Fast Convergence Design Considerations</a></li>
<li><a href="#peer-groups-to-simplify-configuration">Peer Groups to Simplify Configuration</a></li>
<li><a href="#configure-bgp-dynamic-neighbors">Configure BGP Dynamic Neighbors</a></li>
<li><a href="#configure-bgp-peering-relationships-across-switches">Configure BGP Peering Relationships across Switches</a></li>
<li><a href="#configure-md5-enabled-bgp-neighbors">Configure MD5-enabled BGP Neighbors</a></li>
<li><a href="#configure-ebgp-multihop">Configure eBGP Multihop</a></li>
<li><a href="#configure-bgp-ttl-security">Configure BGP TTL Security</a></li>
<li><a href="#configure-graceful-bgp-shutdown">Configure Graceful BGP Shutdown</a></li>
<li><a href="#configuration-tips">Configuration Tips</a>
<ul>
<li><a href="#bgp-advertisement-best-practices">BGP Advertisement Best Practices</a></li>
<li><a href="#multiple-routing-tables-and-forwarding">Multiple Routing Tables and Forwarding</a></li>
<li><a href="#bgp-community-lists">BGP Community Lists</a></li>
<li><a href="#additional-default-settings">Additional Default Settings</a></li>
<li><a href="#configure-bgp-neighbor-maximum-prefixes">Configure BGP Neighbor maximum-prefixes</a></li>
</ul></li>
<li><a href="#troubleshooting">Troubleshooting</a>
<ul>
<li><a href="#log-neighbor-state-changes">Log Neighbor State Changes</a></li>
<li><a href="#troubleshoot-link-local-addresses">Troubleshoot Link-local Addresses</a></li>
</ul></li>
<li><a href="#enable-read-only-mode">Enable Read-only Mode</a></li>
<li><a href="#apply-a-route-map-for-route-updates">Apply a Route Map for Route Updates</a>
<ul>
<li><a href="#filter-routes-from-bgp-into-zebra">Filter Routes from BGP into Zebra</a></li>
<li><a href="#filter-routes-from-zebra-into-the-linux-kernel">Filter Routes from Zebra into the Linux Kernel</a></li>
</ul></li>
<li><a href="#protocol-tuning">Protocol Tuning</a>
<ul>
<li><a href="#converge-quickly-on-link-failures">Converge Quickly On Link Failures</a></li>
<li><a href="#converge-quickly-on-soft-failures">Converge Quickly On Soft Failures</a></li>
<li><a href="#reconnect-quickly">Reconnect Quickly</a></li>
<li><a href="#advertisement-interval">Advertisement Interval</a></li>
</ul></li>
<li><a href="#caveats-and-errata">Caveats and Errata</a>
<ul>
<li><a href="#ttl-security-issue">ttl-security Issue</a></li>
<li><a href="#bgp-dynamic-capabilities-not-supported">BGP Dynamic Capabilities not Supported</a></li>
<li><a href="#related-information">Related Information</a></li>
</ul></li>
<li><a href="#attachments">Attachments:</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
