<!DOCTYPE html><html>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Policy Based Routing | Cumulus Networks Documentation</title>

<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono:300,400,700" rel="stylesheet">
<link rel="stylesheet" href="/normalize.min.css">

<link rel="stylesheet" href="/book.min.50a619ce4c0e99594908d162684f42218608aa6fde2bd83cca5025d59ba535e3.css">

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">
<h2 class="book-brand">
  <a href="http://example.org/">Cumulus Networks Documentation</a>
</h2>



    


  
  
    
    
  
 
  <ul>
    
    <li><a href="/Cumulus-Linux/installation-management/">
    Installation Management</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/installation-management/Adding_and_Updating_Packages/">Adding and Updating Packages</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Installing_a_New_Cumulus_Linux_Image/">Installing a New Cumulus Linux Image</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Managing_Cumulus_Linux_Disk_Images/">Managing Cumulus Linux Disk Images</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Upgrading_Cumulus_Linux/">Upgrading Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Using_Snapshots/">Using Snapshots</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/installation-management/Zero_Touch_Provisioning_-_ZTP/">Zero Touch Provisioning Z T P</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer1-switch-ports/">
    Layer1 Switch Ports</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/802.1X_Interfaces/">802.1 X Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Buffer_and_Queue_Management/">Buffer and Queue Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Relays/">D H C P Relays</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/DHCP_Servers/">D H C P Servers</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Facebook_Voyager_Optical_Interfaces/">Facebook Voyager Optical Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/Prescriptive_Topology_Manager_-_PTM/">Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/Interface_Configuration_and_Management/">Interface Configuration and Management</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer1-switch-ports/interface_configuration_and_management/switch_port_attributes/Switch_Port_Attributes/">Switch Port Attributes</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer2/">
    Layer2</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Prescriptive_Topology_Manager_-_PTM/">Copy of Prescriptive Topology Manager P T M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Copy_of_Spanning_Tree_and_Rapid_Spanning_Tree/">Copy of Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Ethernet_Bridging_-_VLANs/">Ethernet Bridging v L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/IGMP_and_MLD_Snooping/">I G M P and M L D Snooping</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/LACP_Bypass/">L a C P Bypass</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Link_Layer_Discovery_Protocol/">Link Layer Discovery Protocol</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Multi-Chassis_Link_Aggregation_-_MLAG/">Multi Chassis Link Aggregation M L a G</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Spanning_Tree_and_Rapid_Spanning_Tree/">Spanning Tree and Rapid Spanning Tree</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/Virtual_Router_Redundancy_-_VRR/">Virtual Router Redundancy v R R</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/bonding_link_aggregation/Bonding_-_Link_Aggregation/">Bonding Link Aggregation</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/Traditional_Bridge_Mode/">Traditional Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN-aware_Bridge_Mode/">V L a N Aware Bridge Mode</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/ethernet_bridging_vlans/VLAN_Tagging/">V L a N Tagging</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/link_layer_discovery_protocol/voice_vlan/Voice_VLAN/">Voice v L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer2/virtual_router_redundancy/ifplugd/ifplugd/">Ifplugd</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/layer3/">
    Layer3</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/layer3/Address_Resolution_Protocol_-_ARP/">Address Resolution Protocol a R P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Bidirectional_Forwarding_Detection_-_BFD/">Bidirectional Forwarding Detection B F D</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Border_Gateway_Protocol_-_BGP/">Border Gateway Protocol B G P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Configuring_FRRouting/">Configuring F R Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Equal_Cost_Multipath_Load_Sharing_-_Hardware_ECMP/">Equal Cost Multipath Load Sharing Hardware E C M P</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/FRRouting_Overview/">F R Routing Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/GRE_Tunneling/">G R E Tunneling</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Introduction_to_Routing_Protocols/">Introduction to Routing Protocols</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Management_VRF/">Management v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Network_Topology/">Network Topology</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_-_OSPF/">Open Shortest Path First O S P F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Open_Shortest_Path_First_v3_-_OSPFv3/">Open Shortest Path First V3 O S P Fv3</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Policy-based_Routing/" class="active">Policy Based Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Protocol_Independent_Multicast_-_PIM/">Protocol Independent Multicast P I M</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Redistribute_Neighbor/">Redistribute Neighbor</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Routing/">Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Segment_Routing/">Segment Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/Virtual_Routing_and_Forwarding_-_VRF/">Virtual Routing and Forwarding v R F</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/configuring_frrouting/comparing_nclu_and_vtysh_commands/Comparing_NCLU_and_vtysh_Commands/">Comparing N C L U and Vtysh Commands</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/layer3/frrouting_overview/Upgrading_from_Quagga_to_FRRouting/">Upgrading From Quagga to F R Routing</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/monitoring-troubleshooting/">
    Monitoring Troubleshooting</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/ASIC_Monitoring/">A S I C Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/FRRouting_Log_Message_Reference/">F R Routing Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Best_Practices/">Monitoring Best Practices</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_System_Hardware/">Monitoring System Hardware</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Monitoring_Virtual_Device_Counters/">Monitoring Virtual Device Counters</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Network_Troubleshooting/">Network Troubleshooting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Resource_Diagnostics_Using_cl-resource-query/">Resource Diagnostics Using Cl Resource Query</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Simple_Network_Management_Protocol_SNMP_Monitoring/">Simple Network Management Protocol S N M P Monitoring</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Single_User_Mode_-_Boot_Recovery/">Single User Mode Boot Recovery</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Troubleshooting_Network_Interfaces/">Troubleshooting Network Interfaces</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/Understanding_the_cl-support_Output_File/">Understanding the Cl Support Output File</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/monitoring_system_hardware/network_switch_port_led_and_stats_led/Network_Switch_Port_LED_and_Status_LED_Guidelines/">Network Switch Port L E D and Status L E D Guidelines</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/monitoring_system_statistics/Monitoring_System_Statistics_and_Network_Traffic_with_sFlow/">Monitoring System Statistics and Network Traffic With S Flow</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/network_troubleshooting/using_nclu_to_troubleshoot/Using_NCLU_to_Troubleshoot_Your_Network_Configuration/">Using N C L U to Troubleshoot Your Network Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/simple_network_management/using_nutanix_prisim_as_monitoring_tool/Using_Nutanix_Prism_as_a_Monitoring_Tool/">Using Nutanix Prism as a Monitoring Tool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/switchd_Log_Message_Reference/">Switchd Log Message Reference</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/troubleshooting_network_interfaces/monitoring_interfaces_and_transcievers_using_ethtool/Monitoring_Interfaces_and_Transceivers_Using_ethtool/">Monitoring Interfaces and Transceivers Using Ethtool</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_log_files/Troubleshooting_Log_Files/">Troubleshooting Log Files</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/monitoring-troubleshooting/understanding_cl-support_output_file/troubleshooting_the_etc_directory/Troubleshooting_the_etc_Directory/">Troubleshooting the Etc Directory</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-solutions/">
    Network Solutions</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Anycast_Design_Guide/">Anycast Design Guide</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Hyperconverged_Solution_with_Nutanix/">Cumulus Hyperconverged Solution With Nutanix</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Cumulus_Networks_Services_Demos/">Cumulus Networks Services Demos</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Data_Center_Host_to_ToR_Architecture/">Data Center Host to to R Architecture</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/Docker_on_Cumulus_Linux/">Docker on Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/OpenStack_Neutron_ML2_and_Cumulus_Linux/">Open Stack Neutron M L2 and Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-solutions/RDMA_over_Converged_Ethernet_-_RoCE/">R D M a Over Converged Ethernet Ro C E</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/network-visualization/">
    Network Visualization</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Eng_Update_of_VXLAN_Hyperloop/">Eng Update of v X L a N Hyperloop</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Ethernet_Virtual_Private_Network_-_EVPN/">Ethernet Virtual Private Network E v P N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Hybrid_Cloud_Connectivity_with_QinQ_and_VXLANs/">Hybrid Cloud Connectivity With Qin Q and v X L a Ns</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/LNV_Full_Example/">L N v Full Example</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Lightweight_Network_Virtualization_Overview/">Lightweight Network Virtualization Overview</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Static_VXLAN_Configurations/">Static v X L a N Configurations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Routing/">V X L a N Routing</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Scale/">V X L a N Scale</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/VXLAN_Tunnel_DSCP_Operations__DRAFT/">V X L a N Tunnel D S C P Operations — D R a F T</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/Virtualization_Integrations/">Virtualization Integrations</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_mac_bindings/Static_MAC_Bindings_with_VXLAN/">Static M a C Bindings With v X L a N</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/static_vxlan_configurations/static_vxlan_tunnels/Static_VXLAN_Tunnels/">Static v X L a N Tunnels</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_hardware_vteps_vmware_nsx-mh/Integrating_Hardware_VTEPs_with_VMware_NSX-MH/">Integrating Hardware v T E Ps With v Mware N S X M H</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_midonet_openstack/Integrating_Hardware_VTEPs_with_Midokura_MidoNet_and_OpenStack/">Integrating Hardware v T E Ps With Midokura Mido Net and Open Stack</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/integrating_vteps_vmware_nsx-v/Integrating_Hardware_VTEPs_with_VMware_NSX-V/">Integrating Hardware v T E Ps With v Mware N S X V</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/network-visualization/virtualization_integrations/ovsdb_server_high_availability/OVSDB_Server_High_Availability/">O v S D B Server High Availability</a>
    </li>
    
  </ul>

    </li>
    
    <li><a href="/Cumulus-Linux/system-config/">
    System Config</a> 
  <ul>
    

    
    <li>
      <a href="/Cumulus-Linux/system-config/Authentication_Authorization_and_Accounting/">Authentication Authorization and Accounting</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_a_Global_Proxy/">Configuring a Global Proxy</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Configuring_switchd/">Configuring Switchd</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Copy_of_Netfilter_-_ACLs/">Copy of Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/HTTP_API/">H T T P a P I</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Netfilter_-_ACLs/">Netfilter a C Ls</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Network_Command_Line_Utility_-_NCLU/">Network Command Line Utility N C L U</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Power_over_Ethernet_-_PoE/">Power Over Ethernet Po E</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Services_and_Daemons_in_Cumulus_Linux/">Services and Daemons in Cumulus Linux</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/Setting_Date_and_Time/">Setting Date and Time</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/LDAP_Authentication_and_Authorization/">L D a P Authentication and Authorization</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/RADIUS_AAA/">R a D I U S a a A</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/SSH_for_Remote_Access/">S S H for Remote Access</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/TACACS_Plus/">T a C a C S Plus</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/User_Accounts/">User Accounts</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/authentication_authorization_accounting/Using_sudo_to_Delegate_Privileges/">Using Sudo to Delegate Privileges</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Default_Cumulus_Linux_ACL_Configuration/">Default Cumulus Linux a C L Configuration</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/system-config/netfilter_acls/default_cumulus_linux_acl_config/Filtering_Learned_MAC_Addresses/">Filtering Learned M a C Addresses</a>
    </li>
    
  </ul>

    </li>
    

    
    <li>
      <a href="/Cumulus-Linux/whats-new/">What&#39;s New</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/cumulus-linux-index/Cumulus_Linux_Index/">Cumulus Linux Index</a>
    </li>
    
    <li>
      <a href="/Cumulus-Linux/quick-start/Quick_Start_Guide/">Quick Start Guide</a>
    </li>
    
  </ul>








</nav>

    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/svg/menu.svg" />
  </label>
  <strong>Policy Based Routing</strong>
</header>

      
<article class="markdown">

<h1 id="policy-based-routing">Policy-based Routing</h1>

<p>Typical routing systems and protocols forward traffic based on the
destination address in the packet, which is used to look up an entry in
a routing table. However, sometimes the traffic on your network requires
a more hands-on approach. You might need to forward a packet based on
the source address, the packet size, or other information in the packet
header.</p>

<p>Policy-based routing (PBR) lets you make routing decisions based on
filters that change the routing behavior of specific traffic so that you
can override the routing table and influence where the traffic goes. For
example, you can use PBR to help you reach the best bandwidth
utilization for business-critical applications, isolate traffic for
inspection or analysis, or manually load balance outbound traffic.</p>

<p>Policy-based routing is applied to incoming packets. All packets
received on a PBR-enabled interface pass through enhanced packet filters
that determine rules and specify where to forward the packets.</p>

<ul>
<li>You can create a <em>maximum</em> of 255 PBR match rules and 256 nexthop
groups (this is the ECMP limit).</li>
<li>You can apply only one PBR policy per input interface.</li>
<li>You can match on <em>source</em> and <em>destination</em> IP address only.</li>
<li>PBR is not supported for GRE or VXLAN tunneling.</li>
<li>PBR is not supported on ethernet interfaces.</li>
<li>A PBR rule cannot contain both IPv4 and IPv6 addresses.</li>
</ul>

<h2 id="contents">Contents</h2>

<p><img src="images/icons/grey_arrow_down.png" alt="" />{.expand-control-image}This topic
describes &hellip;</p>

<ul>
<li><a href="#Policy-basedRouting-ConfigurePBR">Configure PBR</a></li>
<li><a href="#Policy-basedRouting-ConfigurationExample">Configuration Example</a></li>
<li><a href="#Policy-basedRouting-ReviewYourConfiguration">Review Your
Configuration</a></li>
<li><a href="#Policy-basedRouting-DeletePBRRulesandPolicies">Delete PBR Rules and
Policies</a></li>
</ul>

<h2 id="configure-pbr">Configure PBR</h2>

<p>A PBR policy contains one or more policy maps. Each policy map:</p>

<ul>
<li>Is identified with a unique map name and sequence number. The
sequence number is used to determine the relative order of the map
within the policy.</li>
<li>Contains a match source IP rule or a match destination IP rule, and
a set rule. 

<ul>
<li>To match on a source and destination address, a policy map can
contain both match source and match destination IP rules. </li>
<li>A set rule determines the PBR nexthop for the policy. The set
rule can contain a single nexthop IP address or it can contain a
nexthop group. A nexthop group has more than one nexthop IP
address so that you can use multiple interfaces to forward
traffic. To use ECMP, you configure a nexthop group.</li>
</ul></li>
</ul>

<p>To use PBR in Cumulus linux, you define a PBR policy and apply it to the
ingress interface (the interface must already have an IP address
assigned). Traffic is matched against the match rules in sequential
order and forwarded according to the set rule in the first match.
Traffic that does not match any rule is passed onto the normal
destination based routing mechanism.</p>

<p>For Tomahawk and Tomahawk+ platforms, you must configure the switch to
operate in non-atomic mode, which offers better scaling as all TCAM
resources are used to actively impact traffic. Add the line
<code>acl.non_atomic_update_mode = TRUE</code> to the <code>/etc/cumulus/switchd.conf</code>
file. For more information, see <a href="Netfilter---ACLs_8362563.html#Netfilter-ACLs-nonatomic">Nonatomic Update Mode vs. Atomic Update
Mode</a>.</p>

<p>To configure a PBR policy:</p>

<ol>
<li><p>Configure the policy map with the
<code>net add pbr-map &lt;name&gt; seq &lt;1-700&gt; match dst-ip|src-ip &lt;ip/prefixlen&gt;</code>
command.<br />
The example commands below configure a policy map called <code>map1</code> with
sequence number 1, that matches on destination address 10.1.2.0/24
and source address 10.1.4.<sup>1</sup>&frasl;<sub>24</sub>.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add pbr-map map1 seq 1 match dst-ip 10.1.2.0/24
cumulus@switch:~$ net add pbr-map map1 seq 1 match src-ip 10.1.4.1/24</code></pre></div>
<p>If the IP address in the rule is <code>0.0.0.0/0 or ::/0</code>, any IP address
is a match. You cannot mix IPv4 and IPv6 addresses in a rule.</p></li>

<li><p>Either apply a *nexthop* or a <em>nexthop</em> group to the policy map:</p>

<ul>
<li><p>To apply a nexthop to the policy map, use
the <code>net add pbr-map &lt;name&gt; seq &lt;1-700&gt; set nexthop &lt;ipaddress&gt; [&lt;interface&gt;] [nexthop-vrf &lt;vrfname&gt;] </code>command.<br />
The output interface and VRF are optional, however, you <em>must</em>
specify the VRF you want to use for resolution if the nexthop
is *not* in the default VRF.<br />
The example command below applies the nexthop 192.168.0.31 on
the output interface swp2 and VRF <code>rocket</code> to the <code>map1</code> policy
map:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add pbr-map map1 seq 1 set nexthop 192.168.0.31 swp2 nexthop-vrf rocket</code></pre></div></li>

<li><p>To apply a nexthop group (for ECMP) to the policy map, first
create the nexthop group, then apply the group to the policy
map:</p>

<ol>
<li><p>Create the nexthop group with the
<code>net add nexthop-group &lt;groupname&gt; nexthop &lt;ipaddress&gt; [&lt;interface&gt;] [nexthop-vrf &lt;vrfname&gt;]</code>
command.<br />
The output interface and VRF are optional. However, you must
specify the VRF if the nexthop is not in the default VRF.<br />
The example commands below create a nexthop group called
<code>group1</code> that contains the nexthop 192.168.0.21 on output
interface swp1 and VRF <code>rocket</code>, and the nexthop
192.168.0.22. </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add nexthop-group group1 nexthop 192.168.0.21 swp1 nexthop-vrf rocket
cumulus@switch:~$ net add nexthop-group group1 nexthop 192.168.0.22</code></pre></div></li>

<li><p>Apply the nexthop group to the policy map with the
<code>net add pbr-map &lt;name&gt; seq &lt;1-700&gt; set nexthop-group &lt;groupname&gt;</code>
command.<br />
The example command below applies the nexthop
group <code>group1</code> to the <code>map1</code> policy map:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add pbr-map map1 seq 1 set nexthop-group group1</code></pre></div></li>
</ol></li>
</ul></li>

<li><p> Assign the PBR policy to an ingress interface with the
<code>net add interface &lt;interface&gt; pbr-policy &lt;name&gt;</code> command.<br />
The example command below assigns the PBR policy <code>map1</code> to interface
swp51: </p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add interface swp51 pbr-policy map1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>You can only set one policy per interface.</p></li>
</ol>

<h2 id="configuration-example">Configuration Example</h2>

<p>In the following example, the PBR-enabled switch has a PBR policy to
route all traffic from the Internet to a server that performs anti-DDOS.
The traffic returns to the PBR-enabled switch after being cleaned and is
then passed onto the regular destination based routing mechanism.</p>

<p><img src="attachments/8362974/8362973.png" alt="" />{.image-center}</p>

<p> </p>

<p>The configuration for the example above is:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net add pbr-map map1 seq 1 match src-ip 0.0.0.0/0
cumulus@switch:~$ net add pbr-map map1 seq 1 set nexthop 192.168.0.32
cumulus@switch:~$ net add interface swp51 pbr-policy map1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>These commands produce the following snippet in the <code>/etc/frr/frr.conf</code>
file.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">interface swp51
pbr-policy map1
pbr-map map1 seq 1
match src-ip 0.0.0.0/0
set nexthop 192.168.0.32</code></pre></div>
<h2 id="review-your-configuration">Review Your Configuration</h2>

<p>Use the following commands to see the configured PBR policies.</p>

<p>To see the policies applied to all interfaces on the switch, use the
<code>net show pbr interface</code> command. For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show pbr interface
swp55s3(67) with pbr-policy map1</code></pre></div>
<p>To see the policies applied to a specific interface on the switch, add
the interface name at the end of the command; for example,
<code>net show pbr interface swp51</code>.</p>

<p>To see information about all policies, including mapped table and rule
numbers, use the <code>net show pbr map</code> command. If the rule is not set, you
see a reason why.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show pbr map
pbr-map map1 valid: 1
Seq: 700 rule: 999 Installed: 1(1) Reason: Valid
SRC Match: 10.0.0.1/32
nexthop 192.168.0.32
Installed: 1(1) Tableid: 10003
Seq: 701 rule: 1000 Installed: 1(2) Reason: Valid
SRC Match: 90.70.0.1/32
nexthop 192.168.0.32
Installed: 1(1) Tableid: 10004</code></pre></div>
<p>To see information about a specific policy, what it matches, and with
which interface it is associated, add the map name at the end of the
command; for example, <code>net show pbr map map1</code>.</p>

<p>To see information about all nexthop groups, run the
<code>net show pbr nexthop-group</code> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net show pbr nexthop-group
Nexthop-Group: map1701 Table: 10004 Valid: 1 Installed: 1
Valid: 1 nexthop 10.1.1.2
Nexthop-Group: map1700 Table: 10003 Valid: 1 Installed: 1
Valid: 1 nexthop 10.1.1.2
Nexthop-Group: group1 Table: 10000 Valid: 1 Installed: 1
Valid: 1 nexthop 192.168.10.0 bond1
Valid: 1 nexthop 192.168.10.2
Valid: 1 nexthop 192.168.10.3 vlan70
Nexthop-Group: group2 Table: 10001 Valid: 1 Installed: 1
Valid: 1 nexthop 192.168.8.1
Valid: 1 nexthop 192.168.8.2
Valid: 1 nexthop 192.168.8.3</code></pre></div>
<p>To see information about a specific nexthop group, add the group name at
the end of the command; for example,
<code>net show pbr nexthop-group group1</code>.</p>

<p>A new Linux routing table ID is used for each nexthop and nexthop group.</p>

<h2 id="delete-pbr-rules-and-policies">Delete PBR Rules and Policies</h2>

<p>You can delete a PBR rule, a nexthop group, or a policy with the
<code>net del</code> command.<br />
The following commands provide examples.</p>

<p>Use caution when deleting PBR rules and nexthop groups, as you might
create an incorrect configuration for the PBR policy.</p>

<p>The following example shows how to delete a PBR rule:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del pbr-map map1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>The following example shows how to delete a PBR rule match:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del pbr-map map1 seq 1 match dst-ip 10.1.2.0/24
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>The following example shows how to delete a nexthop group:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del nexthop-group group1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>The following example shows how to delete a nexthop from a group:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del nexthop-group group1 nexthop 192.168.0.32 swp1 nexthop-vrf rocket
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<p>The following example shows how to delete a PBR policy so that the PBR
interface is no longer receiving PBR traffic:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cumulus@switch:~$ net del interface swp3 pbr-policy map1
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit</code></pre></div>
<h2 id="attachments">Attachments:</h2>

<p><img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;}
<a href="attachments/8362974/8362975.png">PBR_example2.png</a> (image/png)<br />
<img src="images/icons/bullet_blue.gif" alt="" />{width=&ldquo;8&rdquo; height=&ldquo;8&rdquo;}
<a href="attachments/8362974/8362973.png">PBR.png</a> (image/png)</p>
</article>

      
<div class="align-center book-git-footer justify-between">
  
  <div>
    <a href="https://github.com/cawleyflower/testDocs/commit/0f1fa77f244c4b4642688df1f5e961e88daa6e08" title='Last modified March 4, 2019 16:11 EST by Cawleyflower' target="_blank" rel="noopener">
      <img src="/svg/code-merge.svg" /> Last Modified Mar 4, 2019
    </a>
  </div>
  
  
</div>


    </div>

    
  
  
  <aside class="book-toc fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#policy-based-routing">Policy-based Routing</a>
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#configure-pbr">Configure PBR</a></li>
<li><a href="#configuration-example">Configuration Example</a></li>
<li><a href="#review-your-configuration">Review Your Configuration</a></li>
<li><a href="#delete-pbr-rules-and-policies">Delete PBR Rules and Policies</a></li>
<li><a href="#attachments">Attachments:</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
